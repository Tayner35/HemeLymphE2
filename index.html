<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Heme-Lymph E2 Knowledge Base</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fraunces:wght@600;700;800&family=Space+Grotesk:wght@400;500;600;700&display=swap');

        :root {
            --primary: #0f766e;
            --primary-dark: #115e59;
            --secondary: #b45309;
            --bg-body: #f5f1e8;
            --bg-card: #ffffff;
            --bg-sidebar: #0b141f;
            --bg-glow-1: rgba(13, 148, 136, 0.22);
            --bg-glow-2: rgba(245, 158, 11, 0.2);
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --text-sidebar: #cbd5e1;
            --border: #e5e7eb;
            --success: #059669;
            --warning: #d97706;
            --danger: #dc2626;
            --shadow: 0 18px 45px -30px rgba(15, 23, 42, 0.55);
            --radius: 0.85rem;
        }

        [data-theme="dark"] {
            --primary: #2dd4bf;
            --primary-dark: #14b8a6;
            --secondary: #f59e0b;
            --bg-body: #0b1220;
            --bg-card: #111827;
            --bg-sidebar: #050b14;
            --bg-glow-1: rgba(45, 212, 191, 0.16);
            --bg-glow-2: rgba(245, 158, 11, 0.12);
            --text-main: #e5e7eb;
            --text-muted: #94a3b8;
            --border: #1f2937;
            --shadow: 0 18px 45px -30px rgba(0, 0, 0, 0.85);
        }

        * { box-sizing: border-box; }
        body {
            font-family: "Space Grotesk", "IBM Plex Sans", sans-serif;
            background:
                radial-gradient(1100px 700px at 85% -10%, var(--bg-glow-1), transparent 60%),
                radial-gradient(900px 600px at -10% 10%, var(--bg-glow-2), transparent 55%),
                var(--bg-body);
            color: var(--text-main);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        h1, h2, h3, .logo { font-family: "Fraunces", serif; letter-spacing: 0.01em; }

        /* Sidebar */
        .sidebar { width: 260px; background: linear-gradient(180deg, rgba(11, 20, 31, 0.98), rgba(9, 15, 25, 0.98)); color: var(--text-sidebar); display: flex; flex-direction: column; padding: 1.5rem 1rem; flex-shrink: 0; overflow-y: auto; }
        .logo { font-size: 1.25rem; font-weight: 800; color: #fff; margin-bottom: 2rem; display: flex; align-items: center; gap: 0.5rem; }
        .nav-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; color: var(--text-sidebar); text-decoration: none; border-radius: 0.6rem; margin-bottom: 0.25rem; cursor: pointer; transition: background-color 0.2s ease, color 0.2s ease; }
        .nav-item:hover, .nav-item.active { background: rgba(45, 212, 191, 0.16); color: #fff; }
        .nav-item svg { width: 20px; height: 20px; }
        .stats-mini { margin-top: auto; background: rgba(255,255,255,0.05); padding: 1rem; border-radius: var(--radius); font-size: 0.85rem; }
        .progress-bar { height: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; margin-top: 0.5rem; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--success), var(--primary)); width: 0%; transition: width 0.5s ease; }

        /* Main Content */
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        
        /* Top Header */
        header { height: 64px; border-bottom: 1px solid var(--border); background: var(--bg-card); display: flex; align-items: center; justify-content: space-between; padding: 0 2rem; flex-shrink: 0; box-shadow: var(--shadow); }
        .search-container { position: relative; width: 400px; }
        .search-input { width: 100%; padding: 0.6rem 1rem 0.6rem 2.5rem; border-radius: 2rem; border: 1px solid var(--border); background: var(--bg-body); color: var(--text-main); outline: none; }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); width: 16px; height: 16px; }
        .theme-toggle { background: none; border: none; cursor: pointer; color: var(--text-muted); padding: 0.5rem; border-radius: 50%; }
        .theme-toggle:hover { background: var(--bg-body); color: var(--text-main); }

        /* Scroll Area */
        .content-scroll { flex: 1; overflow-y: auto; padding: 2rem; scroll-behavior: smooth; }
        
        /* Dashboard Grid */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .card { background: var(--bg-card); border-radius: var(--radius); border: 1px solid var(--border); padding: 1.5rem; box-shadow: var(--shadow); display: flex; flex-direction: column; animation: fadeUp 0.5s ease both; animation-delay: var(--delay, 0ms); }
        .card h3 { margin: 0 0 1rem 0; font-size: 1.1rem; color: var(--text-main); display: flex; justify-content: space-between; align-items: center; }
        
        /* Disease Index */
        .disease-list { list-style: none; padding: 0; margin: 0; }
        .disease-item { border-bottom: 1px solid var(--border); padding: 1rem 0; cursor: pointer; }
        .disease-item:last-child { border-bottom: none; }
        .disease-header { display: flex; justify-content: space-between; align-items: baseline; }
        .disease-name { font-weight: 600; font-size: 1.1rem; color: var(--primary); }
        .disease-tags { display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap; }
        .tag { font-size: 0.75rem; padding: 0.2rem 0.6rem; border-radius: 1rem; background: var(--bg-body); color: var(--text-muted); border: 1px solid var(--border); }
        .tag.yield { background: rgba(245, 158, 11, 0.16); color: #9a3412; border-color: rgba(245, 158, 11, 0.35); font-weight: 600; }
        .disease-detail { display: none; margin-top: 1rem; background: var(--bg-body); padding: 1rem; border-radius: 0.5rem; }
        .disease-detail.open { display: block; animation: slideDown 0.3s ease; }
        .detail-section { margin-bottom: 1rem; }
        .detail-section h4 { font-size: 0.85rem; text-transform: uppercase; color: var(--text-muted); margin: 0 0 0.25rem 0; letter-spacing: 0.05em; }

        /* Quiz UI */
        .quiz-container { max-width: 800px; margin: 0 auto; }
        .question-card { background: var(--bg-card); padding: 2rem; border-radius: var(--radius); box-shadow: var(--shadow); }
        .options-grid { display: grid; gap: 1rem; margin-top: 1.5rem; }
        .option-btn { padding: 1rem; text-align: left; background: var(--bg-body); border: 2px solid var(--border); border-radius: 0.5rem; cursor: pointer; font-size: 1rem; color: var(--text-main); }
        .option-btn:hover { border-color: var(--primary); }
        .option-btn.selected { border-color: var(--primary); background: rgba(13, 148, 136, 0.12); }
        .option-btn.correct { border-color: var(--success); background: #dcfce7; color: #064e3b; }
        .option-btn.incorrect { border-color: var(--danger); background: #fee2e2; color: #7f1d1d; }
        .explanation { margin-top: 2rem; padding: 1rem; background: rgba(5, 150, 105, 0.08); border: 1px solid rgba(5, 150, 105, 0.28); border-radius: 0.5rem; color: #0f5132; display: none; }
        .explanation.show { display: block; }

        /* Flashcards */
        .flashcard-container { perspective: 1000px; width: 100%; max-width: 600px; margin: 2rem auto; height: 350px; cursor: pointer; }
        .flashcard { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s; transform-style: preserve-3d; border-radius: 1rem; box-shadow: var(--shadow); }
        .flashcard.flipped { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem; background: var(--bg-card); border-radius: 1rem; border: 1px solid var(--border); }
        .card-back { transform: rotateY(180deg); background: var(--bg-body); }
        .card-content { font-size: 1.25rem; line-height: 1.6; }
        .srs-buttons { display: flex; gap: 1rem; justify-content: center; margin-top: 2rem; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .flipped .srs-buttons { opacity: 1; pointer-events: auto; }
        .srs-btn { padding: 0.5rem 1.5rem; border-radius: 2rem; border: none; cursor: pointer; font-weight: 600; color: white; transform: translateY(0); transition: transform 0.1s; }
        .srs-btn:active { transform: translateY(2px); }
        .btn-hard { background: var(--danger); }
        .btn-good { background: var(--primary); }
        .btn-easy { background: var(--success); }

        /* Flowchart View */
        .content-scroll.flowchart-view { padding: 0; overflow: hidden; }
        .content-scroll.flowchart-view .fc-wrapper { height: 100%; }

        .fc-wrapper {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #64748b;
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            --bg-sidebar: #0f172a;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border: #404c5c;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            display: flex;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #5a6169;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: var(--text-main);
        }

        body[data-theme="dark"] .fc-wrapper {
            --primary: #3b82f6;
            --primary-dark: #60a5fa;
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #334155;
        }

        /* Flowchart Layout */
        .fc-sidebar {
            width: 280px;
            background: var(--bg-card);
            border-right: 1px solid var(--border);
            padding: 1.5rem;
            overflow-y: auto;
            z-index: 10;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }

        .fc-sidebar h2 { margin-top: 0; font-size: 1.25rem; color: var(--primary); margin-bottom: 0.5rem; }
        .fc-instructions { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 1.5rem; line-height: 1.5; }

        .fc-draggable {
            background: var(--bg-body);
            padding: 1rem;
            margin-bottom: 0.75rem;
            border: 2px solid var(--border);
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.2s;
            color: var(--text-main);
            user-select: none;
        }

        .fc-draggable:hover {
            transform: translateX(5px);
            border-color: var(--primary);
            box-shadow: var(--shadow);
        }

        .fc-draggable.selected {
            border-color: var(--primary);
            background: #eff6ff;
            box-shadow: 0 0 0 2px var(--primary-dark);
            transform: translateX(5px);
        }

        .fc-draggable.matched {
            background: var(--success);
            color: white;
            border-color: var(--success);
            cursor: default;
            pointer-events: none;
            text-decoration: line-through;
            opacity: 0.6;
            box-shadow: none;
            transform: none;
        }

        .fc-canvas-container {
            flex: 1;
            position: relative;
            cursor: grab;
            background-color: #f1f5f9;
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 20px 20px;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
        }

        .fc-canvas-container:active { cursor: grabbing; }

        .fc-controls {
            position: absolute;
            bottom: 30px;
            right: 30px;
            display: flex;
            gap: 0.75rem;
            z-index: 100;
        }

        .fc-btn {
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            box-shadow: var(--shadow);
            color: var(--text-main);
            font-weight: 600;
        }

        .fc-btn:hover { background: var(--bg-body); transform: translateY(-1px); }

        /* SVG Styles */
        .node-group { transition: all 0.2s; cursor: pointer; }
        .node-rect {
            fill: var(--bg-card);
            stroke: var(--primary);
            stroke-width: 2px;
            rx: 8;
            filter: drop-shadow(0px 4px 4px rgba(0,0,0,0.1));
            transition: all 0.3s;
        }

        .node-rect.slot {
            stroke: var(--text-muted);
            stroke-dasharray: 6,4;
            fill: rgba(255,255,255,0.8);
        }

        .node-rect.slot:hover {
            stroke: var(--primary);
            fill: rgba(59, 130, 246, 0.1);
            stroke-width: 3px;
        }

        .node-rect.correct {
            fill: #dcfce7;
            stroke: #16a34a;
            stroke-dasharray: none;
            stroke-width: 2px;
            cursor: help;
        }

        /* Wrong Answer Animation */
        .node-rect.wrong {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
            stroke: var(--danger);
            fill: #fee2e2;
        }

        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        .node-text {
            font-size: 14px;
            fill: var(--text-main);
            font-family: sans-serif;
            pointer-events: none;
            text-anchor: middle;
            dominant-baseline: middle;
            font-weight: 500;
        }

        .node-info-indicator {
            font-size: 11px;
            fill: var(--primary-dark);
            font-family: sans-serif;
            pointer-events: none;
            text-anchor: middle;
            font-weight: 700;
        }

        .node-clue {
            font-size: 11px;
            fill: var(--text-muted);
            font-family: sans-serif;
            pointer-events: none;
            text-anchor: middle;
            font-style: italic;
        }

        .link { fill: none; stroke: #94a3b8; stroke-width: 2px; }

        /* Modal Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000;
            display: none; align-items: center; justify-content: center;
        }
        .modal-overlay.open { display: flex; }

        .modal-content {
            background: var(--bg-card); width: 90%; max-width: 600px;
            max-height: 85vh; overflow-y: auto;
            border-radius: 0.75rem; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            padding: 2rem; position: relative;
        }
        .modal-close {
            position: absolute; top: 1rem; right: 1rem;
            background: none; border: none; font-size: 1.5rem;
            cursor: pointer; color: var(--text-muted);
        }
        .info-title { font-size: 1.5rem; margin-top: 0; color: var(--primary); border-bottom: 2px solid var(--border); padding-bottom: 0.5rem; }
        .info-section { margin-top: 1rem; }
        .info-label { font-weight: 700; color: var(--text-muted); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em; display: block; margin-bottom: 0.25rem; }
        .info-text { margin: 0; line-height: 1.6; }

        /* Flowchart Mobile */
        @media (max-width: 768px) {
            .fc-wrapper { flex-direction: column; }
            .fc-sidebar {
                width: 100%;
                height: 180px;
                order: 2;
                border-right: none;
                border-top: 1px solid var(--border);
                padding: 1rem;
            }
            .fc-sidebar h2 { font-size: 1rem; margin-bottom: 0.25rem; }
            .fc-instructions { margin-bottom: 0.5rem; font-size: 0.75rem; }
            .fc-sidebar > div {
                display: flex;
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            .fc-draggable {
                width: auto;
                margin: 0;
                font-size: 0.8rem;
                padding: 0.5rem 0.75rem;
            }
            .fc-canvas-container { order: 1; height: 100%; }
        }

        /* Utilities */
        .btn { padding: 0.5rem 1rem; border-radius: 0.5rem; border: 1px solid var(--border); background: var(--bg-card); color: var(--text-main); cursor: pointer; font-size: 0.9rem; font-weight: 500; }
        .btn-primary { background: var(--primary); color: white; border-color: var(--primary); }
        .btn-primary:hover { background: var(--primary-dark); }
        .hidden { display: none !important; }
        
        /* Mobile */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            .sidebar { width: 100%; height: auto; flex-direction: row; overflow-x: auto; padding: 0.5rem; order: 2; border-top: 1px solid var(--border); border-right: none; }
            .logo { display: none; }
            .nav-item { flex-direction: column; gap: 0.25rem; font-size: 0.7rem; padding: 0.5rem; }
            .nav-item svg { width: 24px; height: 24px; }
            .nav-text { display: block; }
            .stats-mini { display: none; }
            .main-content { order: 1; }
            header { padding: 0 1rem; }
            .search-container { width: 100%; max-width: 300px; }
        }

        .page-enter { animation: pageFade 0.35s ease both; }

        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pageFade { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        @media (prefers-reduced-motion: reduce) {
            * { animation-duration: 0.01ms !important; animation-iteration-count: 1 !important; transition-duration: 0.01ms !important; scroll-behavior: auto !important; }
        }
    </style>
</head>
<body>

    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="logo">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
            </svg>
            Heme-Lymph E2
        </div>
        <a class="nav-item active" onclick="router.navigate('home')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
            <span class="nav-text">Dashboard</span>
        </a>
        <a class="nav-item" onclick="router.navigate('diseases')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
            <span class="nav-text">Diseases</span>
        </a>
        <a class="nav-item" onclick="router.navigate('flashcards')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>
            <span class="nav-text">Flashcards</span>
        </a>
        <a class="nav-item" onclick="router.navigate('quiz')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polygon points="10 8 16 12 10 16 10 8"></polygon></svg>
            <span class="nav-text">Quiz Mode</span>
        </a>
        <a class="nav-item" onclick="router.navigate('flowcharts')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
            <span class="nav-text">Flowcharts</span>
        </a>
        
        <div class="stats-mini">
            <div>Daily Goal</div>
            <div class="progress-bar"><div class="progress-fill" style="width: 0%" id="daily-progress"></div></div>
            <div style="margin-top:0.5rem; font-size:0.75rem; color: var(--text-muted)" id="cards-due">0 Cards Due</div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <header>
            <div class="search-container">
                <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                <input type="text" class="search-input" placeholder="Search diseases, drugs, findings..." id="global-search" aria-label="Search knowledge base">
            </div>
            <button class="theme-toggle" onclick="ui.toggleTheme()" aria-label="Toggle Dark Mode">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
            </button>
        </header>

        <div id="app-view" class="content-scroll">
            <!-- Dynamic Content Injected Here -->
        </div>
    </main>

    <script>
        /**
         * HEME-LYMPH EXAM 2 DATABASE
         * Extracted from user uploaded documents:
         * - Leukemia & Lymphoma Handouts/Slides
         * - Chemotherapy reviews
         * - High Yield Fact Sheets
         */
        const DB = {
            diseases: [
                {
                    id: "d01",
                    name: "Acute Myeloid Leukemia (AML)",
                    category: "Acute Leukemia",
                    tags: ["Myeloid", "Auer Rods", "Adults"],
                    pathophysiology: "Clonal proliferation of myeloid precursors (blasts) >20% in marrow. Blocks differentiation.",
                    symptoms: "Fatigue, bleeding (thrombocytopenia), infections (neutropenia), gum hypertrophy (M4/M5 subtypes).",
                    diagnosis: "BM Biopsy: >20% blasts. Auer rods (fused lysosomes, MPO+). Flow: CD13+, CD33+, MPO+.",
                    genetics: "t(15;17) in APML (PML-RARA). t(8;21) & inv(16) are Core Binding Factor (Good prognosis). FLT3 mut (Bad prognosis).",
                    treatment: "Induction (7+3: Cytarabine + Daunorubicin). APML: ATRA + Arsenic.",
                    pearls: "Medical Emergency: APML causes DIC. Look for t(15;17)."
                },
                {
                    id: "d02",
                    name: "Acute Lymphoblastic Leukemia (ALL)",
                    category: "Acute Leukemia",
                    tags: ["Lymphoid", "Children", "CNS"],
                    pathophysiology: "Malignant transformation of B or T cell progenitors.",
                    symptoms: "Bone pain (children), LAD, hepatosplenomegaly, CNS involvement, testicular mass.",
                    diagnosis: "TdT+ (marker of lymphoblasts). B-ALL: CD10, CD19, CD20. T-ALL: CD2-8, mediastinal mass.",
                    genetics: "t(12;21) (TEL-AML1) - Good prognosis (Kids). t(9;22) (Ph+) - Poor prognosis (Adults).",
                    treatment: "Complex chemo, CNS prophylaxis (intrathecal methotrexate).",
                    pearls: "Most common cancer in children. Down Syndrome increased risk."
                },
                {
                    id: "d03",
                    name: "Chronic Myeloid Leukemia (CML)",
                    category: "Chronic Leukemia",
                    tags: ["MPN", "Philadelphia Chromosome", "Basophilia"],
                    pathophysiology: "t(9;22) BCR-ABL fusion gene -> constitutively active Tyrosine Kinase.",
                    symptoms: "Splenomegaly (early satiety), fatigue, weight loss. Phases: Chronic -> Accelerated -> Blast Crisis.",
                    diagnosis: "Leukocytosis with Left Shift (all stages seen). Basophilia is key. Low LAP score.",
                    treatment: "Tyrosine Kinase Inhibitors (Imatinib, Dasatinib).",
                    pearls: "Distinguish from Leukemoid Reaction (Leukemoid has High LAP, toxic granulation, no basophilia)."
                },
                {
                    id: "d04",
                    name: "Chronic Lymphocytic Leukemia (CLL)",
                    category: "Chronic Leukemia",
                    tags: ["B-cell", "Elderly", "Smudge Cells"],
                    pathophysiology: "Monoclonal proliferation of incompetent B-cells.",
                    symptoms: "Often asymptomatic. LAD, HSM. Autoimmune hemolytic anemia (AIHA).",
                    diagnosis: "Lymphocytosis >5k. Smudge cells on smear. Flow: CD5+ (T-cell marker on B-cell) and CD23+.",
                    genetics: "del(13q) (Good), del(17p) (Bad - p53 loss).",
                    treatment: "Watch & wait. Ibrutinib (BTK inhibitor), Venetoclax (BCL-2 inhibitor).",
                    pearls: "Richter's Transformation: Rapid growth to DLBCL (5% cases)."
                },
                {
                    id: "d05",
                    name: "Hairy Cell Leukemia",
                    category: "Chronic Leukemia",
                    tags: ["B-cell", "Splenomegaly", "Dry Tap"],
                    pathophysiology: "Mature B-cell neoplasm with hair-like cytoplasmic projections.",
                    symptoms: "Massive splenomegaly, Pancytopenia (monocytopenia). NO LAD.",
                    diagnosis: "TRAP+, CD11c, CD25, CD103. 'Fried Egg' marrow. Dry tap on aspiration (fibrosis).",
                    genetics: "BRAF V600E mutation.",
                    treatment: "Cladribine (2-CDA) or Pentostatin.",
                    pearls: "Excellent prognosis. Sensitivity to chemotherapy is high."
                },
                {
                    id: "d06",
                    name: "Hodgkin Lymphoma",
                    category: "Lymphoma",
                    tags: ["Reed-Sternberg", "Bimodal", "Curable"],
                    pathophysiology: "B-cell origin but few tumor cells. Reed-Sternberg cells (Owl Eyes) release cytokines.",
                    symptoms: "Painless LAD (cervical/mediastinal), B-Symptoms (Fever, Night Sweats, Wt Loss). Alcohol-induced pain.",
                    diagnosis: "Excisonal Biopsy. RS Cells: CD15+, CD30+, CD20- (usually).",
                    subtypes: "Nodular Sclerosis (common, collagen bands), Mixed Cellularity (eosinophils), Lymphocyte Rich (best), Lymphocyte Depleted (worst/HIV).",
                    treatment: "ABVD Regimen (Adriamycin, Bleomycin, Vinblastine, Dacarbazine).",
                    pearls: "Contiguous spread (node to node). Nodular Lymphocyte Predominant HL is CD20+ ('Popcorn' cells)."
                },
                {
                    id: "d07",
                    name: "Burkitt Lymphoma",
                    category: "Non-Hodgkin Lymphoma",
                    tags: ["Aggressive", "Starry Sky", "EBV"],
                    pathophysiology: "t(8;14) c-myc translocation. Very rapid growth.",
                    diagnosis: "Starry Sky appearance (macrophages eating debris). Ki-67 index ~100%.",
                    subtypes: "Endemic (African, Jaw, EBV 100%), Sporadic (Abdominal, EBV 20%).",
                    treatment: "Intensive chemotherapy (R-CODOX-M/IVAC).",
                    pearls: "Tumor Lysis Syndrome risk is very high."
                },
                {
                    id: "d08",
                    name: "Follicular Lymphoma",
                    category: "Non-Hodgkin Lymphoma",
                    tags: ["Indolent", "t(14;18)", "BCL-2"],
                    pathophysiology: "t(14;18) moves BCL-2 (anti-apoptotic) to IgH locus. Cells don't die.",
                    symptoms: "Waxing/waning painless LAD.",
                    diagnosis: "Nodular growth pattern. CD10+, CD20+, BCL-2+.",
                    treatment: "Watch & Wait. Rituximab. R-CHOP if symptomatic.",
                    pearls: "Can transform to DLBCL."
                },
                {
                    id: "d09",
                    name: "Diffuse Large B-Cell Lymphoma (DLBCL)",
                    category: "Non-Hodgkin Lymphoma",
                    tags: ["Aggressive", "Most Common"],
                    pathophysiology: "Aggressive growth, destroys node architecture.",
                    symptoms: "Rapidly enlarging mass. B-symptoms.",
                    diagnosis: "Large B-cells. CD20+.",
                    treatment: "R-CHOP.",
                    pearls: "Most common NHL in adults."
                },
                {
                    id: "d10",
                    name: "Multiple Myeloma",
                    category: "Plasma Cell Dyscrasia",
                    tags: ["CRAB", "M-Spike"],
                    pathophysiology: "Clonal plasma cells in marrow producing monoclonal Ig (usually IgG or IgA).",
                    symptoms: "CRAB: HyperCalcemia, Renal failure, Anemia, Bone lytic lesions (back pain).",
                    diagnosis: ">10% Plasma cells. M-Spike (SPEP). Bence-Jones proteins (light chains) in urine.",
                    treatment: "Bortezomib (Proteasome inh) + Lenalidomide + Dexamethasone. Stem Cell Transplant.",
                    pearls: "Rouleaux formation on smear. AL Amyloidosis association."
                }
            ],
            flashcards: [
                { q: "Translocation associated with CML?", a: "t(9;22) (Philadelphia Chromosome) -> BCR-ABL" },
                { q: "Translocation associated with APML (M3)?", a: "t(15;17) -> PML-RARA" },
                { q: "Translocation associated with Burkitt Lymphoma?", a: "t(8;14) -> c-myc overexpression" },
                { q: "Translocation associated with Follicular Lymphoma?", a: "t(14;18) -> BCL-2 overexpression" },
                { q: "Translocation associated with Mantle Cell Lymphoma?", a: "t(11;14) -> Cyclin D1 overexpression" },
                { q: "Mechanism of Rituximab?", a: "Anti-CD20 Monoclonal Antibody (ADCC/Complement)" },
                { q: "Mechanism of Imatinib?", a: "Tyrosine Kinase Inhibitor (blocks ATP binding to BCR-ABL)" },
                { q: "Key side effect of Bleomycin?", a: "Pulmonary Fibrosis" },
                { q: "Key side effect of Doxorubicin (Adriamycin)?", a: "Cardiotoxicity (Dilated Cardiomyopathy)" },
                { q: "Key side effect of Vincristine?", a: "Peripheral Neuropathy (Microtubule inhibitor)" },
                { q: "Key side effect of Cyclophosphamide?", a: "Hemorrhagic Cystitis (use Mesna)" },
                { q: "Characteristic cell in Hodgkin Lymphoma?", a: "Reed-Sternberg Cell (Owl Eyes, CD15+, CD30+)" },
                { q: "Characteristic cell in Hairy Cell Leukemia?", a: "B-cell with cytoplasmic projections (TRAP+)" },
                { q: "Smudge cells are seen in?", a: "CLL (Chronic Lymphocytic Leukemia)" },
                { q: "Auer Rods are pathognomonic for?", a: "AML (especially APML)" },
                { q: "Treatment for APML?", a: "ATRA (All-trans retinoic acid) + Arsenic Trioxide" },
                { q: "What is Tumor Lysis Syndrome?", a: "Hyperkalemia, Hyperphosphatemia, Hyperuricemia, Hypocalcemia" },
                { q: "Markers for Hairy Cell Leukemia?", a: "CD11c, CD25, CD103, Annexin A1" },
                { q: "Mechanism of Methotrexate?", a: "Inhibits Dihydrofolate Reductase (DHFR)" }
            ],
            quiz: [
                {
                    id: 1,
                    question: "A 65-year-old male presents with fatigue and early satiety. CBC shows WBC 150,000 with a left shift, basophilia, and thrombocytosis. Genetic analysis reveals t(9;22). What is the targeted therapy?",
                    options: ["Rituximab", "Imatinib", "ATRA", "ABVD"],
                    correct: 1,
                    explanation: "This is CML (Philadelphia chromosome, t(9;22), Basophilia). Imatinib is a tyrosine kinase inhibitor against BCR-ABL."
                },
                {
                    id: 2,
                    question: "A young patient presents with a jaw mass. Biopsy shows a 'starry sky' appearance. Which translocation is likely present?",
                    options: ["t(14;18)", "t(9;22)", "t(8;14)", "t(15;17)"],
                    correct: 2,
                    explanation: "Burkitt Lymphoma presents with starry sky histology and t(8;14) involving c-myc."
                },
                {
                    id: 3,
                    question: "Which of the following is an expected finding in Multiple Myeloma?",
                    options: ["Hypocalcemia", "Lytic Bone Lesions", "Low Protein Gap", "Splenomegaly"],
                    correct: 1,
                    explanation: "CRAB: HyperCalcemia, Renal failure, Anemia, Bone lesions. Splenomegaly is rare in MM."
                },
                {
                    id: 4,
                    question: "A patient being treated for Hodgkin Lymphoma develops shortness of breath. Which drug is the likely culprit?",
                    options: ["Vinblastine", "Doxorubicin", "Bleomycin", "Dacarbazine"],
                    correct: 2,
                    explanation: "Bleomycin causes pulmonary fibrosis (B for Blow/Breath)."
                },
                {
                    id: 5,
                    question: "CD5+ and CD23+ B-cells are diagnostic for:",
                    options: ["CML", "CLL", "Mantle Cell Lymphoma", "Follicular Lymphoma"],
                    correct: 1,
                    explanation: "CLL is CD5+/CD23+. Mantle Cell is CD5+/CD23-."
                }
            ]
        };

        /**
         * APPLICATION LOGIC
         */
        
        // --- Store (LocalStorage Wrapper) ---
        const Store = {
            get: (key, def) => {
                const val = localStorage.getItem(`heme_${key}`);
                return val ? JSON.parse(val) : def;
            },
            set: (key, val) => {
                localStorage.setItem(`heme_${key}`, JSON.stringify(val));
            },
            init: () => {
                if(!Store.get('srs_data')) Store.set('srs_data', {});
                if(!Store.get('progress')) Store.set('progress', { daily: 0, total: 0 });
            }
        };

        // --- Router ---
        const router = {
            current: 'home',
            navigate: (view) => {
                router.current = view;
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                // Simple matching for sidebar highlighting
                document.querySelectorAll('.nav-item').forEach(el => {
                    if(el.getAttribute('onclick').includes(view)) el.classList.add('active');
                });
                renderApp();
            }
        };

        // --- UI Utils ---
        const ui = {
            toggleTheme: () => {
                const body = document.body;
                const isDark = body.getAttribute('data-theme') === 'dark';
                body.setAttribute('data-theme', isDark ? 'light' : 'dark');
                Store.set('theme', isDark ? 'light' : 'dark');
            },
            toggleDetails: (id) => {
                const el = document.getElementById(`detail-${id}`);
                el.classList.toggle('open');
            }
        };

        // --- Views Rendering ---

        function renderHome() {
            const progress = Store.get('progress', {daily:0});
            return `
                <div class="dashboard-grid">
                    <div class="card" style="--delay: 60ms">
                        <h3>Study Progress <span style="color:var(--primary)">${Math.min(progress.daily, 100)}%</span></h3>
                        <p style="color:var(--text-muted)">Daily Goal: Review 20 cards</p>
                        <div class="progress-bar" style="background:var(--bg-body)"><div class="progress-fill" style="width:${Math.min(progress.daily, 100)}%"></div></div>
                    </div>
                    <div class="card" style="--delay: 120ms">
                        <h3>High Yield Topics</h3>
                        <div style="display:flex; gap:0.5rem; flex-wrap:wrap">
                            <span class="tag yield">t(9;22) CML</span>
                            <span class="tag yield">t(15;17) APML</span>
                            <span class="tag yield">CD15/CD30 Hodgkin</span>
                            <span class="tag yield">CRAB Myeloma</span>
                        </div>
                    </div>
                </div>
                
                <h2 style="margin-bottom:1rem">Quick Actions</h2>
                <div class="dashboard-grid">
                    <div class="card" style="cursor:pointer; border-left: 4px solid var(--primary); --delay: 80ms" onclick="router.navigate('flashcards')">
                        <h3>Start Review</h3>
                        <p style="color:var(--text-muted)">You have cards due for review.</p>
                    </div>
                    <div class="card" style="cursor:pointer; border-left: 4px solid var(--success); --delay: 160ms" onclick="router.navigate('quiz')">
                        <h3>Take Quiz</h3>
                        <p style="color:var(--text-muted)">Test your knowledge on Leukemia & Lymphoma.</p>
                    </div>
                </div>
            `;
        }

        function renderDiseases() {
            const searchTerm = document.getElementById('global-search').value.toLowerCase();
            const filtered = DB.diseases.filter(d => 
                d.name.toLowerCase().includes(searchTerm) || 
                d.tags.some(t => t.toLowerCase().includes(searchTerm))
            );

            let html = `<h2 style="margin-bottom:1.5rem">Disease Index (${filtered.length})</h2><ul class="disease-list">`;
            
            filtered.forEach(d => {
                html += `
                    <li class="disease-item" onclick="ui.toggleDetails('${d.id}')">
                        <div class="disease-header">
                            <span class="disease-name">${d.name}</span>
                            <span style="font-size:0.8rem; color:var(--text-muted)">${d.category}</span>
                        </div>
                        <div class="disease-tags">
                            ${d.tags.map(t => `<span class="tag">${t}</span>`).join('')}
                        </div>
                        <div id="detail-${d.id}" class="disease-detail">
                            <div class="detail-section">
                                <h4>Pathophysiology</h4>
                                <p>${d.pathophysiology}</p>
                            </div>
                            <div class="detail-section">
                                <h4>Diagnosis</h4>
                                <p>${d.diagnosis}</p>
                                ${d.genetics ? `<p style="margin-top:0.5rem"><strong>Genetics:</strong> ${d.genetics}</p>` : ''}
                            </div>
                            <div class="detail-section">
                                <h4>Treatment</h4>
                                <p>${d.treatment}</p>
                            </div>
                            <div class="detail-section" style="background:#fffbeb; padding:0.75rem; border-left:3px solid var(--warning); border-radius:4px">
                                <h4 style="color:#92400e">Exam Pearl</h4>
                                <p style="color:#92400e; margin:0">${d.pearls}</p>
                            </div>
                        </div>
                    </li>
                `;
            });
            html += '</ul>';
            return html;
        }

        // --- Flashcard Logic ---
        let currentCardIndex = 0;
        let cardSession = [];

        function initFlashcards() {
            // Simple shuffle for now
            cardSession = [...DB.flashcards].sort(() => Math.random() - 0.5);
            currentCardIndex = 0;
        }

        function renderFlashcards() {
            if (cardSession.length === 0) initFlashcards();
            const card = cardSession[currentCardIndex];
            
            return `
                <div style="text-align:center; margin-bottom:1rem">Card ${currentCardIndex + 1} of ${cardSession.length}</div>
                <div class="flashcard-container" onclick="this.querySelector('.flashcard').classList.toggle('flipped')">
                    <div class="flashcard">
                        <div class="card-face card-front">
                            <span style="color:var(--text-muted); font-size:0.9rem; position:absolute; top:1rem">QUESTION</span>
                            <div class="card-content">${card.q}</div>
                            <span style="color:var(--primary); font-size:0.8rem; position:absolute; bottom:1rem">Click to Flip</span>
                        </div>
                        <div class="card-face card-back">
                            <span style="color:var(--text-muted); font-size:0.9rem; position:absolute; top:1rem">ANSWER</span>
                            <div class="card-content">${card.a}</div>
                            <div class="srs-buttons">
                                <button class="srs-btn btn-hard" onclick="event.stopPropagation(); nextCard(1)">Hard</button>
                                <button class="srs-btn btn-good" onclick="event.stopPropagation(); nextCard(3)">Good</button>
                                <button class="srs-btn btn-easy" onclick="event.stopPropagation(); nextCard(5)">Easy</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        window.nextCard = (score) => {
            // Update progress stats
            const p = Store.get('progress');
            p.daily += (score * 5); // Arbitrary points
            Store.set('progress', p);
            updateStats();

            currentCardIndex++;
            if(currentCardIndex >= cardSession.length) {
                alert("Session Complete!");
                currentCardIndex = 0;
                cardSession.sort(() => Math.random() - 0.5);
            }
            renderApp();
        };

        // --- Quiz Logic ---
        function renderQuiz() {
            return `
                <div class="quiz-container">
                    <h2 style="text-align:center; margin-bottom:2rem">Practice Quiz</h2>
                    ${DB.quiz.map((q, idx) => `
                        <div class="question-card" id="q-card-${idx}" style="margin-bottom:2rem">
                            <div style="font-weight:600; margin-bottom:1rem; color:var(--text-muted)">Question ${idx+1}</div>
                            <div style="font-size:1.1rem; margin-bottom:1rem">${q.question}</div>
                            <div class="options-grid">
                                ${q.options.map((opt, oIdx) => `
                                    <button class="option-btn" onclick="checkAnswer(${idx}, ${oIdx}, ${q.correct})">
                                        ${opt}
                                    </button>
                                `).join('')}
                            </div>
                            <div class="explanation" id="expl-${idx}">
                                <strong>Rationale:</strong> ${q.explanation}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        window.checkAnswer = (qIdx, selected, correct) => {
            const card = document.getElementById(`q-card-${qIdx}`);
            const opts = card.querySelectorAll('.option-btn');
            const expl = document.getElementById(`expl-${qIdx}`);
            
            opts.forEach((btn, idx) => {
                btn.disabled = true;
                if(idx === correct) btn.classList.add('correct');
                if(idx === selected && idx !== correct) btn.classList.add('incorrect');
            });
            
            expl.classList.add('show');
        };

        // --- Flowcharts ---
        const FLOWCHART_DATA = {
            nodes: [
                // Root
                { id: "root", label: "Hematopoietic Malignancy", x: 1250, y: 50, type: "label", w: 250 },
                
                // --- PLASMA BRANCH (Center) ---
                { id: "plasma", label: "Plasma Cell", x: 1250, y: 150, parent: "root", type: "label", w: 150 },
                { id: "mm", target: "Multiple Myeloma", clue: "CRAB, M-Spike, IgG", x: 1250, y: 300, parent: "plasma", type: "slot", w: 180 },

                // --- MYELOID BRANCH (Left) ---
                { id: "myeloid", label: "Myeloid Lineage", x: 650, y: 150, parent: "root", type: "label", w: 180 },
                
                { id: "acute_myeloid", label: "Acute (>20% Blasts)", x: 450, y: 300, parent: "myeloid", type: "label", w: 180 },
                { id: "chronic_myeloid", label: "Chronic (Mature)", x: 850, y: 300, parent: "myeloid", type: "label", w: 180 },
                
                // Myeloid Targets
                { id: "aml", target: "Acute Myeloid Leukemia", clue: "Auer Rods, MPO+", x: 350, y: 500, parent: "acute_myeloid", type: "slot", w: 180 },
                { id: "apml", target: "Acute Promyelocytic Leukemia", clue: "t(15;17), DIC, ATRA", x: 550, y: 500, parent: "acute_myeloid", type: "slot", w: 200 },
                
                { id: "cml", target: "Chronic Myeloid Leukemia", clue: "t(9;22), Basophilia", x: 750, y: 500, parent: "chronic_myeloid", type: "slot", w: 180 },
                { id: "pv", target: "Polycythemia Vera", clue: "JAK2, High Hct, Itching", x: 950, y: 500, parent: "chronic_myeloid", type: "slot", w: 180 },

                // --- LYMPHOID BRANCH (Right) ---
                { id: "lymphoid", label: "Lymphoid Lineage", x: 1850, y: 150, parent: "root", type: "label", w: 180 },
                
                { id: "acute_lymph", label: "Acute (Blasts)", x: 1550, y: 300, parent: "lymphoid", type: "label", w: 150 },
                { id: "chronic_lymph", label: "Chronic/Lymphoma", x: 2150, y: 300, parent: "lymphoid", type: "label", w: 180 },

                // Acute Lymphoid Target
                { id: "all", target: "Acute Lymphoblastic Leukemia", clue: "TdT+, Children, CNS", x: 1550, y: 500, parent: "acute_lymph", type: "slot", w: 200 },
                
                { id: "hodgkin", label: "Hodgkin", x: 1850, y: 450, parent: "chronic_lymph", type: "label", w: 120 },
                { id: "non_hodgkin", label: "Non-Hodgkin", x: 2450, y: 450, parent: "chronic_lymph", type: "label", w: 120 },

                // Hodgkin Target
                { id: "hl_classic", target: "Classical Hodgkin Lymphoma", clue: "Reed-Sternberg, CD15/30", x: 1850, y: 600, parent: "hodgkin", type: "slot", w: 200 },

                // Non-Hodgkin Sub-branches
                { id: "nhl_bcell", label: "B-Cell", x: 2250, y: 600, parent: "non_hodgkin", type: "label", w: 100 },
                { id: "nhl_tcell", label: "T-Cell", x: 2650, y: 600, parent: "non_hodgkin", type: "label", w: 100 },

                // B-Cell Targets (Fanned Out)
                { id: "burkitt", target: "Burkitt Lymphoma", clue: "t(8;14), Starry Sky, Jaw", x: 2100, y: 750, parent: "nhl_bcell", type: "slot", w: 180 },
                { id: "dlbcl", target: "Diffuse Large B-Cell Lymphoma", clue: "Aggressive, Most Common", x: 2250, y: 850, parent: "nhl_bcell", type: "slot", w: 220 },
                { id: "mantle", target: "Mantle Cell Lymphoma", clue: "t(11;14), Cyclin D1", x: 2400, y: 750, parent: "nhl_bcell", type: "slot", w: 180 },
                { id: "follicular", target: "Follicular Lymphoma", clue: "t(14;18), BCL-2, Wax/Wane", x: 2250, y: 950, parent: "nhl_bcell", type: "slot", w: 180 },
                
                // T-Cell Target
                { id: "mycosis", target: "Mycosis Fungoides", clue: "Skin patches, Cerebriform", x: 2650, y: 750, parent: "nhl_tcell", type: "slot", w: 180 },
            ],
            draggables: [
                "Acute Myeloid Leukemia",
                "Acute Promyelocytic Leukemia",
                "Acute Lymphoblastic Leukemia",
                "Chronic Myeloid Leukemia",
                "Polycythemia Vera",
                "Classical Hodgkin Lymphoma",
                "Burkitt Lymphoma",
                "Follicular Lymphoma",
                "Diffuse Large B-Cell Lymphoma",
                "Mantle Cell Lymphoma",
                "Mycosis Fungoides",
                "Multiple Myeloma"
            ].sort()
        };

        const DISEASE_DETAILS = {
            "Acute Myeloid Leukemia": {
                desc: "Aggressive myeloid neoplasm characterized by the accumulation of myeloblasts in the marrow (>20%).",
                clinical: "Fatigue (anemia), bleeding/petechiae (thrombocytopenia), infection (neutropenia). Gingival hyperplasia (M4/M5 subtypes).",
                lab: "Pancytopenia or Leukocytosis. Circulating blasts.",
                smear: "Large blasts, delicate chromatin, prominent nucleoli. Auer Rods (fused lysosomes/MPO) are pathognomonic.",
                markers: "MPO+, CD13+, CD33+."
            },
            "Acute Promyelocytic Leukemia": {
                desc: "Subtype of AML (M3) defined by the t(15;17) translocation.",
                clinical: "Medical Emergency! High risk of DIC (Disseminated Intravascular Coagulation) at presentation.",
                lab: "Low fibrinogen, prolonged PT/PTT (if DIC).",
                smear: "Promyelocytes with numerous Auer rods.",
                genetics: "t(15;17) PML-RARA fusion. Disrupted Retinoic Acid Receptor.",
                treatment: "ATRA (All-Trans Retinoic Acid) + Arsenic Trioxide."
            },
            "Acute Lymphoblastic Leukemia": {
                desc: "Malignant neoplasm of B or T cell precursors (lymphoblasts). Most common cancer in children.",
                clinical: "Bone pain (marrow expansion), hepatosplenomegaly. T-cell ALL can present with mediastinal mass (thymic) causing SVC syndrome.",
                lab: "Lymphoblasts in blood/marrow.",
                smear: "Small/medium blasts, scant cytoplasm, condensed chromatin. NO Auer rods.",
                markers: "TdT+ (marker of immaturity). B-ALL: CD10, CD19, CD20. T-ALL: CD2-8."
            },
            "Chronic Myeloid Leukemia": {
                desc: "Myeloproliferative Neoplasm (MPN) driven by the BCR-ABL fusion gene.",
                clinical: "Splenomegaly (early satiety), constitutional symptoms. Three phases: Chronic, Accelerated, Blast Crisis.",
                lab: "Extreme Leukocytosis (often >100k).",
                smear: "Left shift with ALL stages of myeloid maturation seen (myelocytes, metamyelocytes, bands). Basophilia is characteristic.",
                genetics: "t(9;22) Philadelphia Chromosome. BCR-ABL tyrosine kinase.",
                treatment: "Tyrosine Kinase Inhibitors (Imatinib)."
            },
            "Polycythemia Vera": {
                desc: "MPN characterized by increased red blood cell mass independent of EPO.",
                clinical: "Aquagenic pruritus (itching after hot shower), plethora (red face), erythromelalgia (burning hands/feet), thrombosis.",
                lab: "High Hct/Hgb. Low EPO.",
                genetics: "JAK2 V617F mutation (95%+).",
                treatment: "Phlebotomy, Hydroxyurea."
            },
            "Classical Hodgkin Lymphoma": {
                desc: "B-cell lymphoma characterized by Reed-Sternberg cells in a background of reactive inflammatory cells.",
                clinical: "Painless lymphadenopathy (cervical/supraclavicular). B-Symptoms (Fever, Night Sweats, Weight Loss). Pain with alcohol.",
                pathology: "Reed-Sternberg Cells ('Owl Eyes'). Background of eos, plasma cells, lymphs.",
                markers: "CD15+, CD30+, CD20- (usually), CD45-.",
                subtypes: "Nodular Sclerosis (most common), Mixed Cellularity, Lymphocyte Rich, Lymphocyte Depleted."
            },
            "Burkitt Lymphoma": {
                desc: "Highly aggressive B-cell NHL associated with EBV and c-myc translocation.",
                clinical: "Endemic (African): Jaw lesion. Sporadic: Abdominal mass. Very rapid growth.",
                pathology: "Starry Sky appearance (tangible body macrophages eating apoptotic debris).",
                genetics: "t(8;14) c-myc translocation.",
                treatment: "Aggressive chemotherapy with TLS prophylaxis."
            },
            "Follicular Lymphoma": {
                desc: "Indolent B-cell NHL arising from germinal center B-cells.",
                clinical: "Painless waxing and waning lymphadenopathy. Older adults.",
                pathology: "Nodular pattern. Small cleaved cells (centrocytes).",
                genetics: "t(14;18) BCL-2 overexpression (prevents apoptosis).",
                treatment: "Watch and wait; Rituximab."
            },
            "Diffuse Large B-Cell Lymphoma": {
                desc: "Aggressive B-cell NHL. Most common NHL in adults.",
                clinical: "Rapidly enlarging mass (nodal or extranodal). B-symptoms common.",
                pathology: "Diffuse sheets of large B cells disrupting node architecture.",
                genetics: "Variable. BCL-6 mutations common.",
                treatment: "R-CHOP."
            },
            "Mantle Cell Lymphoma": {
                desc: "Aggressive B-cell NHL arising from the mantle zone.",
                clinical: "Lymphadenopathy, hepatosplenomegaly, GI involvement (lymphomatoid polyposis).",
                markers: "CD5+, CD23- (Distinguishes from CLL). Cyclin D1+.",
                genetics: "t(11;14) Cyclin D1 overexpression."
            },
            "Mycosis Fungoides": {
                desc: "Cutaneous T-Cell Lymphoma (CTCL).",
                clinical: "Skin patches, plaques, tumors. Erythroderma (Sezary Syndrome) if leukemic.",
                pathology: "Pautrier microabscesses (lymphocytes in epidermis). Cerebriform nuclei (brain-like) in Sezary cells.",
                markers: "CD4+ T-cells."
            },
            "Multiple Myeloma": {
                desc: "Malignant proliferation of plasma cells in the bone marrow.",
                clinical: "CRAB: HyperCalcemia, Renal failure, Anemia, Bone lytic lesions (back pain). Recurrent infections.",
                lab: "M-Spike (monoclonal IgG or IgA) on SPEP. Bence-Jones protein (light chains) in urine.",
                smear: "Rouleaux formation (RBCs stacked like coins). >10% plasma cells in marrow.",
                treatment: "Proteasome inhibitors (Bortezomib), Lenalidomide."
            }
        };

        const FlowchartStore = {
            get: (key, def) => {
                const val = localStorage.getItem(`md816_fc_${key}`);
                return val ? JSON.parse(val) : def;
            },
            set: (key, val) => {
                localStorage.setItem(`md816_fc_${key}`, JSON.stringify(val));
            }
        };

        let svgScale = 1;
        let svgTranslate = { x: 0, y: 0 };
        let isDraggingCanvas = false;
        let lastMousePos = { x: 0, y: 0 };
        let selectedDisease = null;
        let revealedHints = new Set();

        function renderFlowchart() {
            const matched = FlowchartStore.get('matched', []);

            const listEl = document.getElementById('draggable-list');
            const groupEl = document.getElementById('fc-transform-group');
            if (!listEl || !groupEl) return;

            // 1. Render Sidebar List
            listEl.innerHTML = FLOWCHART_DATA.draggables.map(item => {
                const isMatched = matched.includes(item);
                const isSelected = selectedDisease === item;
                // Removed draggable="true" to de-emphasize drag and drop
                return `
                    <div class="fc-draggable ${isMatched ? 'matched' : ''} ${isSelected ? 'selected' : ''}"
                         onclick="selectDisease(this)"
                         data-val="${item}">
                        ${item}
                        ${isMatched ? ' [OK]' : ''}
                    </div>
                `;
            }).join('');

            // 2. Render Canvas Content
            const linksHtml = FLOWCHART_DATA.nodes.map(node => {
                if(!node.parent) return '';
                const p = FLOWCHART_DATA.nodes.find(n => n.id === node.parent);
                if(!p) return '';
                return `<path class="link" d="M${p.x} ${p.y + 25} C ${p.x} ${node.y - 40}, ${node.x} ${p.y + 25}, ${node.x} ${node.y - 40}" />`;
            }).join('');

            const nodesHtml = FLOWCHART_DATA.nodes.map(node => {
                const w = node.w || 120;
                const h = 50;
                const isSlot = node.type === 'slot';
                const isCorrect = matched.includes(node.target);
                
                const safeId = node.target ? node.target.replace(/[^a-zA-Z]/g, '') : node.id;
                
                let hintText = "";
                if (isSlot && !isCorrect) {
                    if (revealedHints.has(safeId)) {
                        hintText = node.clue;
                    } else {
                        hintText = "(Click for hint)";
                    }
                }

                let contentHtml = '';
                if(isCorrect) {
                    contentHtml = `
                        <text x="${w/2}" y="${h/2 - 7}" class="node-text">
                            ${node.target}
                        </text>
                        <text x="${w/2}" y="${h/2 + 12}" class="node-info-indicator">
                            Info
                        </text>
                    `;
                } else {
                    contentHtml = `
                        <text x="${w/2}" y="${h/2 + (isSlot ? -5 : 0)}" class="node-text">
                            ${node.label || "Select Disease & Click Here"}
                        </text>
                        ${isSlot ? `<text x="${w/2}" y="${h/2 + 12}" class="node-clue">${hintText}</text>` : ''}
                    `;
                }

                return `
                    <g transform="translate(${node.x - w/2}, ${node.y - h/2})"
                       onclick="handleSlotClick(this, '${node.target}', '${safeId}')"
                       class="node-group"
                       id="node-${safeId}"
                       style="cursor: ${isCorrect ? 'help' : 'pointer'}">
                        
                        <rect class="node-rect ${isSlot ? 'slot' : ''} ${isCorrect ? 'correct' : ''}"
                              width="${w}" height="${h}"></rect>
                        
                        ${contentHtml}
                    </g>
                `;
            }).join('');

            groupEl.innerHTML = linksHtml + nodesHtml;
        }

        window.selectDisease = (el) => {
            if(el.classList.contains('matched')) return;
            
            const val = el.dataset.val;
            
            if(selectedDisease === val) {
                selectedDisease = null;
            } else {
                selectedDisease = val;
            }
            
            renderFlowchart();
        };

        window.handleSlotClick = (el, targetVal, safeId) => {
            const matched = FlowchartStore.get('matched', []);
            
            if (matched.includes(targetVal)) {
                showInfo(targetVal);
                return;
            }

            if (!selectedDisease && targetVal !== 'undefined') {
                if (revealedHints.has(safeId)) {
                    revealedHints.delete(safeId);
                } else {
                    revealedHints.add(safeId);
                }
                renderFlowchart();
                return;
            }

            if(!selectedDisease || targetVal === 'undefined') return;
            attemptMatch(selectedDisease, targetVal, safeId);
        };

        function attemptMatch(attempt, target, safeId) {
            if (!attempt || !target) return;

            const nodeGroup = document.getElementById(`node-${safeId}`);
            if (!nodeGroup) return;
            const rect = nodeGroup.querySelector('rect');

            if (attempt === target) {
                const matched = FlowchartStore.get('matched', []);
                if(!matched.includes(attempt)) {
                    matched.push(attempt);
                    FlowchartStore.set('matched', matched);
                    
                    selectedDisease = null;
                    
                    renderFlowchart();
                }
            } else if (rect) {
                rect.classList.add('wrong');
                setTimeout(() => rect.classList.remove('wrong'), 500);
            }
        }

        function showInfo(diseaseName) {
            const data = DISEASE_DETAILS[diseaseName];
            if (!data) return;

            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-body');
            const modal = document.getElementById('info-modal');
            if (!title || !body || !modal) return;

            title.innerText = diseaseName;
            
            let html = `<div class="info-section"><span class="info-label">Description</span><p class="info-text">${data.desc}</p></div>`;
            
            if (data.clinical) html += `<div class="info-section"><span class="info-label">Clinical Features</span><p class="info-text">${data.clinical}</p></div>`;
            if (data.lab) html += `<div class="info-section"><span class="info-label">Lab Findings</span><p class="info-text">${data.lab}</p></div>`;
            if (data.smear || data.pathology) html += `<div class="info-section"><span class="info-label">Morphology/Pathology</span><p class="info-text">${data.smear || data.pathology}</p></div>`;
            if (data.markers) html += `<div class="info-section"><span class="info-label">Immunophenotype</span><p class="info-text">${data.markers}</p></div>`;
            if (data.genetics) html += `<div class="info-section"><span class="info-label">Genetics</span><p class="info-text">${data.genetics}</p></div>`;
            if (data.treatment) html += `<div class="info-section"><span class="info-label">Treatment</span><p class="info-text">${data.treatment}</p></div>`;

            body.innerHTML = html;
            modal.classList.add('open');
        }

        window.closeModal = (e) => {
            if (e) e.stopPropagation();
            const modal = document.getElementById('info-modal');
            if (modal) modal.classList.remove('open');
        };

        window.clearProgress = () => {
            if(confirm("Are you sure you want to reset all progress?")) {
                FlowchartStore.set('matched', []);
                selectedDisease = null;
                revealedHints.clear();
                renderFlowchart();
            }
        };

        // --- Pan & Zoom ---

        window.startPan = (e) => {
            if(e.target.closest('.fc-btn') || e.target.closest('.node-group')) return;
            isDraggingCanvas = true;
            lastMousePos = { x: e.clientX, y: e.clientY };
        };

        window.pan = (e) => {
            if (!isDraggingCanvas) return;
            e.preventDefault();
            
            const sensitivity = 1.5;
            
            const dx = (e.clientX - lastMousePos.x) * sensitivity;
            const dy = (e.clientY - lastMousePos.y) * sensitivity;
            
            svgTranslate.x += dx;
            svgTranslate.y += dy;
            lastMousePos = { x: e.clientX, y: e.clientY };
            updateTransform();
        };

        window.endPan = () => {
            isDraggingCanvas = false;
        };

        window.zoom = (e) => {
            e.preventDefault();
            
            const scaleFactor = 1.1;
            const direction = e.deltaY < 0 ? 1 : -1;
            const factor = direction > 0 ? scaleFactor : 1/scaleFactor;
            
            const newScale = svgScale * factor;
            
            const container = document.getElementById('fc-canvas-container');
            if (!container) return;
            const rect = container.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;

            const worldX = (mouseX - svgTranslate.x) / svgScale;
            const worldY = (mouseY - svgTranslate.y) / svgScale;

            svgTranslate.x = mouseX - worldX * newScale;
            svgTranslate.y = mouseY - worldY * newScale;
            
            svgScale = newScale;
            
            updateTransform();
        };

        window.resetView = () => {
            const container = document.getElementById('fc-canvas-container');
            if (!container) return;
            const containerW = container.clientWidth;
            const chartW = 2000;
            
            svgScale = (containerW / chartW) * 0.95;
            
            const screenCenter = containerW / 2;
            const chartCenter = 1000 * svgScale;
            
            svgTranslate.x = screenCenter - chartCenter;
            svgTranslate.y = 250;

            updateTransform();
        };

        function updateTransform() {
            const g = document.getElementById('fc-transform-group');
            if(g) {
                g.setAttribute('transform', `translate(${svgTranslate.x}, ${svgTranslate.y}) scale(${svgScale})`);
            }
        }

        function initFlowchartView() {
            if (!document.getElementById('draggable-list')) return;
            renderFlowchart();
            setTimeout(resetView, 100);
        }

        function renderFlowcharts() {
            return `
                <div class="fc-wrapper">
                    <div class="fc-sidebar">
                        <h2>Disease Bank</h2>
                        <p class="fc-instructions">
                            <strong>How to play:</strong><br>
                            1. Click a disease below to select it.<br>
                            2. Click the matching empty box in the chart.<br>
                            3. Click a <strong>completed</strong> box to see full disease details.
                        </p>
                        <div id="draggable-list"></div>
                        <div style="margin-top:auto; padding-top:1rem; font-size:0.8rem; color:var(--text-muted); text-align:center">
                            MD816 Exam 2 Study Tool
                        </div>
                    </div>

                    <div class="fc-canvas-container" id="fc-canvas-container"
                         onmousedown="startPan(event)"
                         onmousemove="pan(event)"
                         onmouseup="endPan()"
                         onmouseleave="endPan()"
                         onwheel="zoom(event)">
                        
                        <div class="fc-controls">
                            <button class="fc-btn" onclick="resetView()">Centering View</button>
                            <button class="fc-btn" onclick="clearProgress()" style="color:var(--danger); border-color:var(--danger)">Reset Progress</button>
                        </div>

                        <svg id="fc-svg" width="100%" height="100%" viewBox="0 0 2500 1200" style="width:100%; height:100%">
                            <g id="fc-transform-group"></g>
                        </svg>
                    </div>
                </div>

                <div id="info-modal" class="modal-overlay" onclick="closeModal(event)">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <button class="modal-close" onclick="closeModal(event)">&times;</button>
                        <h2 id="modal-title" class="info-title">Disease Name</h2>
                        <div id="modal-body"></div>
                    </div>
                </div>
            `;
        }

        // --- Main Render Loop ---
        function renderApp() {
            const app = document.getElementById('app-view');
            const isFlowchart = router.current === 'flowcharts';
            app.classList.toggle('flowchart-view', isFlowchart);
            app.classList.remove('page-enter');
            app.innerHTML = '';
            
            switch(router.current) {
                case 'home': app.innerHTML = renderHome(); break;
                case 'diseases': app.innerHTML = renderDiseases(); break;
                case 'flashcards': app.innerHTML = renderFlashcards(); break;
                case 'quiz': app.innerHTML = renderQuiz(); break;
                case 'flowcharts':
                    app.innerHTML = renderFlowcharts();
                    initFlowchartView();
                    break;
                default: app.innerHTML = renderHome();
            }
            void app.offsetWidth;
            app.classList.add('page-enter');
            updateStats();
        }

        function updateStats() {
            const p = Store.get('progress');
            const fill = document.getElementById('daily-progress');
            if(fill) fill.style.width = `${Math.min(p.daily, 100)}%`;
            
            const due = document.getElementById('cards-due');
            // Simplified logic: remaining cards in session
            if(due) due.innerText = `${cardSession.length - currentCardIndex} Cards Remaining`;
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            Store.init();
            
            // Restore Theme
            const savedTheme = Store.get('theme', 'light');
            document.body.setAttribute('data-theme', savedTheme);

            // Search Listener
            document.getElementById('global-search').addEventListener('input', (e) => {
                if(router.current !== 'diseases') router.navigate('diseases');
                renderApp();
            });

            initFlashcards();
            renderApp();

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && typeof window.closeModal === 'function') {
                    window.closeModal();
                }
            });
        });

    </script>
</body>
</html>
