<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Heme-Lymph Match Platform (Combined)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>

/* ===== Animations ===== */
@keyframes shake {
  0%, 100% { transform: translateX(0); }
  20% { transform: translateX(-6px); }
  40% { transform: translateX(6px); }
  60% { transform: translateX(-4px); }
  80% { transform: translateX(4px); }
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}
@keyframes popIn {
  0% { opacity: 0; transform: scale(0.96) translateY(10px); }
  100% { opacity: 1; transform: scale(1) translateY(0); }
}
@keyframes slideIn {
  from { opacity: 0; transform: translateX(-10px); }
  to { opacity: 1; transform: translateX(0); }
}
@keyframes timerPulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}
@keyframes badgeAppear {
  0% { opacity: 0; transform: translateY(10px) scale(0.9); }
  100% { opacity: 1; transform: translateY(0) scale(1); }
}

.animate-shake { animation: shake 0.45s ease-in-out; }
.animate-fadeIn { animation: fadeIn 0.35s ease-out; }
.animate-popIn { animation: popIn 0.35s ease-out; }
.animate-slideIn { animation: slideIn 0.35s ease-out; }

.timer-warning { animation: timerPulse 0.8s infinite; }

.badge-animation { animation: badgeAppear 0.5s ease-out; }

.search-highlight {
  background: rgba(250, 204, 21, 0.35);
  padding: 0.1em 0.2em;
  border-radius: 0.25em;
}

/* ===== Drag & Drop ===== */
.draggable-item {
  background: white;
  border: 2px solid #e2e8f0; /* slate-200 */
  border-radius: 0.75rem;
  padding: 0.75rem;
  cursor: grab;
  font-weight: 700;
  color: #0f172a; /* slate-900 */
  box-shadow: 0 1px 2px rgba(0,0,0,0.05);
  transition: transform 0.15s ease, box-shadow 0.15s ease, border-color 0.15s ease;
}
.draggable-item:hover {
  border-color: #93c5fd; /* blue-300 */
  box-shadow: 0 10px 15px rgba(0,0,0,0.08);
}
.draggable-item.dragging {
  opacity: 0.65;
  transform: rotate(2deg);
  cursor: grabbing;
}

.drop-zone {
  background: white;
  border: 2px dashed #cbd5e1; /* slate-300 */
  border-radius: 0.75rem;
  padding: 0.75rem;
  transition: background 0.15s ease, border-color 0.15s ease, transform 0.15s ease;
}
.drop-zone.drag-over {
  background: rgba(59, 130, 246, 0.05);
  border-color: #3b82f6; /* blue-500 */
  transform: scale(1.01);
}
.placed-item {
  background: rgba(16, 185, 129, 0.12); /* emerald-500 */
  border: 1px solid rgba(16, 185, 129, 0.35);
  border-radius: 0.75rem;
  padding: 0.6rem 0.75rem;
  font-weight: 800;
  color: #065f46; /* emerald-800 */
}

/* ===== Toggle ===== */
.toggle-bg { transition: background-color 0.2s ease; }
.toggle-dot { transition: transform 0.2s ease; }
.toggle-checkbox:checked + .toggle-bg { background-color: #3b82f6; }
.toggle-checkbox:checked + .toggle-bg + .toggle-dot { transform: translateX(1.25rem); }

/* ===== Better scrollbar (WebKit) ===== */
::-webkit-scrollbar { width: 10px; height: 10px; }
::-webkit-scrollbar-track { background: #f1f5f9; }
::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 999px; }
::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

  </style>
</head>
<body class="min-h-screen flex flex-col bg-slate-100">

  <!-- Header -->
  <header class="bg-white border-b border-slate-200 shadow-sm sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between gap-4">
      <div class="flex items-center gap-3 min-w-0">
        <div class="p-2 rounded-xl bg-gradient-to-br from-blue-600 to-indigo-700 text-white shadow-md shrink-0">
          <!-- simple book icon -->
          <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
          </svg>
        </div>
        <div class="min-w-0">
          <div class="flex items-center gap-2">
            <h1 class="text-lg sm:text-xl font-extrabold text-slate-900 truncate">Heme-Lymph Match</h1>
            <span class="hidden sm:inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-slate-100 text-slate-600 text-xs font-bold border border-slate-200">
              Combined
            </span>
          </div>
          <div class="text-xs text-slate-500 font-semibold truncate">Decks ‚Ä¢ Flowchart ‚Ä¢ Images ‚Ä¢ Morphology Match ‚Ä¢ Mechanisms ‚Ä¢ Quizzes ‚Ä¢ Index</div>
        </div>
      </div>

      <div class="flex items-center gap-2 sm:gap-3">
        <!-- Flowchart Controls -->
        <div id="flowchart-controls" class="hidden items-center gap-2 bg-slate-100 rounded-xl p-2 border border-slate-200">
          <button onclick="adjustZoom(-0.1)" class="w-9 h-9 flex items-center justify-center rounded-lg bg-white border border-slate-200 font-extrabold text-slate-700 hover:bg-slate-50">-</button>
          <button onclick="resetZoom()" class="w-9 h-9 flex items-center justify-center rounded-lg bg-white border border-slate-200 text-slate-700 hover:bg-slate-50" title="Reset zoom">
            <span class="sr-only">Reset</span>
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.84 1.04 6.5 2.7L21 8"/>
              <path d="M21 3v5h-5"/>
            </svg>
          </button>
          <button onclick="adjustZoom(0.1)" class="w-9 h-9 flex items-center justify-center rounded-lg bg-white border border-slate-200 font-extrabold text-slate-700 hover:bg-slate-50">+</button>
        </div>

        <!-- Quiz Timer -->
        <div id="quiz-timer" class="hidden items-center gap-2 bg-slate-100 rounded-xl px-3 py-2 border border-slate-200">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-600">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M12 6v6l4 2"></path>
          </svg>
          <span id="timer-display" class="font-mono font-extrabold text-slate-800">60</span>
        </div>

        <!-- Game Stats -->
        <div id="game-stats" class="hidden items-center gap-3 bg-slate-100 rounded-xl px-3 py-2 border border-slate-200">
          <div class="flex items-center gap-2 text-slate-600">
            <span class="text-xs font-bold uppercase tracking-wider">Progress</span>
            <span id="progress-display" class="text-sm font-extrabold text-slate-800">0 / 0</span>
          </div>
          <div class="w-px h-6 bg-slate-300"></div>
          <div class="flex items-center gap-2 text-blue-600">
            <span class="text-xs font-bold uppercase tracking-wider text-slate-600">Score</span>
            <span id="score-display" class="text-sm font-extrabold">0</span>
          </div>
          <div class="w-px h-6 bg-slate-300"></div>
          <div class="flex items-center gap-2 text-rose-600">
            <span class="text-xs font-bold uppercase tracking-wider text-slate-600">Mistakes</span>
            <span id="mistakes-display" class="text-sm font-extrabold">0</span>
          </div>
        </div>

        <!-- Close -->
        <button id="close-btn" onclick="goToMenu()" class="hidden w-11 h-11 rounded-xl bg-slate-900 text-white flex items-center justify-center hover:bg-slate-800 transition-colors shadow-sm" title="Back to menu">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 6L6 18"></path>
            <path d="M6 6l12 12"></path>
          </svg>
        </button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main id="main-content" class="w-full flex-grow relative overflow-y-auto"></main>

  <!-- Image Modal -->
  <div id="image-modal" class="hidden fixed inset-0 bg-black/80 z-50 items-center justify-center p-4">
    <div class="bg-white rounded-2xl max-w-4xl w-full overflow-hidden shadow-2xl">
      <div class="flex items-center justify-between px-4 py-3 border-b border-slate-200 bg-slate-50">
        <div class="font-extrabold text-slate-900">Image</div>
        <button onclick="closeImageModal()" class="px-3 py-1.5 rounded-xl bg-slate-900 text-white font-bold hover:bg-slate-800">Close</button>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-2">
        <div class="bg-slate-100 p-4 flex items-center justify-center">
          <img id="modal-img" src="" alt="Study image" class="max-h-[70vh] w-auto rounded-xl shadow-sm" />
        </div>
        <div class="p-6">
          <h3 id="modal-title" class="text-2xl font-extrabold text-slate-900 mb-2"></h3>
          <div id="modal-desc" class="text-slate-700"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Achievement Modal -->
  <div id="achievement-modal" class="hidden fixed inset-0 bg-black/60 z-50 items-center justify-center p-4">
    <div class="bg-white rounded-2xl max-w-md w-full p-6 shadow-2xl animate-popIn">
      <div class="text-center">
        <div id="achievement-icon" class="text-5xl mb-3">üèÜ</div>
        <h3 id="achievement-title" class="text-2xl font-extrabold text-slate-900 mb-2">Achievement</h3>
        <p id="achievement-text" class="text-slate-600 mb-6">Unlocked!</p>
        <button onclick="closeAchievement()" class="px-6 py-3 rounded-xl bg-slate-900 text-white font-extrabold hover:bg-slate-800">Continue</button>
      </div>
    </div>
  </div>

  <script>
'use strict';

const ICONS = {
            Layers: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83Z"/><path d="m22 17.65-9.17 4.16a2 2 0 0 1-1.66 0L2 17.65"/><path d="m22 12.65-9.17 4.16a2 2 0 0 1-1.66 0L2 12.65"/></svg>`,
            Droplet: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22a7 7 0 0 0 7-7c0-2-1-3.9-3-5.5s-3.5-4-4-6.5c-.5 2.5-2 4.9-4 6.5C6 11.1 5 13 5 15a7 7 0 0 0 7 7z"/></svg>`,
            Activity: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>`,
            ShieldAlert: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><path d="M12 8v4"/><path d="M12 16h.01"/></svg>`,
            Bug: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m8 2 1.88 1.88"/><path d="M14.12 3.88 16 2"/><path d="M9 7.13v-1a3.003 3.003 0 1 1 6 0v1"/><path d="M12 20c-3.3 0-6-2.7-6-6v-3a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v3c0 3.3-2.7 6-6 6"/><path d="M12 20v-9"/><path d="M6.53 9C4.6 8.8 3 7.1 3 5"/><path d="M6 13H2"/><path d="M3 21c0-2.1 1.7-3.9 3.8-4"/><path d="M20.97 5c0 2.1-1.6 3.8-3.5 4"/><path d="M22 13h-4"/><path d="M17.2 17c2.1.1 3.8 1.9 3.8 4"/></svg>`,
            FlaskConical: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 2v7.527a2 2 0 0 1-.211.896L4.72 20.55a1 1 0 0 0 .9 1.45h12.76a1 1 0 0 0 .9-1.45l-5.069-10.127A2 2 0 0 1 14 9.527V2"/><path d="M8.5 2h7"/><path d="M7 16h10"/></svg>`,
            Pill: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m10.5 20.5 10-10a4.95 4.95 0 1 0-7-7l-10 10a4.95 4.95 0 1 0 7 7Z"/><path d="m8.5 8.5 7 7"/></svg>`,
            CheckCircle: `<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="M22 4 12 14.01l-3-3"/></svg>`,
            ArrowRight: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>`,
            TrophyBig: `<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>`,
            RotateCcw: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>`,
            GitBranch: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="6" y1="3" x2="6" y2="15"/><circle cx="18" cy="6" r="3"/><circle cx="6" cy="18" r="3"/><path d="M18 9a9 9 0 0 1-9 9"/></svg>`,
            Sparkles: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 5h4"/><path d="M3 9h4"/></svg>`,
            Stethoscope: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4.8 2.3A.3.3 0 1 0 5 2H4a2 2 0 0 0-2 2v5a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6V4a2 2 0 0 0-2-2h-1a.2.2 0 1 0 .3.3"/><path d="M8 15v1a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6v-4"/><circle cx="20" cy="10" r="2"/></svg>`,
            Microscope: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 18h8"/><path d="M3 22h18"/><path d="M14 22a7 7 0 1 0 0-14h-1"/><path d="M9 14h2"/><path d="M9 12a2 2 0 0 1-2-2V6h6v4a2 2 0 0 1-2 2Z"/><path d="M12 6V3a1 1 0 0 0-1-1H9a1 1 0 0 0-1 1v3"/></svg>`,
            Eye: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>`,
            EyeOff: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" y1="2" x2="22" y2="22"/></svg>`,
            Image: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>`
        };

// Extra icons imported from Claude variant
ICONS.Brain = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></svg>`;
ICONS.Zap = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>`;
ICONS.Search = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>`;
ICONS.Database = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M3 5V19A9 3 0 0 0 21 19V5"/><path d="M3 12A9 3 0 0 0 21 12"/></svg>`;
ICONS.Move = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="5 9 2 12 5 15"/><polyline points="9 5 12 2 15 5"/><polyline points="15 19 12 22 9 19"/><polyline points="19 9 22 12 19 15"/><line x1="2" x2="22" y1="12" y2="12"/><line x1="12" x2="12" y1="2" y2="22"/></svg>`;


// ===== UTILS =====
function clamp(n, min, max) { return Math.max(min, Math.min(max, n)); }

function shuffleArray(arr) {
  // Fisher-Yates shuffle in-place
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function safeParseJSON(raw, fallback) {
  try { return raw ? JSON.parse(raw) : fallback; } catch { return fallback; }
}

function escapeHtml(str) {
  return String(str)
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#39;');
}

function escapeJs(str) {
  return String(str)
    .replaceAll('\\', '\\\\')
    .replaceAll("'", "\\'")
    .replaceAll('"', '\\"')
    .replaceAll('\n', '\\n')
    .replaceAll('\r', '\\r');
}


function formatConditionList(conditions) {
  const items = Array.isArray(conditions)
    ? conditions.filter(Boolean).map(item => String(item))
    : (conditions ? [String(conditions)] : []);

  if (!items.length) {
    return '<div class="text-slate-500">-</div>';
  }
  if (items.length === 1) {
    return `<div>${escapeHtml(items[0])}</div>`;
  }
  return `<ul class="list-disc pl-5 space-y-1">${items.map(item => `<li>${escapeHtml(item)}</li>`).join('')}</ul>`;
}

function buildImageModalDescription(meta, fallbackDesc) {
  if (!meta || (!meta.appearance && !meta.mechanism && !meta.conditions)) {
    return fallbackDesc
      ? `<p class="text-slate-700">${escapeHtml(fallbackDesc)}</p>`
      : '<div class="text-slate-500">-</div>';
  }

  const appearanceText = meta.appearance || fallbackDesc || '-';
  const conditionsHtml = formatConditionList(meta.conditions);
  const mechanismText = meta.mechanism || '-';

  return `
    <div class="rounded-xl border border-slate-200 bg-slate-50 overflow-hidden text-sm">
      <div class="p-4">
        <div class="text-xs font-extrabold uppercase tracking-wider text-slate-500 mb-1">Appearance</div>
        <div class="text-slate-700">${escapeHtml(appearanceText)}</div>
      </div>
      <div class="border-t border-slate-200 p-4">
        <div class="text-xs font-extrabold uppercase tracking-wider text-slate-500 mb-1">Diseases / Disorders</div>
        <div class="text-slate-700">${conditionsHtml}</div>
      </div>
      <div class="border-t border-slate-200 p-4">
        <div class="text-xs font-extrabold uppercase tracking-wider text-slate-500 mb-1">Mechanism</div>
        <div class="text-slate-700">${escapeHtml(mechanismText)}</div>
      </div>
    </div>
  `;
}

function slugify(str) {
  return String(str || '')
    .toLowerCase()
    .trim()
    .replace(/[^\w\s-]/g, '')
    .replace(/\s+/g, '-')
    .replace(/-+/g, '-')
    .replace(/^-|-$/g, '') || 'item';
}

function cryptoRandomId() {
  try {
    if (crypto && crypto.getRandomValues) {
      const buf = new Uint32Array(2);
      crypto.getRandomValues(buf);
      return `${buf[0].toString(16)}${buf[1].toString(16)}`;
    }
  } catch {}
  return Math.random().toString(16).slice(2) + Math.random().toString(16).slice(2);
}

function pickRandom(arr, n) {
  const copy = arr.slice();
  shuffleArray(copy);
  return copy.slice(0, n);
}

function normalizeQuery(q) {
  return String(q || '').toLowerCase().trim();
}

function highlightText(text, query) {
  const safeText = escapeHtml(text);
  const q = normalizeQuery(query);
  if (!q) return safeText;
  // Escape regex chars
  const escaped = q.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  const re = new RegExp(escaped, 'ig');
  return safeText.replace(re, m => `<span class="search-highlight">${m}</span>`);
}



// ===== CORE DATASETS (Gemini baseline) =====

const FULL_DATA = [
            // --- HEME SYNTHESIS DISORDERS ---
            { category: 'Heme Synthesis', term: 'Acute Intermittent Porphyria (AIP)', etiology: 'AD porphobilinogen deaminase (hydroxymethylbilane synthase) deficiency.', findings: 'Abdominal pain, psychiatric/neurologic symptoms, port-wine urine, ‚Üë ALA/PBG, no photosensitivity.', def: 'Abdominal pain, psychiatric/neurologic symptoms, port-wine urine, ‚Üë ALA/PBG, no photosensitivity.' },
            { category: 'Heme Synthesis', term: 'Porphyria Cutanea Tarda (PCT)', etiology: 'Uroporphyrinogen decarboxylase deficiency (often acquired; assoc with Hep C, alcohol, iron overload).', findings: 'Photosensitivity with blistering, red-brown urine, ‚Üë uroporphyrins.', def: 'Photosensitivity with blistering, red-brown urine, ‚Üë uroporphyrins.' },
            { category: 'Heme Synthesis', term: 'Lead Poisoning', etiology: 'Lead inhibits ALA dehydratase and ferrochelatase (acquired exposure).', findings: 'Microcytic anemia with basophilic stippling and ringed sideroblasts; abdominal pain, neuropathy/encephalopathy.', def: 'Microcytic anemia with basophilic stippling and ringed sideroblasts; abdominal pain, neuropathy/encephalopathy.' },

            // --- HYPOPROLIFERATIVE ANEMIAS ---
            { category: 'Anemias: Hypoproliferative', term: 'Iron Deficiency Anemia (IDA)', etiology: 'Iron deficiency from blood loss, low intake, or malabsorption.', findings: 'Microcytic hypochromic anemia, ‚Üì ferritin/iron, ‚Üë TIBC, pica, koilonychia, pencil cells.', def: 'Microcytic hypochromic anemia, ‚Üì ferritin/iron, ‚Üë TIBC, pica, koilonychia, pencil cells.' },
            { category: 'Anemias: Hypoproliferative', term: 'Anemia of Chronic Disease (ACD)', etiology: 'Inflammation ‚Üë hepcidin causing iron sequestration and ‚Üì EPO response.', findings: 'Normo/microcytic anemia, ‚Üë ferritin, ‚Üì iron, ‚Üì TIBC.', def: 'Normo/microcytic anemia, ‚Üë ferritin, ‚Üì iron, ‚Üì TIBC.' },
            { category: 'Anemias: Hypoproliferative', term: 'Thalassemia', etiology: 'Inherited ‚Üì globin chain synthesis (alpha or beta).', findings: 'Microcytosis with target cells, normal/high iron, ‚Üë HbA2/HbF in beta-thalassemia.', def: 'Microcytosis with target cells, normal/high iron, ‚Üë HbA2/HbF in beta-thalassemia.' },
            { category: 'Anemias: Hypoproliferative', term: 'Sideroblastic Anemia', etiology: 'Defective heme synthesis (ALAS2 mutation, B6 deficiency, lead, drugs).', findings: 'Ringed sideroblasts, ‚Üë iron/‚Üë ferritin, basophilic stippling, microcytosis.', def: 'Ringed sideroblasts, ‚Üë iron/‚Üë ferritin, basophilic stippling, microcytosis.' },
            { category: 'Anemias: Hypoproliferative', term: 'Anemia of Chronic Kidney Disease (CKD)', etiology: '‚Üì EPO production from CKD.', findings: 'Normocytic anemia with low reticulocytes; echinocytes (burr cells) if uremic.', def: 'Normocytic anemia with low reticulocytes; echinocytes (burr cells) if uremic.' },
            { category: 'Anemias: Hypoproliferative', term: 'B12 Deficiency', etiology: 'Cobalamin deficiency (pernicious anemia, malabsorption, vegan).', findings: 'Macrocytic anemia, hypersegmented neutrophils, ‚Üë MMA + homocysteine, neuro symptoms.', def: 'Macrocytic anemia, hypersegmented neutrophils, ‚Üë MMA + homocysteine, neuro symptoms.' },
            { category: 'Anemias: Hypoproliferative', term: 'Folate Deficiency', etiology: 'Folate deficiency (diet, alcoholism, drugs).', findings: 'Macrocytosis, hypersegmented neutrophils, ‚Üë homocysteine with normal MMA, no neuro deficits.', def: 'Macrocytosis, hypersegmented neutrophils, ‚Üë homocysteine with normal MMA, no neuro deficits.' },
            { category: 'Anemias: Hypoproliferative', term: 'Copper Deficiency', etiology: 'Copper deficiency (malabsorption, gastric surgery, zinc excess).', findings: 'Macrocytic or microcytic anemia with neutropenia, low ceruloplasmin; can mimic MDS/neuropathy.', def: 'Macrocytic or microcytic anemia with neutropenia, low ceruloplasmin; can mimic MDS/neuropathy.' },

            // --- HEMOLYTIC ANEMIAS (Non-MAHA) ---
            { category: 'Hemolytic (Non-MAHA)', term: 'Sickle Cell Disease (SCD)', etiology: 'AD beta-globin Glu->Val mutation (HbS).', findings: 'Vaso-occlusive pain crises, acute chest syndrome, sickle + target cells, ‚Üë reticulocytes.', def: 'Vaso-occlusive pain crises, acute chest syndrome, sickle + target cells, ‚Üë reticulocytes.' },
            { category: 'Hemolytic (Non-MAHA)', term: 'Warm Autoimmune Hemolytic Anemia (AIHA)', etiology: 'IgG autoantibodies (warm) causing extravascular hemolysis.', findings: 'Spherocytes, +direct Coombs (IgG), anemia with possible splenomegaly; assoc SLE/drugs.', def: 'Spherocytes, +direct Coombs (IgG), anemia with possible splenomegaly; assoc SLE/drugs.' },
            { category: 'Hemolytic (Non-MAHA)', term: 'Cold Autoimmune Hemolytic Anemia (AIHA)', etiology: 'IgM autoantibodies (cold) with complement fixation; assoc Mycoplasma/EBV.', findings: 'RBC agglutination, +Coombs (C3), acrocyanosis with cold exposure.', def: 'RBC agglutination, +Coombs (C3), acrocyanosis with cold exposure.' },
            { category: 'Hemolytic (Non-MAHA)', term: 'Hereditary Spherocytosis', etiology: 'AD membrane skeleton defect (spectrin/ankyrin/band 3).', findings: 'Spherocytes, ‚Üë MCHC, +osmotic fragility, splenomegaly/gallstones.', def: 'Spherocytes, ‚Üë MCHC, +osmotic fragility, splenomegaly/gallstones.' },
            { category: 'Hemolytic (Non-MAHA)', term: 'Glucose-6-Phosphate Dehydrogenase Deficiency (G6PD)', etiology: 'X-linked G6PD enzyme deficiency ‚Üí oxidative stress hemolysis.', findings: 'Heinz bodies, bite cells, episodic hemolysis after fava beans/sulfas; ‚Üì G6PD on assay (after episode).', def: 'Heinz bodies, bite cells, episodic hemolysis after fava beans/sulfas; ‚Üì G6PD on assay (after episode).' },
            { category: 'Hemolytic (Non-MAHA)', term: 'Paroxysmal Nocturnal Hemoglobinuria (PNH)', etiology: 'Acquired PIG-A mutation ‚Üí loss of GPI anchors (CD55/59).', findings: 'Hemoglobinuria (dark AM urine), thrombosis, pancytopenia; ‚Üì CD55/59 on flow cytometry.', def: 'Hemoglobinuria (dark AM urine), thrombosis, pancytopenia; ‚Üì CD55/59 on flow cytometry.' },
            { category: 'Hemolytic (Non-MAHA)', term: 'Pyruvate Kinase Deficiency', etiology: 'AR pyruvate kinase deficiency ‚Üí ‚Üì ATP in RBCs.', findings: 'Extravascular hemolysis, echinocytes (burr cells), neonatal jaundice, ‚Üë 2,3-BPG.', def: 'Extravascular hemolysis, echinocytes (burr cells), neonatal jaundice, ‚Üë 2,3-BPG.' },

            // --- MAHA (Microangiopathic Hemolytic Anemias) ---
            { category: 'MAHAs', term: 'Thrombotic Thrombocytopenic Purpura (TTP)', etiology: 'ADAMTS13 deficiency (often autoantibody) ‚Üí large vWF multimers.', findings: 'Pentad: fever, neuro, renal, MAHA, thrombocytopenia; schistocytes; normal PT/PTT.', def: 'Pentad: fever, neuro, renal, MAHA, thrombocytopenia; schistocytes; normal PT/PTT.' },
            { category: 'MAHAs', term: 'Hemolytic Uremic Syndrome (HUS)', etiology: 'Shiga toxin (E. coli O157:H7 or Shigella).', findings: 'Bloody diarrhea, acute renal failure predominant, MAHA with schistocytes, thrombocytopenia.', def: 'Bloody diarrhea, acute renal failure predominant, MAHA with schistocytes, thrombocytopenia.' },
            { category: 'MAHAs', term: 'Disseminated Intravascular Coagulation (DIC)', etiology: 'Systemic activation of coagulation (sepsis, trauma, obstetric, malignancy).', findings: 'Bleeding + thrombosis, ‚Üë PT/PTT, ‚Üì fibrinogen, ‚Üë D-dimer, schistocytes.', def: 'Bleeding + thrombosis, ‚Üë PT/PTT, ‚Üì fibrinogen, ‚Üë D-dimer, schistocytes.' },
            { category: 'MAHAs', term: 'HELLP Syndrome', etiology: 'Pregnancy complication (severe preeclampsia).', findings: 'Hemolysis, elevated LFTs, low platelets; RUQ pain; schistocytes.', def: 'Hemolysis, elevated LFTs, low platelets; RUQ pain; schistocytes.' },

            // --- BONE MARROW FAILURE ---
            { category: 'Bone Marrow Failure', term: 'Aplastic Anemia', etiology: 'Immune-mediated marrow failure (radiation, viruses, drugs).', findings: 'Pancytopenia with hypocellular (fatty) marrow.', def: 'Pancytopenia with hypocellular (fatty) marrow.' },
            { category: 'Bone Marrow Failure', term: 'Pure Red Cell Aplasia (PRCA)', etiology: 'Selective erythroid aplasia (parvovirus B19, thymoma, autoimmune).', findings: 'Anemia with very low reticulocytes; normal WBC/platelets.', def: 'Anemia with very low reticulocytes; normal WBC/platelets.' },
            { category: 'Bone Marrow Failure', term: 'Fanconi Anemia', etiology: 'AR DNA repair defect with chromosomal breakage.', findings: 'Pancytopenia, short stature, thumb/radial anomalies, hyperpigmentation.', def: 'Pancytopenia, short stature, thumb/radial anomalies, hyperpigmentation.' },
            { category: 'Bone Marrow Failure', term: 'Diamond-Blackfan Anemia', etiology: 'Congenital ribosomal protein defect.', findings: 'Macrocytic anemia in infancy, craniofacial anomalies, triphalangeal thumbs, ‚Üë HbF.', def: 'Macrocytic anemia in infancy, craniofacial anomalies, triphalangeal thumbs, ‚Üë HbF.' },

            // --- COAGULATION & PLATELETS ---
            { category: 'Coagulation & Platelets', term: 'Hemophilia A', etiology: 'Factor VIII deficiency (X-linked).', findings: 'Hemarthroses, ‚Üë PTT with normal bleeding time; mixing study corrects; ‚Üì factor VIII activity.', def: 'Hemarthroses, ‚Üë PTT with normal bleeding time; mixing study corrects; ‚Üì factor VIII activity.' },
            { category: 'Coagulation & Platelets', term: 'Hemophilia B', etiology: 'Factor IX deficiency (X-linked).', findings: 'Hemarthroses, ‚Üë PTT with normal bleeding time; mixing study corrects; ‚Üì factor IX activity.', def: 'Hemarthroses, ‚Üë PTT with normal bleeding time; mixing study corrects; ‚Üì factor IX activity.' },
            { category: 'Coagulation & Platelets', term: 'Von Willebrand Disease (vWD)', etiology: 'AD vWF quantitative/qualitative defect ‚Üí ‚Üì platelet adhesion and ‚Üì factor VIII.', findings: 'Mucocutaneous bleeding, ‚Üë bleeding time/PFA, sometimes ‚Üë PTT, abnormal ristocetin (corrects with plasma).', def: 'Mucocutaneous bleeding, ‚Üë bleeding time/PFA, sometimes ‚Üë PTT, abnormal ristocetin (corrects with plasma).' },
            { category: 'Coagulation & Platelets', term: 'Vitamin K Deficiency', etiology: 'Low vitamin K (warfarin, malabsorption, newborn).', findings: 'Bleeding with ‚Üë PT (early) and sometimes ‚Üë PTT; low factors II, VII, IX, X, C, S.', def: 'Bleeding with ‚Üë PT (early) and sometimes ‚Üë PTT; low factors II, VII, IX, X, C, S.' },
            { category: 'Coagulation & Platelets', term: 'Immune Thrombocytopenia (ITP)', etiology: 'Autoantibodies to GpIIb/IIIa ‚Üí splenic platelet destruction.', findings: 'Isolated thrombocytopenia, mucocutaneous bleeding, large platelets; ‚Üë megakaryocytes.', def: 'Isolated thrombocytopenia, mucocutaneous bleeding, large platelets; ‚Üë megakaryocytes.' },
            { category: 'Coagulation & Platelets', term: 'Bernard-Soulier Syndrome', etiology: 'GpIb deficiency (platelet adhesion).', findings: 'Giant platelets, thrombocytopenia, bleeding, abnormal ristocetin not corrected by plasma.', def: 'Giant platelets, thrombocytopenia, bleeding, abnormal ristocetin not corrected by plasma.' },
            { category: 'Coagulation & Platelets', term: 'Glanzmann Thrombasthenia', etiology: 'GpIIb/IIIa deficiency (platelet aggregation).', findings: 'Normal platelet count, bleeding, no aggregation with ADP/epinephrine; normal ristocetin.', def: 'Normal platelet count, bleeding, no aggregation with ADP/epinephrine; normal ristocetin.' },
            { category: 'Coagulation & Platelets', term: 'Factor V Leiden', etiology: 'Factor V mutation resistant to APC cleavage.', findings: 'Hypercoagulability (DVT/PE), normal PT/PTT.', def: 'Hypercoagulability (DVT/PE), normal PT/PTT.' },
            { category: 'Coagulation & Platelets', term: 'Antiphospholipid Syndrome (APS)', etiology: 'Antiphospholipid antibodies (lupus anticoagulant, anticardiolipin).', findings: 'Thrombosis + recurrent miscarriages, prolonged PTT (paradoxical).', def: 'Thrombosis + recurrent miscarriages, prolonged PTT (paradoxical).' },
            { category: 'Coagulation & Platelets', term: 'Heparin Induced Thrombocytopenia (HIT)', etiology: 'IgG against PF4-heparin complex.', findings: 'Platelet drop 5-10 days after heparin, thrombosis; positive PF4 antibody.', def: 'Platelet drop 5-10 days after heparin, thrombosis; positive PF4 antibody.' },

            // --- THROMBOLITIC DISORDERS ---
            { category: 'Thrombolitic Disorders', term: 'Thrombocytopenia', etiology: '-Platelet production (marrow failure, chemo, B12/folate)<br>-Destruction (immune, DIC/TTP/HUS)<br>-Splenic sequestration<br>-Dilutional (massive transfusion)', findings: '- Platelet count < 150,000/√¶L.<br>- Possible pseudothrombocytopenia from EDTA clumping.<br><br>- Petechiae and purpura.<br>- Mucocutaneous bleeding.', def: 'Low circulating platelet count.' },
            { category: 'Thrombolitic Disorders', term: 'Immune Thrombocytopenia (ITP)', etiology: '-IgG autoantibodies against platelet GPIIb/IIIa<br>-Splenic destruction', findings: '- Low platelet count.<br>- Increased Mean Platelet Volume (MPV).<br><br>- Epistaxis and gingival bleeding.<br>- Menorrhagia.', def: 'Immune-mediated platelet destruction.' },
            { category: 'Thrombolitic Disorders', term: 'von Willebrand Disease (vWD)', etiology: '-Quantitative or qualitative defect in vWF (usually inherited AD)<br>-Impaired platelet adhesion<br>-Factor VIII stabilization', findings: '- Decreased vWF:Ag (antigen) in Type 1 and 3.<br>- Low Ristocetin cofactor activity.<br>- Normal or prolonged aPTT.<br><br>- Heavy menstrual bleeding.<br>- Bleeding after dental or surgical procedures.', def: 'Defective platelet-vessel wall adhesion.' },
            { category: 'Thrombolitic Disorders', term: 'Bernard-Soulier Syndrome', etiology: '-AR defect of platelet GPIb<br>-Impaired adhesion to vWF (macrothrombocytopenia)', findings: '- Large platelets on peripheral smear.<br>- Non-response to Ristocetin in aggregation studies.<br><br>- Variable mucosal bleeding tendency.<br>- Prolonged bleeding from cuts.', def: 'GpIb receptor deficiency/dysfunction.' },
            { category: 'Thrombolitic Disorders', term: 'Glanzmann Thrombasthenia', etiology: '-AR defect of platelet GPIIb/IIIa<br>-Impaired platelet aggregation (no fibrinogen bridging)', findings: '- Normal platelet count.<br>- No aggregation with any agonist except Ristocetin.<br><br>- Severe mucocutaneous bleeding.<br>- Epistaxis and menorrhagia.', def: 'GpIIb/IIIa aggregation receptor deficiency.' },
            { category: 'Thrombolitic Disorders', term: 'Hemophilia A & B', etiology: '-X-linked recessive deficiency of factor VIII (A) or factor IX (B)<br>-Intrinsic pathway defect', findings: '- Prolonged aPTT that corrects with mixing study.<br>- Low activity of Factor VIII (A) or Factor IX (B).<br><br>- Hemarthrosis (bleeding into joints).<br>- Deep tissue muscle hematomas.', def: 'Inherited coagulation factor deficiency.' },
            { category: 'Thrombolitic Disorders', term: 'Factor XIII Deficiency', etiology: '-AR deficiency of factor XIII<br>-Impaired fibrin cross-linking (delayed bleeding, poor wound healing)', findings: '- Normal PT and aPTT screening tests.<br>- Decreased Factor XIII activity.<br><br>- Delayed wound hemorrhage (clot forms but fails).<br>- Umbilical stump bleeding in neonates.', def: 'Defective fibrin clot stabilization.' },
            { category: 'Thrombolitic Disorders', term: 'Vitamin K Deficiency', etiology: '-Decreased gamma-carboxylation of factors II, VII, IX, X<br>-Proteins C/S (malabsorption, antibiotics, newborns)', findings: '- Prolonged PT/INR and aPTT.<br>- Low Factors II, VII, IX, and X.<br><br>- Spontaneous bruising.<br>- Deep tissue or mucosal hemorrhage.', def: 'Impaired clotting factor synthesis.' },
            { category: 'Thrombolitic Disorders', term: 'Liver Disease', etiology: '-Decreased synthesis of clotting factors (and thrombopoietin)<br>-Impaired clearance of anticoagulants<br>-Often thrombocytopenia from hypersplenism', findings: '- Prolonged PT/INR and aPTT.<br>- Thrombocytopenia if splenomegaly is present.<br><br>- Oozing from puncture sites.<br>- Severe internal hemorrhaging.', def: 'Decreased synthesis of multiple factors.' },
            { category: 'Thrombolitic Disorders', term: 'Factor V Leiden', etiology: '-Inherited APC resistance due to factor V mutation<br>-Hypercoagulability (venous thrombosis)', findings: '- Resistance of Factor V to Protein C inactivation.<br>- Detected by modified APC-PT assay.<br><br>- Recurrent Venous Thromboembolism (VTE).<br>- Deep Vein Thrombosis (DVT).', def: 'Activated Protein C resistance.' },
            { category: 'Thrombolitic Disorders', term: 'Antiphospholipid Syndrome', etiology: '-Autoimmune antibodies (lupus anticoagulant, anticardiolipin, anti-Œ±2GPI)<br>-Hypercoagulability<br>-Pregnancy morbidity', findings: '- Prolonged aPTT that does not correct with mixing.<br>- Positive DRVVT test.<br><br>- Recurrent arterial/venous thrombosis.<br>- Repeated miscarriages.', def: 'Autoantibodies causing pathological clotting.' },
            { category: 'Thrombolitic Disorders', term: 'Disseminated Intravascular Coagulation (DIC)', etiology: '-Systemic coagulation activation (sepsis, trauma, malignancy, obstetric catastrophe)<br>-Consumption of platelets/factors<br>-Microthrombi<br>-Bleeding', findings: '- Prolonged PT/aPTT, Low fibrinogen.<br>- High D-dimer and schistocytes on smear.<br><br>- Simultaneous bleeding and clotting.<br>- Organ failure and hypovolemic shock.', def: 'Systemic activation and consumption.' },
            { category: 'Thrombolitic Disorders', term: 'HIT Syndrome', etiology: '-IgG against heparin-PF4 complex<br>-Platelet activation<br>-Thrombosis with thrombocytopenia', findings: '- 50% decline in platelet count during therapy.<br>- Positive Heparin-PF4 antibody assay.<br><br>- Paradoxical thrombosis 5-10 days after heparin.<br>- Skin necrosis at injection sites.', def: 'Heparin-PF4 antibody-mediated activation.' },
            { category: 'Thrombolitic Disorders', term: 'TTP / HUS', etiology: '-Thrombotic microangiopathy from platelet microthrombi<br>-ADAMTS13 deficiency (usually acquired autoantibody) OR endothelial injury, classically Shiga-toxin (EHEC) or complement-mediated (atypical HUS)', findings: '- Thrombocytopenia and schistocytes.<br>- Normal PT/aPTT and fibrinogen.<br><br>- Neurologic symptoms (altered mental status).<br>- Fever and renal dysfunction.', def: 'Platelet-rich microthrombi in vasculature.' },

            // --- HEMOSTASIS ESSENTIALS (MATCHING MODULE) ---
            { category: 'Hemostasis Essentials', term: 'Packed RBCs', def: 'Use for symptomatic anemia or acute blood loss; trigger Hgb <7 g/dL (often higher if ischemia/CAD/ongoing hemorrhage); <br><br>Goal: improve oxygen delivery, not clotting.' },
            { category: 'Hemostasis Essentials', term: 'Platelets', def: 'Use for bleeding risk from thrombocytopenia; trigger <10k/uL prophylaxis, <50k/uL active bleeding/procedure, <100k/uL neurosurgery/eye; <br><br>Goal: fix platelet number.' },
            { category: 'Hemostasis Essentials', term: 'Fresh Frozen Plasma (FFP)', def: 'Use for multiple clotting factor replacement; trigger elevated PT/INR and/or PTT with bleeding (liver disease, DIC, massive transfusion); also for warfarin major bleed if PCC unavailable; <br><br>Goal: replace missing factors.' },
            { category: 'Hemostasis Essentials', term: 'Cryoprecipitate', def: 'Use for low fibrinogen replacement; trigger fibrinogen <100-150 mg/dL (DIC, massive hemorrhage, postpartum hemorrhage); contains fibrinogen, VIII, vWF, XIII; <br><br>Goal: restore fibrinogen for stable clot formation.' },
            { category: 'Hemostasis Essentials', term: 'Granulocytes', def: 'Use for severe neutropenia with life-threatening infection; consider profound neutropenia with serious infection not responding to antimicrobials; <br><br>Goal: temporary neutrophil boost.' },
            { category: 'Hemostasis Essentials', term: 'Increased PT, normal PTT', def: 'Extrinsic pathway abnormality; points to warfarin (VII drops early), factor VII deficiency, early vitamin K deficiency; clue: PT only.' },
            { category: 'Hemostasis Essentials', term: 'Increased PTT, normal PT', def: 'Intrinsic pathway abnormality; points to hemophilia A (VIII), hemophilia B (IX), or heparin effect; clue: PTT only.' },
            { category: 'Hemostasis Essentials', term: 'Increased PT and PTT', def: 'Global/common pathway deficiency; points to DIC, severe liver failure, massive transfusion (dilutional), severe vitamin K deficiency; clue: everything prolonged.' },
            { category: 'Hemostasis Essentials', term: 'Normal PT/PTT, increased bleeding time', def: 'Primary hemostasis defect; points to vWD, uremia, aspirin/NSAIDs, inherited platelet dysfunction (Glanzmann, Bernard-Soulier); clue: factors fine, bleeding persists.' },
            { category: 'Hemostasis Essentials', term: 'Increased PTT that does not correct', def: 'Inhibitor present; points to lupus anticoagulant or factor VIII inhibitor; mixing rule: corrects = deficiency, no correction = inhibitor.' },
            { category: 'Hemostasis Essentials', term: 'Desmopressin (DDAVP)', def: 'Boosts endogenous vWF + factor VIII; best for vWD type 1 and mild hemophilia A; use for minor bleeding/procedural prophylaxis; <br><br>Goal: rapid temporary factor/adhesion boost.' },
            { category: 'Hemostasis Essentials', term: 'Protamine', def: 'Heparin reversal; best for unfractionated heparin; partial reversal for LMWH; <br><br>Goal: neutralize heparin immediately.' },
            { category: 'Hemostasis Essentials', term: 'Vitamin K', def: 'Reverse warfarin by restoring factor production; targets II, VII, IX, X (+ C, S); timing hours (new synthesis); major bleed: IV vitamin K + PCC (FFP if PCC unavailable); <br><br>Goal: restore vitamin K-dependent coagulation.' },
            { category: 'Hemostasis Essentials', term: 'Tranexamic acid', def: 'Antifibrinolytic to prevent clot breakdown; best for mucosal bleeding, menorrhagia, dental bleeding, trauma (early), postpartum hemorrhage protocols; <br><br>Goal: keep clots from lysing too quickly.' },
            { category: 'Hemostasis Essentials', term: 'Hydroxyurea', def: 'Utilized to increase HbF and reduce sickling; cytoreduction for PV; best for sickle cell disease (fewer VOC/ACS) and polycythemia vera (lower thrombosis via cell counts); <br><br>Goal: HbF up or counts down.' },

            // --- FOUNDATIONS: LABS ---
            { category: 'Foundations: Labs', term: 'Hemoglobin (Hb/Hgb) ', def: 'Measures direct hemoglobin concentration (O2-carrying protein)<br><br>Low = anemia. High = polycythemia.' },
            { category: 'Foundations: Labs', term: 'Hematocrit (Hct) ', def: 'Measures volume % of blood made up by RBCs<br><br>Low = anemia/hemodilution. High = polycythemia/dehydration.' },
            { category: 'Foundations: Labs', term: 'Red Blood Cell Count (RBC) ', def: 'Measures number of RBCs<br><br>High count with low MCV suggests thalassemia trait.' },
            { category: 'Foundations: Labs', term: 'Mean Corpuscular Volume (MCV) ', def: 'Measures average RBC size<br><br>Microcytic (<80), Normocytic (80‚Äì100), Macrocytic (>100).' },
            { category: 'Foundations: Labs', term: 'Mean Corpuscular Hemoglobin (MCH) ', def: 'Measures average hemoglobin mass per RBC<br><br>Low = hypochromia (pale cells).' },
            { category: 'Foundations: Labs', term: 'Mean Corpuscular Hemoglobin Concentration (MCHC) ', def: 'Measures average hemoglobin concentration within RBCs<br><br>High = hereditary spherocytosis (hyperchromic).' },
            { category: 'Foundations: Labs', term: 'Red Cell Distribution Width (RDW) ', def: 'Measures anisocytosis (variation in RBC size)<br><br>High in iron deficiency/megaloblastic. Often normal in thalassemia trait.' },
            { category: 'Foundations: Labs', term: 'Reticulocyte Count ', def: 'Measures % of immature RBCs with residual RNA, reflecting marrow output/response.' },
            { category: 'Foundations: Labs', term: 'Reticulocyte Index (RI) ', def: 'Evaluates marrow response corrected for degree of anemia<br><br>>2 = hyperproliferative (hemolysis/blood loss). <2 = hypoproliferative (production problem).' },
            { category: 'Foundations: Labs', term: 'Serum Ferritin ', def: 'Measures stored iron (iron reserves)<br><br>Low = iron deficiency (diagnostic). High = chronic disease/sideroblastic.' },
            { category: 'Foundations: Labs', term: 'Serum Iron ', def: 'Measures circulating iron bound to transferrin<br><br>Low in IDA/ACD. High in sideroblastic.' },
            { category: 'Foundations: Labs', term: 'Total Iron Binding Capacity (TIBC) ', def: 'Measures total transferrin binding capacity (indirect transferrin level)<br><br>High in iron deficiency. Low in chronic disease.' },
            { category: 'Foundations: Labs', term: 'Transferrin Saturation ', def: 'Measures % transferrin binding sites occupied by iron<br><br>Low in IDA. Can be high in sideroblastic/iron overload.' },
            { category: 'Foundations: Labs', term: 'Soluble Transferrin Receptor (sTfR) ', def: 'Measures cellular iron demand via transferrin receptor shedding<br><br>High in iron deficiency. Normal in ACD.' },
            { category: 'Foundations: Labs', term: 'Zinc Protoporphyrin (ZPP) ', def: 'Measures zinc incorporation into protoporphyrin when iron is unavailable for heme synthesis<br><br>High in IDA and lead poisoning.' },
            { category: 'Foundations: Labs', term: 'Serum B12 (Cobalamin) ', def: 'Measures circulating vitamin B12 level<br><br>Low in pernicious anemia, dietary deficiency.' },
            { category: 'Foundations: Labs', term: 'Serum Folate ', def: 'Measures folate level (body folate status)<br><br>Low in dietary deficiency, alcoholism.' },
            { category: 'Foundations: Labs', term: 'Methylmalonic Acid (MMA) ', def: 'Measures functional B12 deficiency (elevated when B12 deficient)<br><br>Normal in folate deficiency.' },
            { category: 'Foundations: Labs', term: 'Homocysteine ', def: 'Measures homocysteine elevation from impaired methylation<br><br>High in BOTH B12 and folate deficiencies.' },
            { category: 'Foundations: Labs', term: 'Serum Copper ', def: 'Measures copper level (deficiency can mimic B12 deficiency with macrocytosis + neuro symptoms).' },
            { category: 'Foundations: Labs', term: 'Anti-Intrinsic Factor / Parietal Cell Abs ', def: 'Detects autoimmune antibodies causing pernicious anemia (B12 malabsorption)<br><br>Positive supports pernicious anemia.' },
            { category: 'Foundations: Labs', term: 'Serum Haptoglobin ', def: 'Measures free hemoglobin-binding capacity<br><br>Decreased in intravascular hemolysis.' },
            { category: 'Foundations: Labs', term: 'Lactate Dehydrogenase (LDH) ', def: 'Measures cell breakdown/turnover marker<br><br>Increased in hemolysis and high cell turnover.' },
            { category: 'Foundations: Labs', term: 'Indirect Bilirubin ', def: 'Measures unconjugated bilirubin (heme breakdown)<br><br>Increased in hemolysis.' },
            { category: 'Foundations: Labs', term: 'Direct Antiglobulin Test (Coombs) ', def: 'Detects IgG and/or complement bound to RBCs<br><br>Positive in autoimmune hemolysis.' },
            { category: 'Foundations: Labs', term: 'Osmotic Fragility Test ', def: 'Measures RBC susceptibility to lysis in hypotonic saline<br><br>Increased in hereditary spherocytosis.' },
            { category: 'Foundations: Labs', term: 'G6PD Assay ', def: 'Measures G6PD enzyme activity<br><br>Low in G6PD deficiency (best checked after acute episode resolves).' },
            { category: 'Foundations: Labs', term: 'Hemoglobin Electrophoresis ', def: 'Separates and identifies hemoglobin variants/types<br><br>Diagnoses thalassemias and sickle cell.' },
            { category: 'Foundations: Labs', term: 'Carboxyhemoglobin ', def: 'Measures hemoglobin bound to carbon monoxide<br><br>Elevated in CO poisoning.' },
            { category: 'Foundations: Labs', term: 'Flow Cytometry (CD55/59) ', def: 'Evaluates RBCs for GPI-anchored proteins (CD55/CD59)<br><br>Absent/reduced in PNH.' },
            { category: 'Foundations: Labs', term: 'ABO/Rh Typing ', def: 'Determines blood type (ABO and Rh antigens) for transfusion compatibility.' },
            { category: 'Foundations: Labs', term: 'Antibody Screen ', def: 'Detects unexpected RBC alloantibodies (prevents delayed hemolytic transfusion reactions).' },
            { category: 'Foundations: Labs', term: 'HLA Antibody Testing ', def: 'Detects anti-HLA antibodies (risk for platelet refractoriness, helps prevent TRALI).' },
            { category: 'Foundations: Labs', term: 'BNP (B-type Natriuretic Peptide) ', def: 'Measures cardiac wall stretch/strain<br><br>High in TACO/heart failure, typically not high in TRALI.' },
            { category: 'Foundations: Labs', term: 'PT (Prothrombin Time) ', def: 'Measures extrinsic + common coagulation pathway (VII, X, V, II, fibrinogen)<br><br>Prolonged in warfarin use, liver disease, DIC.' },
            { category: 'Foundations: Labs', term: 'aPTT (Activated Partial Thromboplastin Time) ', def: 'Measures intrinsic + common pathway (XII, XI, IX, VIII, X, V, II, fibrinogen)<br><br>Used for heparin monitoring.' },
            { category: 'Foundations: Labs', term: 'Mixing Study ', def: 'Evaluates prolonged PT/aPTT to distinguish factor deficiency (correction) vs inhibitor (no correction).' },
            { category: 'Foundations: Labs', term: 'Fibrinogen Level ', def: 'Measures clotting factor I level<br><br>Low in DIC and severe liver disease; low levels may require cryoprecipitate.' },
            { category: 'Foundations: Labs', term: 'D-Dimer ', def: 'Measures fibrin degradation products<br><br>Elevated with clot breakdown (DVT/PE) and DIC.' },
            { category: 'Foundations: Labs', term: 'Bleeding Time / PFA (Platelet Function Assay) ', def: 'Evaluates platelet function/primary hemostasis (platelet adhesion/aggregation).' },
            { category: 'Foundations: Labs', term: 'Ristocetin Cofactor Assay ', def: 'Measures vWF activity (platelet agglutination via GPIb)<br><br>Low in von Willebrand disease.' },
            { category: 'Foundations: Labs', term: 'Platelet Bacterial Culture ', def: 'Detects bacterial contamination in platelet products (prevents transfusion-related sepsis risk).' },
            { category: 'Foundations: Labs', term: 'Parvovirus B19 PCR ', def: 'Detects active parvovirus infection (aplastic crisis, pure red cell aplasia; giant pronormoblasts).' },
            { category: 'Foundations: Labs', term: 'Bone Marrow Biopsy ', def: 'Evaluates marrow architecture/cellularity and abnormal infiltrates<br><br>Findings: fatty marrow (aplastic), ringed sideroblasts (sideroblastic), giant pronormoblasts (parvo), absent iron stores (IDA).' },
            { category: 'Foundations: Labs', term: 'Lead Level ', def: 'Measures blood lead concentration<br><br>High in lead poisoning (can cause microcytic anemia).' },
            { category: 'Foundations: Labs', term: 'HIV Serology ', def: 'Detects HIV infection (can cause cytopenias/immune dysregulation).' },
            { category: 'Foundations: Labs', term: 'Hepatitis Serologies ', def: 'Detects hepatitis B/C infection or immunity (can be associated with aplastic anemia).' },
            { category: 'Foundations: Labs', term: 'EBV Serology ', def: 'Detects EBV infection status (can be associated with aplastic anemia).' },

            // --- PHARMACOLOGY ---
            { category: 'Pharmacology', term: 'Warfarin', def: 'Vit K Antagonist. Teratogenic. Skin necrosis risk. Monitor INR.' },
            { category: 'Pharmacology', term: 'Heparin (Unfractionated Heparin - UFH)', def: 'Potentiates Antithrombin III. Monitor PTT. Reversal: Protamine.' },
            { category: 'Pharmacology', term: 'Low Molecular Weight Heparin (LMWH)', def: 'Anti-Xa activity. Renal clearance. Lower HIT risk. No routine monitoring.' },
            { category: 'Pharmacology', term: 'Aspirin (ASA)', def: 'Irreversible COX-1 inhibition. Blocks TXA2 production.' },
            { category: 'Pharmacology', term: 'Clopidogrel', def: 'ADP receptor (P2Y12) blocker. Antiplatelet.' },
            { category: 'Pharmacology', term: 'Tissue Plasminogen Activator (tPA)', def: 'Converts Plasminogen to Plasmin. Fibrinolytic &quot;Clot Buster&quot;.' },
            { category: 'Pharmacology', term: 'Direct Oral Anticoagulants (DOACs)', def: 'Dabigatran (IIa inhibitor), Rivaroxaban/Apixaban (Xa inhibitors).' },

            // --- PARASITES ---
            { category: 'Module: Parasites', term: 'Babesiosis', etiology: 'Babesia microti via Ixodes tick.', findings: 'Maltese cross in RBCs, hemolytic anemia, fever; NE USA.', def: 'Maltese cross in RBCs, hemolytic anemia, fever; NE USA.' },
            { category: 'Module: Parasites', term: 'Plasmodium Falciparum', etiology: 'Plasmodium falciparum infection.', findings: 'Banana-shaped gametocytes, severe/cerebral malaria, high parasitemia.', def: 'Banana-shaped gametocytes, severe/cerebral malaria, high parasitemia.' },
            { category: 'Module: Parasites', term: 'Plasmodium Vivax/Ovale', etiology: 'Plasmodium vivax or ovale infection.', findings: 'Hypnozoites causing relapse, enlarged RBCs with Schuffner dots.', def: 'Hypnozoites causing relapse, enlarged RBCs with Schuffner dots.' },
            { category: 'Module: Parasites', term: 'Plasmodium Malariae', etiology: 'Plasmodium malariae infection.', findings: 'Band-form trophozoites, quartan fever (72-hr cycle).', def: 'Band-form trophozoites, quartan fever (72-hr cycle).' },
            { category: 'Module: Parasites', term: 'Wuchereria bancrofti', etiology: 'Filarial nematode infection transmitted by mosquitoes.', findings: 'Lymphatic filariasis with elephantiasis; microfilariae on night blood smear.', def: 'Lymphatic filariasis with elephantiasis; microfilariae on night blood smear.' },

            // --- FOUNDATIONS: RBC MORPHOLOGY (NEWLY ADDED) ---
            { category: 'Foundations: RBC Morphology', term: 'Normal Morphology', def: 'Biconcave disc, Normocytic (normal size), Normochromic (normal color). Flexible.' },
            { category: 'Foundations: RBC Morphology', term: 'Microcytosis', def: 'Small cells (MCV < 80 fL), often Hypochromic.<br><br>Associated with: Iron Deficiency, Thalassemia, ACD.' },
            { category: 'Foundations: RBC Morphology', term: 'Macrocytosis', def: 'Large cells (MCV > 100 fL).<br><br>Associated with: B12/Folate deficiency (DNA maturation defect), Alcoholism, Liver disease.' },
            { category: 'Foundations: RBC Morphology', term: 'Polychromasia', def: 'Bluish-gray tint (residual RNA), often larger.<br><br>Associated with: Reticulocytosis (marrow response).' },
            { category: 'Foundations: RBC Morphology', term: 'Hypochromia', def: 'Increased central pallor (>1/3 diameter). &quot;Onion ring&quot; look.<br><br>Associated with: Iron Deficiency, Thalassemia.' },
            { category: 'Foundations: RBC Morphology', term: 'Spherocytes', def: 'Spherical, no central pallor.<br><br>Associated with: Hereditary Spherocytosis (membrane defect) or Autoimmune Hemolysis (macrophage bite).' },
            { category: 'Foundations: RBC Morphology', term: 'Target Cells (Codocytes)', def: 'Bullseye appearance (membrane excess).<br><br>Associated with: Thalassemia, Liver Disease, HbC, Asplenia.' },
            { category: 'Foundations: RBC Morphology', term: 'Schistocytes', def: 'Fragmented/Helmet cells.<br><br>Associated with: Mechanical damage (MAHA: TTP, HUS, DIC) or mechanical valves.' },
            { category: 'Foundations: RBC Morphology', term: 'Echinocytes (Burr Cells)', def: 'Regular, short spikes.<br><br>Associated with: Uremia (Renal Failure), Liver Disease, Artifact.' },
            { category: 'Foundations: RBC Morphology', term: 'Elliptocytes', def: 'Elongated oval shape.<br><br>Associated with: Hereditary elliptocytosis, thalassemia and hemoglobin disorders, and severe iron deficiency.' },            
            { category: 'Foundations: RBC Morphology', term: 'Acanthocytes (Spur Cells)', def: 'Irregular, long spikes.<br><br>Associated with: Severe Liver Disease, Abetalipoproteinemia (Lipid imbalance).' },
            { category: 'Foundations: RBC Morphology', term: 'Teardrop Cells (Dacrocytes)', def: 'Teardrop shape.<br><br>Associated with: Bone Marrow Infiltration (Myelofibrosis), Thalassemia.' },
            { category: 'Foundations: RBC Morphology', term: 'Sickle Cells (Drepanocytes)', def: 'Crescent/Sickle shape.<br><br>Associated with: Sickle Cell Disease (HbS polymerization under low O2).' },
            { category: 'Foundations: RBC Morphology', term: 'Stomatocytes', def: 'Slit-like &quot;fish mouth&quot; central pallor.<br><br>Associated with: Hereditary Stomatocytosis, Alcoholism, Liver Disease.' },
            { category: 'Foundations: RBC Morphology', term: 'Bite Cells', def: 'Semicircular bite removed.<br><br>Associated with: G6PD Deficiency (Macrophage pits Heinz bodies).' },
            { category: 'Foundations: RBC Morphology', term: 'Howell-Jolly Bodies', def: 'Small, round, blue/purple nuclear remnant.<br><br>Associated with: Splenectomy or functional asplenia.' },
            { category: 'Foundations: RBC Morphology', term: 'Basophilic Stippling', def: 'Fine blue granules (ribosomes/RNA) throughout cell.<br><br>Associated with: Lead Poisoning, Thalassemia, Alcohol.' },
            { category: 'Foundations: RBC Morphology', term: 'Rouleaux Formation', def: 'RBCs stacked like coins.<br><br>Associated with: Multiple Myeloma, chronic inflammation (Excess proteins neutralize charge).' },
            { category: 'Foundations: RBC Morphology', term: 'Agglutination', def: 'Clumping of RBCs into irregular masses.<br><br>Associated with: Cold Agglutinin Disease (IgM antibodies).' },
            { category: 'Foundations: RBC Morphology', term: 'Heinz Bodies', def: 'Denatured hemoglobin (requires supravital stain).<br><br>Associated with: G6PD Deficiency.' },
            { category: 'Foundations: RBC Morphology', term: 'Pappenheimer Bodies', def: 'Iron granules (Perls stain).<br><br>Associated with: Sideroblastic anemia, Post-splenectomy.' }
        ];

const PLAIN_MORPH_BASE = 'https://tayner35.github.io/HemeLymphE1-Images/Morphology_Plain_Images/';

const IMAGE_BANK_DATA = [
             // --- RBC Morphology ---
            { id: 'img_rbc_01', src: 'https://tayner35.github.io/HemeLymphE1-Images/RBC_Morphology/Slide1.jpeg', title: 'Normal Erythrocyte', desc: 'Biconcave disc-shaped red blood cell optimized for gas exchange and deformability.' },
            { id: 'img_rbc_02', src: 'https://tayner35.github.io/HemeLymphE1-Images/RBC_Morphology/Slide2.jpeg', title: 'Normal Peripheral Blood Smear', desc: 'Normocytic, normochromic RBCs with a segmented neutrophil and platelets.' },
            { id: 'img_rbc_03', src: 'https://tayner35.github.io/HemeLymphE1-Images/RBC_Morphology/Slide3.jpeg', title: 'Cellular Bone Marrow', desc: 'Bone marrow with hematopoietic cells interspersed with adipocytes and adjacent bone.' },
            { id: 'img_rbc_04', src: 'https://tayner35.github.io/HemeLymphE1-Images/RBC_Morphology/Slide4.jpeg', title: 'Cellular Marrow with Megakaryocytes', desc: 'Trabecular bone with cellular marrow and megakaryocytes, the platelet-producing precursors.' },
            { id: 'img_rbc_05', src: 'https://tayner35.github.io/HemeLymphE1-Images/RBC_Morphology/Slide5.jpeg', title: 'Aplastic (Hypocellular) Bone Marrow', desc: 'Markedly decreased hematopoietic cells with replacement by fat, consistent with aplastic anemia.' },
            { id: 'img_rbc_06', src: 'https://tayner35.github.io/HemeLymphE1-Images/RBC_Morphology/Slide6.jpeg', title: 'Normal Bone Marrow Aspirate', desc: 'Marrow aspirate showing a normal mixture of hematopoietic precursors across lineages.' },
            { id: 'img_rbc_07', src: 'https://tayner35.github.io/HemeLymphE1-Images/RBC_Morphology/Slide7.jpeg', title: 'Erythroid Maturation (Marrow Aspirate)', desc: 'Erythroid precursors progressing from immature forms to later stages with nuclear condensation and increased hemoglobinization.' },
            { id: 'img_rbc_08', src: 'https://tayner35.github.io/HemeLymphE1-Images/RBC_Morphology/Slide8.jpeg', title: 'Megaloblastic Marrow (Vitamin B12 Deficiency)', desc: 'Nuclear-cytoplasmic asynchrony from impaired DNA synthesis, producing megaloblastic maturation.' },
            { id: 'img_rbc_09', src: 'https://tayner35.github.io/HemeLymphE1-Images/RBC_Morphology/Slide9.jpeg', title: 'Ring Sideroblasts (Iron Stain)', desc: 'Erythroid precursors with perinuclear iron-laden mitochondria forming a ring on Prussian blue stain.' },
            { id: 'img_rbc_10', src: 'https://tayner35.github.io/HemeLymphE1-Images/RBC_Morphology/Slide10.jpeg', title: 'Reticulocyte (Supravital Stain)', desc: 'Immature RBC with residual ribosomal RNA visible as a reticular network on supravital stain.' },
            { id: 'img_rbc_11', src: 'https://tayner35.github.io/HemeLymphE1-Images/RBC_Morphology/Slide11.jpeg', title: 'Normal RBCs: Normocytic, Normochromic', desc: 'Red cells of normal size and hemoglobinization with appropriate central pallor.' },
            { id: 'img_rbc_12', src: 'https://tayner35.github.io/HemeLymphE1-Images/RBC_Morphology/Slide12.jpeg', title: 'Biconcave Disc Appearance', desc: 'Typical RBC morphology with central pallor reflecting the biconcave disc shape.' },
            { id: 'img_rbc_13', src: 'https://tayner35.github.io/HemeLymphE1-Images/RBC_Morphology/Slide13.jpeg', title: 'Infant vs Adult RBC Size', desc: 'Physiologic macrocytosis of infancy: infant RBCs are larger on average than adult RBCs (higher MCV).' },
            { id: 'img_rbc_14', src: 'https://tayner35.github.io/HemeLymphE1-Images/RBC_Morphology/Slide14.jpeg', title: 'Normal Newborn vs Adult RBCs', desc: 'Comparison of normal newborn and adult blood demonstrating expected differences in RBC size.' },
            { id: 'img_rbc_15', src: 'https://tayner35.github.io/HemeLymphE1-Images/RBC_Morphology/Slide15.jpeg', title: 'Megaloblastic Anemia: Macroovalocytes', desc: 'Macrocytic anemia with oval macrocytes (macroovalocytes), typical of B12 or folate deficiency.' },
            { id: 'img_rbc_16', src: 'https://tayner35.github.io/HemeLymphE1-Images/RBC_Morphology/Slide16.jpeg', title: 'Megaloblastic Anemia with Hypersegmented Neutrophil', desc: 'Macrocytosis and anisocytosis with a hypersegmented neutrophil, strongly suggestive of megaloblastic anemia.' },
            { id: 'img_rbc_17', src: 'https://tayner35.github.io/HemeLymphE1-Images/RBC_Morphology/Slide17.jpeg', title: 'Microcytic Hypochromic Anemia', desc: 'Small RBCs with increased central pallor consistent with iron deficiency pattern.' },
            { id: 'img_rbc_18', src: 'https://tayner35.github.io/HemeLymphE1-Images/RBC_Morphology/Slide18.jpeg', title: 'Hypochromic vs Normochromic RBCs', desc: 'Hypochromic RBCs show increased central pallor compared with normochromic RBCs.' },
            { id: 'img_rbc_19', src: 'https://tayner35.github.io/HemeLymphE1-Images/RBC_Morphology/Slide19.jpeg', title: 'Hemolytic Anemia: Mixed Morphology', desc: 'Polychromasia (reticulocytosis) with spherocytes and schistocytes, consistent with active hemolysis.' },
            { id: 'img_rbc_20', src: 'https://tayner35.github.io/HemeLymphE1-Images/RBC_Morphology/Slide20.jpeg', title: 'Hereditary Spherocytosis', desc: 'Spherocytes are round, dense RBCs lacking central pallor due to membrane loss and decreased surface area-to-volume ratio.' },
            { id: 'img_rbc_21', src: 'https://tayner35.github.io/HemeLymphE1-Images/RBC_Morphology/Slide21.jpeg', title: 'Hereditary Elliptocytosis', desc: 'Numerous elliptocytes (elongated oval RBCs) from inherited membrane skeleton defects.' },
            { id: 'img_rbc_22', src: 'https://tayner35.github.io/HemeLymphE1-Images/RBC_Morphology/Slide22.jpeg', title: 'Macroovalocyte (Megaloblastic Anemia)', desc: 'Large oval RBC typical of megaloblastic anemia due to impaired DNA synthesis.' },
            { id: 'img_rbc_23', src: 'https://tayner35.github.io/HemeLymphE1-Images/RBC_Morphology/Slide23.jpeg', title: 'Iron Deficiency: Anisopoikilocytosis', desc: 'Anisocytosis (size variation) and poikilocytosis (shape variation), commonly seen in iron deficiency anemia.' },
            { id: 'img_rbc_24', src: 'https://tayner35.github.io/HemeLymphE1-Images/RBC_Morphology/Slide24.jpeg', title: 'Target Cells (Codocytes)', desc: 'RBCs with central hemoglobinization surrounded by pallor and a peripheral rim; seen in thalassemias and liver disease.' },
            { id: 'img_rbc_25', src: 'https://tayner35.github.io/HemeLymphE1-Images/RBC_Morphology/Slide25.jpeg', title: 'Thalassemia Major', desc: 'Peripheral smear with target cells and numerous nucleated RBCs (normoblasts) due to severe ineffective erythropoiesis/hemolysis.' },
            { id: 'img_rbc_26', src: 'https://tayner35.github.io/HemeLymphE1-Images/RBC_Morphology/Slide26.jpeg', title: 'Hereditary Spherocytosis (Spherocytes)', desc: 'Multiple spherocytes with reduced/absent central pallor, consistent with hereditary spherocytosis.' },
            { id: 'img_rbc_27', src: 'https://tayner35.github.io/HemeLymphE1-Images/RBC_Morphology/Slide27.jpeg', title: 'Spherocytes', desc: 'Spherocytes are round, hyperchromic-appearing RBCs without central pallor; seen in hereditary spherocytosis and autoimmune hemolytic anemia.' },
            { id: 'img_rbc_28', src: 'https://tayner35.github.io/HemeLymphE1-Images/RBC_Morphology/Slide28.jpeg', title: 'Hemolytic Anemia with Spherocytes', desc: 'Polychromasia with spherocytes indicates reticulocytosis plus spherocytic hemolysis (e.g., immune hemolysis or membrane disorders).' },
            { id: 'img_rbc_29', src: 'https://tayner35.github.io/HemeLymphE1-Images/RBC_Morphology/Slide29.jpeg', title: 'Microangiopathic Hemolytic Anemia (MAHA)', desc: 'Schistocytes from intravascular shearing with polychromasia reflecting increased reticulocytes (e.g., TTP, HUS, DIC, mechanical valves).' },
            { id: 'img_rbc_30', src: 'https://tayner35.github.io/HemeLymphE1-Images/RBC_Morphology/Slide30.jpeg', title: 'Microangiopathic Hemolytic Anemia', desc: 'Fragmented RBCs (schistocytes) consistent with mechanical destruction in the microvasculature.' },
            { id: 'img_rbc_31', src: 'https://tayner35.github.io/HemeLymphE1-Images/RBC_Morphology/Slide31.jpeg', title: 'MAHA with Schistocytes and Spherocytes', desc: 'Schistocytes with secondary spherocytes can occur in severe hemolysis where fragmentation and membrane loss coexist.' },
            { id: 'img_rbc_32', src: 'https://tayner35.github.io/HemeLymphE1-Images/RBC_Morphology/Slide32.jpeg', title: 'Echinocytes (Burr Cells)', desc: 'RBCs with short, uniform projections; associated with uremia, pyruvate kinase deficiency, or smear artifact.' },
            { id: 'img_rbc_33', src: 'https://tayner35.github.io/HemeLymphE1-Images/RBC_Morphology/Slide33.jpeg', title: 'Acanthocytes (Spur Cells)', desc: 'RBCs with irregular, variably sized spicules; classically seen in severe liver disease and abetalipoproteinemia.' },
            { id: 'img_rbc_34', src: 'https://tayner35.github.io/HemeLymphE1-Images/RBC_Morphology/Slide34.jpeg', title: 'Teardrop Cells (Dacrocytes)', desc: 'Teardrop-shaped RBCs often seen with marrow fibrosis or infiltration (myelofibrosis/myelophthisis).' },
            { id: 'img_rbc_35', src: 'https://tayner35.github.io/HemeLymphE1-Images/RBC_Morphology/Slide35.jpeg', title: 'Sickle Cell Disease: Sickle Cells (Drepanocytes)', desc: 'Crescent-shaped RBCs due to polymerization of deoxygenated HbS, characteristic of sickle cell disease.' },
            { id: 'img_rbc_36', src: 'https://tayner35.github.io/HemeLymphE1-Images/RBC_Morphology/Slide36.jpeg', title: 'Sickled RBC in Capillary', desc: 'Sickled erythrocyte interacting with endothelium in microvasculature, illustrating vaso-occlusion.' },
            { id: 'img_rbc_37', src: 'https://tayner35.github.io/HemeLymphE1-Images/RBC_Morphology/Slide37.jpeg', title: 'Howell‚ÄìJolly Bodies (Post-splenectomy)', desc: 'Small basophilic nuclear DNA remnants in RBCs from decreased splenic clearance; target cells may also be present with asplenia/hyposplenia.' },
            { id: 'img_rbc_38', src: 'https://tayner35.github.io/HemeLymphE1-Images/RBC_Morphology/Slide38.jpeg', title: 'Heinz Bodies (Supravital Stain)', desc: 'Denatured hemoglobin inclusions visible on supravital staining, seen with oxidative stress such as G6PD deficiency.' },
            { id: 'img_rbc_39', src: 'https://tayner35.github.io/HemeLymphE1-Images/RBC_Morphology/Slide39.jpeg', title: 'Basophilic Stippling (Œ≤-Thalassemia Minor)', desc: 'Aggregated ribosomal RNA causing coarse basophilic stippling; seen in thalassemias and lead poisoning.' },
            { id: 'img_rbc_40', src: 'https://tayner35.github.io/HemeLymphE1-Images/RBC_Morphology/Slide40.jpeg', title: 'Pappenheimer Bodies (Siderotic Granules)', desc: 'Iron-containing RBC inclusions; confirmed with iron stain and seen in sideroblastic states and post-splenectomy.' },
            { id: 'img_rbc_41', src: 'https://tayner35.github.io/HemeLymphE1-Images/RBC_Morphology/Slide41.jpeg', title: 'Normoblasts (Nucleated RBCs) in Hemolysis', desc: 'Nucleated RBCs in peripheral blood reflect marked erythropoietic stress, as in brisk hemolysis or severe hypoxia.' },
            { id: 'img_rbc_42', src: 'https://tayner35.github.io/HemeLymphE1-Images/RBC_Morphology/Slide42.jpeg', title: 'Hemolytic Disease of the Newborn', desc: 'Numerous nucleated RBCs indicating severe neonatal hemolysis with increased marrow output/extramedullary hematopoiesis.' },
            { id: 'img_rbc_43', src: 'https://tayner35.github.io/HemeLymphE1-Images/RBC_Morphology/Slide43.jpeg', title: 'Rouleaux Formation (Plasma Cell Myeloma)', desc: 'Stack-of-coins RBC aggregation due to increased plasma proteins (immunoglobulins) reducing zeta potential, classically in multiple myeloma.' },

            // --- Morphology: Plain Images ---
            { id: 'img_plain_acanthocytes', src: `${PLAIN_MORPH_BASE}Acanthocytes.png`, title: 'Acanthocytes (Spur Cells)', desc: 'Irregular, thorny RBCs with uneven spicules.', appearance: 'RBCs with irregular, variably spaced spicules of different lengths.', conditions: ['Severe liver disease', 'Abetalipoproteinemia'], mechanism: 'Altered membrane lipid composition (excess cholesterol) produces spicules.' },
            { id: 'img_plain_anisocytosis', src: `${PLAIN_MORPH_BASE}Anisocytosis.png`, title: 'Anisocytosis', desc: 'Marked variation in RBC size.', appearance: 'RBC population with noticeable size variability.', conditions: ['Iron deficiency anemia', 'Megaloblastic anemia', 'Thalassemia trait'], mechanism: 'Disordered erythropoiesis creates mixed cell sizes.' },
            { id: 'img_plain_banana_gametocytes', src: `${PLAIN_MORPH_BASE}Banana-shaped%20Gametocytes.png`, title: 'Banana-shaped Gametocytes', desc: 'Crescent gametocytes within RBCs.', appearance: 'Elongated, curved gametocytes inside infected RBCs.', conditions: ['Plasmodium falciparum malaria'], mechanism: 'P. falciparum gametocyte maturation elongates and distorts the host RBC.' },
            { id: 'img_plain_band_forms', src: `${PLAIN_MORPH_BASE}Band%20Forms.png`, title: 'Band Forms (P. malariae)', desc: 'Band-shaped trophozoites across RBCs.', appearance: 'Band-like parasite stretching across the RBC cytoplasm.', conditions: ['Plasmodium malariae malaria'], mechanism: 'Trophozoite stage of P. malariae grows in a band form within the RBC.' },
            { id: 'img_plain_barr_body', src: `${PLAIN_MORPH_BASE}Barr%20Body.png`, title: 'Barr Body', desc: 'Drumstick nuclear appendage in neutrophils.', appearance: 'Small drumstick-like nuclear appendage on a neutrophil nucleus.', conditions: [], mechanism: 'X chromosome inactivation condenses into a Barr body.' },
            { id: 'img_plain_basophilic_stippling', src: `${PLAIN_MORPH_BASE}Basophilic%20Stipling.png`, title: 'Basophilic Stippling', desc: 'Blue granules dispersed through RBCs.', appearance: 'Fine or coarse blue cytoplasmic granules throughout RBCs.', conditions: ['Lead poisoning', 'Thalassemia', 'Sideroblastic anemia', 'Alcohol use'], mechanism: 'Aggregated ribosomal RNA from impaired heme synthesis or ribosome degradation.' },
            { id: 'img_plain_dacrocytes', src: `${PLAIN_MORPH_BASE}Dacrocytes.png`, title: 'Dacrocytes (Teardrop Cells)', desc: 'Teardrop-shaped RBCs.', appearance: 'RBCs tapered at one end, giving a teardrop shape.', conditions: ['Myelofibrosis / marrow infiltration', 'Thalassemia'], mechanism: 'Mechanical distortion as cells traverse fibrotic or infiltrated marrow.' },
            { id: 'img_plain_echinocytes', src: `${PLAIN_MORPH_BASE}Echinocytes.png`, title: 'Echinocytes (Burr Cells)', desc: 'RBCs with short, uniform projections.', appearance: 'Evenly spaced, short surface projections on RBCs.', conditions: ['Uremia / chronic kidney disease', 'Pyruvate kinase deficiency', 'Liver disease'], mechanism: 'ATP depletion or membrane lipid changes cause crenation; can be artifactual.' },
            { id: 'img_plain_elliptocytes', src: `${PLAIN_MORPH_BASE}Elliptocytes.png`, title: 'Elliptocytes (Pencil Cells)', desc: 'Elongated oval RBCs.', appearance: 'Elliptical or pencil-shaped RBCs.', conditions: ['Hereditary elliptocytosis'], mechanism: 'Membrane skeleton defects lead to elongated cells.' },
            { id: 'img_plain_heinz_bodies', src: `${PLAIN_MORPH_BASE}Heinz%20Bodies.png`, title: 'Heinz Bodies', desc: 'Denatured hemoglobin inclusions.', appearance: 'Dark intracellular inclusions seen on supravital stain.', conditions: ['G6PD deficiency'], mechanism: 'Oxidative stress denatures hemoglobin, forming precipitates.' },
            { id: 'img_plain_howell_jolly', src: `${PLAIN_MORPH_BASE}Howell-Jolly%20Bodies.png`, title: 'Howell-Jolly Bodies', desc: 'Single nuclear DNA remnant in RBCs.', appearance: 'Round, dark basophilic inclusion within an RBC.', conditions: ['Post-splenectomy', 'Functional asplenia'], mechanism: 'Failure of splenic filtration allows nuclear remnants to persist.' },
            { id: 'img_plain_hypersegmented', src: `${PLAIN_MORPH_BASE}Hypersegmented%20Neutrophils.png`, title: 'Hypersegmented Neutrophils', desc: 'Neutrophils with six or more lobes.', appearance: 'Neutrophils with excessively segmented nuclei.', conditions: ['Vitamin B12 deficiency', 'Folate deficiency'], mechanism: 'Impaired DNA synthesis delays nuclear maturation.' },
            { id: 'img_plain_large_platelets', src: `${PLAIN_MORPH_BASE}Large%20Platelets.png`, title: 'Large Platelets', desc: 'Oversized platelets in peripheral smear.', appearance: 'Platelets comparable in size to RBCs or larger.', conditions: ['Immune thrombocytopenia (ITP)'], mechanism: 'Increased platelet turnover releases young, larger platelets.' },
            { id: 'img_plain_macrocytic', src: `${PLAIN_MORPH_BASE}Macrocytic.png`, title: 'Macrocytosis (Macrocytic RBCs)', desc: 'RBCs larger than normal.', appearance: 'Enlarged RBCs with increased MCV, often oval.', conditions: ['Vitamin B12 deficiency', 'Folate deficiency', 'Alcoholism', 'Liver disease', 'Copper deficiency', 'Diamond-Blackfan anemia'], mechanism: 'Impaired DNA synthesis or membrane lipid changes lead to oversized cells.' },
            { id: 'img_plain_microcytic', src: `${PLAIN_MORPH_BASE}Microcytic.png`, title: 'Microcytosis (Microcytic RBCs)', desc: 'Small RBCs with increased central pallor.', appearance: 'RBCs smaller than normal, often hypochromic.', conditions: ['Iron deficiency anemia', 'Thalassemia', 'Anemia of chronic disease', 'Lead poisoning', 'Sideroblastic anemia', 'Copper deficiency'], mechanism: 'Reduced hemoglobin synthesis results in extra cell divisions and smaller cells.' },
            { id: 'img_plain_nucleated_rbcs', src: `${PLAIN_MORPH_BASE}Nucleated%20RBCs.png`, title: 'Nucleated RBCs', desc: 'Immature RBCs with nuclei in peripheral blood.', appearance: 'RBC precursors retain nuclei on smear.', conditions: ['Thalassemia major', 'Hemolytic disease of the newborn', 'Severe hemolysis or hypoxia'], mechanism: 'Marrow stress or extramedullary hematopoiesis releases immature RBCs.' },
            { id: 'img_plain_pappenheimer', src: `${PLAIN_MORPH_BASE}Pappenheimer%20Bodies.png`, title: 'Pappenheimer Bodies', desc: 'Iron-containing granules in RBCs.', appearance: 'Small, irregular basophilic granules in RBCs.', conditions: ['Sideroblastic anemia', 'Post-splenectomy'], mechanism: 'Excess iron persists as granules; spleen normally removes them.' },
            { id: 'img_plain_ring_forms', src: `${PLAIN_MORPH_BASE}Ring%20Forms.png`, title: 'Ring Forms (Malaria)', desc: 'Ring-shaped intraerythrocytic parasites.', appearance: 'Delicate ring-shaped trophozoites within RBCs.', conditions: ['Plasmodium falciparum malaria'], mechanism: 'Early intraerythrocytic stage of malaria parasites forms a ring.' },
            { id: 'img_plain_rouleaux', src: `${PLAIN_MORPH_BASE}Rouleaux%20Formations.png`, title: 'Rouleaux Formation', desc: 'Stack-of-coins RBC aggregation.', appearance: 'RBCs aligned in linear stacks.', conditions: ['Multiple myeloma', 'Chronic inflammation'], mechanism: 'Elevated plasma proteins reduce zeta potential, promoting stacking.' },
            { id: 'img_plain_schistocytes', src: `${PLAIN_MORPH_BASE}Schistocytes.png`, title: 'Schistocytes', desc: 'Fragmented RBCs (helmet cells).', appearance: 'Irregular RBC fragments with sharp edges.', conditions: ['Thrombotic thrombocytopenic purpura (TTP)', 'Hemolytic uremic syndrome (HUS)', 'Disseminated intravascular coagulation (DIC)', 'HELLP syndrome', 'Mechanical heart valves'], mechanism: 'Shearing of RBCs by fibrin strands or prosthetic surfaces.' },
            { id: 'img_plain_schuffner', src: `${PLAIN_MORPH_BASE}Sch%E2%80%99fner%20Dots.png`, title: 'Schuffner Dots', desc: 'Fine stippling in infected RBCs.', appearance: 'Fine red granules in enlarged infected RBCs.', conditions: ['Plasmodium vivax malaria', 'Plasmodium ovale malaria'], mechanism: 'Parasite-induced membrane changes create stippling.' },
            { id: 'img_plain_sickle_cells', src: `${PLAIN_MORPH_BASE}Sickle%20Cells.png`, title: 'Sickle Cells', desc: 'Crescent-shaped RBCs.', appearance: 'Elongated, curved RBCs with pointed ends.', conditions: ['Sickle cell disease'], mechanism: 'Deoxygenated HbS polymerizes, distorting the RBC membrane.' },
            { id: 'img_plain_spherocytes', src: `${PLAIN_MORPH_BASE}Spherocytes.png`, title: 'Spherocytes', desc: 'Round, dense RBCs without central pallor.', appearance: 'Small, spherical RBCs lacking central pallor.', conditions: ['Hereditary spherocytosis', 'Warm autoimmune hemolytic anemia'], mechanism: 'Membrane loss reduces surface area-to-volume ratio.' },
            { id: 'img_plain_stomatocytes', src: `${PLAIN_MORPH_BASE}Stromatocytes.png`, title: 'Stomatocytes', desc: 'RBCs with slit-like central pallor.', appearance: 'Cup-shaped RBCs with a fish-mouth central slit.', conditions: ['Hereditary stomatocytosis', 'Alcoholism', 'Liver disease'], mechanism: 'Membrane cation leak or lipid changes increase cell hydration.' },
            { id: 'img_plain_target_cells', src: `${PLAIN_MORPH_BASE}Target%20Cells.png`, title: 'Target Cells', desc: 'Bullseye RBCs with central hemoglobin.', appearance: 'Central hemoglobinized area with surrounding pallor and outer rim.', conditions: ['Thalassemia', 'Liver disease', 'Hemoglobin C disease', 'Asplenia', 'Sickle cell disease'], mechanism: 'Excess membrane surface area or altered hemoglobin creates a target appearance.' },

            // --- Module 11: Hemopoiesis ---
            { id: 'img_ls11_01', src: 'https://tayner35.github.io/HemeLymphE1-Images/Mod_11_Hemopoesis/LS11-01.jpg', title: 'Bone marrow section', desc: 'Histological section of hematopoietic bone marrow filled with nucleated precursors of erythroid and myeloid lineages.' },
            { id: 'img_ls11_02', src: 'https://tayner35.github.io/HemeLymphE1-Images/Mod_11_Hemopoesis/LS11-02.jpg', title: 'Yellow bone marrow', desc: 'Section showing adipose-rich yellow marrow with large unilocular fat cells separated by thin vascular septa.' },
            { id: 'img_ls11_03', src: 'https://tayner35.github.io/HemeLymphE1-Images/Mod_11_Hemopoesis/LS11-03.jpg', title: 'Erythroblast stages', desc: 'Smear with a large basophilic cell (A) and a smaller basophilic erythroblast (B) illustrating early red-cell development.' },
            { id: 'img_ls11_04', src: 'https://tayner35.github.io/HemeLymphE1-Images/Mod_11_Hemopoesis/LS11-04.jpg', title: 'Erythroblast maturation', desc: 'Three labelled erythroblasts (A‚ÄìC) demonstrating progression from basophilic to polychromatophilic erythroblast.' },
            { id: 'img_ls11_05', src: 'https://tayner35.github.io/HemeLymphE1-Images/Mod_11_Hemopoesis/LS11-05.jpg', title: 'Neutrophil among RBC', desc: 'Smear with neutrophil and surrounding erythrocytes illustrating granulocyte morphology.' },
            { id: 'img_ls11_06', src: 'https://tayner35.github.io/HemeLymphE1-Images/Mod_11_Hemopoesis/LS11-06.jpg', title: 'Band neutrophil', desc: 'Neutrophil precursor with a curved, unsegmented nucleus (band form) indicating near maturity.' },
            { id: 'img_ls11_07', src: 'https://tayner35.github.io/HemeLymphE1-Images/Mod_11_Hemopoesis/LS11-07.jpg', title: 'Myelocyte', desc: 'Granulocyte precursor with specific granules beginning to appear and an eccentric nucleus.' },
            { id: 'img_ls11_08', src: 'https://tayner35.github.io/HemeLymphE1-Images/Mod_11_Hemopoesis/LS11-08.jpg', title: 'Metamyelocyte', desc: 'Granulocyte precursor stage showing an indented (kidney-bean shaped) nucleus.' },
            { id: 'img_ls11_09', src: 'https://tayner35.github.io/HemeLymphE1-Images/Mod_11_Hemopoesis/LS11-09.jpg', title: 'Eosinophil', desc: 'Granulocyte with bi-lobed nucleus and distinct red-orange cytoplasmic granules.' },
            { id: 'img_ls11_10', src: 'https://tayner35.github.io/HemeLymphE1-Images/Mod_11_Hemopoesis/LS11-10.jpg', title: 'Basophil', desc: 'Granulocyte with dark purple/blue granules obscuring the nucleus.' },
            { id: 'img_ls11_11', src: 'https://tayner35.github.io/HemeLymphE1-Images/Mod_11_Hemopoesis/LS11-11.jpg', title: 'Lymphocyte', desc: 'Small agranulocyte with large, dense nucleus and minimal blue cytoplasm.' },
            { id: 'img_ls11_12', src: 'https://tayner35.github.io/HemeLymphE1-Images/Mod_11_Hemopoesis/LS11-12.jpg', title: 'Monocyte', desc: 'Large agranulocyte with kidney-bean shaped nucleus and grey-blue cytoplasm.' },
            { id: 'img_ls11_13', src: 'https://tayner35.github.io/HemeLymphE1-Images/Mod_11_Hemopoesis/LS11-13.jpg', title: 'Megakaryocyte', desc: 'Large bone marrow cell with multi-lobed nucleus responsible for platelet production.' },
            { id: 'img_ls11_14', src: 'https://tayner35.github.io/HemeLymphE1-Images/Mod_11_Hemopoesis/LS11-14.jpg', title: 'Platelet formation', desc: 'Megakaryocyte extending cytoplasmic processes to release platelets.' },
            { id: 'img_ls11_15', src: 'https://tayner35.github.io/HemeLymphE1-Images/Mod_11_Hemopoesis/LS11-15.jpg', title: 'Reticulocytes', desc: 'Supravital stain showing RNA filaments in immature red blood cells.' },
            { id: 'img_ls11_16', src: 'https://tayner35.github.io/HemeLymphE1-Images/Mod_11_Hemopoesis/LS11-16.jpg', title: 'Plasma cell', desc: 'Cell with eccentric nucleus, clock-face chromatin, and perinuclear hof.' },
            { id: 'img_ls11_17', src: 'https://tayner35.github.io/HemeLymphE1-Images/Mod_11_Hemopoesis/LS11-17.jpg', title: 'Mast cell', desc: 'Tissue cell filled with metachromatic granules involved in allergic reactions.' },
            { id: 'img_ls11_18', src: 'https://tayner35.github.io/HemeLymphE1-Images/Mod_11_Hemopoesis/LS11-18.jpg', title: 'Macrophage', desc: 'Large phagocytic cell with debris in cytoplasm.' },
            { id: 'img_ls11_19', src: 'https://tayner35.github.io/HemeLymphE1-Images/Mod_11_Hemopoesis/LS11-19.jpg', title: 'Osteoclast', desc: 'Large multi-nucleated cell involved in bone resorption found in marrow.' },
            
            // --- Module 9: Vessels ---
            { id: 'img_ls9_01', src: 'https://tayner35.github.io/HemeLymphE1-Images/Mod_9_Vessels/LS9-01.jpg', title: 'RBC Rouleaux', desc: 'Red blood cells adhering in a stack-of-coins formation.' },
            { id: 'img_ls9_02', src: 'https://tayner35.github.io/HemeLymphE1-Images/Mod_9_Vessels/LS9-02.jpg', title: 'Platelets and Neutrophil', desc: 'High mag view showing small platelets and a segmented neutrophil.' },
            { id: 'img_ls9_03', src: 'https://tayner35.github.io/HemeLymphE1-Images/Mod_9_Vessels/LS9-03.jpg', title: 'Arteriole Cross Section', desc: 'Small artery with distinct tunica media and internal elastic lamina.' },
            { id: 'img_ls9_04', src: 'https://tayner35.github.io/HemeLymphE1-Images/Mod_9_Vessels/LS9-04.jpg', title: 'Venule', desc: 'Thin-walled vessel often accompanying an arteriole, with larger lumen.' },
            { id: 'img_ls9_05', src: 'https://tayner35.github.io/HemeLymphE1-Images/Mod_9_Vessels/LS9-05.jpg', title: 'Capillary Bed', desc: 'Network of smallest vessels perfused with India ink.' },
            { id: 'img_ls9_06', src: 'https://tayner35.github.io/HemeLymphE1-Images/Mod_9_Vessels/LS9-06.jpg', title: 'Lymphatic Vessel', desc: 'Very thin-walled vessel containing lymph, often with valves.' },
            { id: 'img_ls9_07', src: 'https://tayner35.github.io/HemeLymphE1-Images/Mod_9_Vessels/LS9-07.jpg', title: 'Large Vein Wall', desc: 'Thick tunica adventitia containing vasa vasorum and smooth muscle.' },
            { id: 'img_ls9_08', src: 'https://tayner35.github.io/HemeLymphE1-Images/Mod_9_Vessels/LS9-08.jpg', title: 'Elastic Artery', desc: 'Aorta wall showing multiple concentric elastic lamellae in tunica media.' },
            { id: 'img_ls9_09', src: 'https://tayner35.github.io/HemeLymphE1-Images/Mod_9_Vessels/LS9-09.jpg', title: 'Muscular Artery', desc: 'Artery with prominent internal/external elastic laminae and smooth muscle media.' },
            { id: 'img_ls9_10', src: 'https://tayner35.github.io/HemeLymphE1-Images/Mod_9_Vessels/LS9-10.jpg', title: 'Arteriole vs Venule', desc: 'Comparison of thicker-walled arteriole and thinner-walled venule side-by-side.' },
            { id: 'img_ls9_11', src: 'https://tayner35.github.io/HemeLymphE1-Images/Mod_9_Vessels/LS9-11.jpg', title: 'Vein Valve', desc: 'Longitudinal section showing a valve leaflet within a vein.' },
            { id: 'img_ls9_12', src: 'https://tayner35.github.io/HemeLymphE1-Images/Mod_9_Vessels/LS9-12.jpg', title: 'Endothelial Cells', desc: 'High mag of vessel lining showing simple squamous endothelial nuclei.' },
            { id: 'img_ls9_13', src: 'https://tayner35.github.io/HemeLymphE1-Images/Mod_9_Vessels/LS9-13.jpg', title: 'Pericyte', desc: 'Cell wrapping around a capillary, visible in high resolution or TEM.' },
            { id: 'img_ls9_14', src: 'https://tayner35.github.io/HemeLymphE1-Images/Mod_9_Vessels/LS9-14.jpg', title: 'Continuous Capillary TEM', desc: 'Electron micrograph showing continuous endothelium and tight junctions.' },
            { id: 'img_ls9_15', src: 'https://tayner35.github.io/HemeLymphE1-Images/Mod_9_Vessels/LS9-15.jpg', title: 'Capillary Ultrastructure', desc: 'TEM showing RBC in lumen, endothelium, and basal lamina.' },
            { id: 'img_ls9_16', src: 'https://tayner35.github.io/HemeLymphE1-Images/Mod_9_Vessels/LS9-16.jpg', title: 'Microvascular TEM', desc: 'Ultrastructural details of small vessel wall components.' },
            { id: 'img_ls9_17', src: 'https://tayner35.github.io/HemeLymphE1-Images/Mod_9_Vessels/LS9-17.jpg', title: 'Fenestrated Capillary', desc: 'TEM showing pores (fenestrae) in the endothelial cytoplasm.' },
            { id: 'img_ls9_18', src: 'https://tayner35.github.io/HemeLymphE1-Images/Mod_9_Vessels/LS9-18.jpg', title: 'Medium Vein Wall', desc: 'Section showing irregular lumen and distinct layers of a medium vein.' },
            { id: 'img_ls9_19', src: 'https://tayner35.github.io/HemeLymphE1-Images/Mod_9_Vessels/LS9-19.jpg', title: 'Elastic Artery Stain', desc: 'Special stain (Verhoeff) highlighting elastic fibers in black.' },
            { id: 'img_ls9_20', src: 'https://tayner35.github.io/HemeLymphE1-Images/Mod_9_Vessels/LS9-20.jpg', title: 'Vasa Vasorum', desc: 'Small blood vessels nourishing the wall of a large artery/vein.' }
        ];

const MORPH_MATCH_BASE = 'https://tayner35.github.io/HemeLymphE1-Images/RBC_Images_Unlabeled/';
const MORPH_MATCH_DATA = [
            { id: 'morph_acanthocytes', label: 'Acanthocytes (Spur Cells)', file: 'RBC Morphology_Acanthocytes Spur Cells.jpg' },
            { id: 'morph_anisocytosis', label: 'Anisocytosis', file: 'RBC Morphology_Anisocytosis.jpg' },
            { id: 'morph_banana_gametocytes', label: 'Banana-shaped Gametocytes', file: 'RBC Morphology_Banana-shaped Gametocytes.jpg' },
            { id: 'morph_band_forms', label: 'Band Forms', file: 'RBC Morphology_Band Forms.jpg' },
            { id: 'morph_barr_body', label: 'Barr Body', file: 'RBC Morphology_Barr Body.jpg' },
            { id: 'morph_basophilic_stippling', label: 'Basophilic Stippling', file: 'RBC Morphology_Basophilic Stippling.jpg' },
            { id: 'morph_dacrocytes', label: 'Dacrocytes (Teardrop Cells)', file: 'RBC Morphology_Dacrocytes.jpg' },
            { id: 'morph_echinocytes', label: 'Echinocytes (Burr Cells)', file: 'RBC Morphology_Echinocytes Burr Cells.jpg' },
            { id: 'morph_elliptocytes', label: 'Elliptocytes (Pencil Cells)', file: 'RBC Morphology_Elliptocytes Pencil Cells.jpg' },
            { id: 'morph_heinz_bodies', label: 'Heinz Bodies', file: 'RBC Morphology_Heinz Bodies.jpg' },
            { id: 'morph_howell_jolly', label: 'Howell-Jolly Bodies', file: 'RBC Morphology_Howell-Jolly Bodies.jpg' },
            { id: 'morph_hypersegmented', label: 'Hypersegmented Neutrophils', file: 'RBC Morphology_Hypersegmented Neutrophils.jpg' },
            { id: 'morph_large_platelets', label: 'Large Platelets', file: 'RBC Morphology_Large Platelets.jpg' },
            { id: 'morph_macro_ovalocytes', label: 'Macrocytic Macro-ovalocytes', file: 'RBC Morphology_Macrocytic Macro-ovalocytes.jpg' },
            { id: 'morph_microcytic_hypochromic', label: 'Microcytic Hypochromic', file: 'RBC Morphology_Microcytic Hypochromic.jpg' },
            { id: 'morph_nucleated_rbcs', label: 'Nucleated RBCs', file: 'RBC Morphology_Nucleated RBCs.jpg' },
            { id: 'morph_pappenheimer', label: 'Pappenheimer Bodies', file: 'RBC Morphology_Pappenheimer Bodies.jpg' },
            { id: 'morph_ring_forms', label: 'Ring Forms', file: 'RBC Morphology_Ring Forms.jpg' },
            { id: 'morph_rouleaux', label: 'Rouleaux Formation', file: 'RBC Morphology_Rouleaux Formation.jpg' },
            { id: 'morph_schistocytes', label: 'Schistocytes', file: 'RBC Morphology_Schistocytes.jpg' },
            { id: 'morph_schuffner', label: 'Schuffner Dots', file: 'RBC Morphology_Schuffner Dots.jpg' },
            { id: 'morph_sickle_cells', label: 'Sickle Cells', file: 'RBC Morphology_Sickle Cells.jpg' },
            { id: 'morph_spherocytes', label: 'Spherocytes', file: 'RBC Morphology_Spherocytes.jpg' },
            { id: 'morph_stomatocytes', label: 'Stomatocytes', file: 'RBC Morphology_Stomatocytes.jpg' },
            { id: 'morph_target_cells', label: 'Target Cells', file: 'RBC Morphology_Target Cells.jpg' }
        ].map(({ id, label, file }) => ({
            id,
            label,
            src: `${MORPH_MATCH_BASE}${encodeURIComponent(file)}`
        }));

const FLOWCHART_NODES = [
            { id: 'h1', type: 'label', text: 'Microcytic (MCV < 80)', x: 1.0, y: 0.5, w: 3, color: 'bg-red-100 border-red-300' },
            { id: 'h2', type: 'label', text: 'Normocytic (MCV 80-100)', x: 5.75, y: 0.5, w: 5, color: 'bg-green-100 border-green-300' },
            { id: 'h3', type: 'label', text: 'Macrocytic (MCV > 96)', x: 14.0, y: 0.5, w: 3, color: 'bg-blue-100 border-blue-300' },

            // --- MICROCYTIC PATH ---
            { id: 'micro_step1', type: 'label', text: 'Step 1: Serum Iron Studies', x: 1.0, y: 2, w: 3, color: 'bg-white border-slate-300 font-bold' },
            { id: 'micro_low_iron', type: 'label', text: '‚Üì Iron', x: 0.0, y: 3.5, w: 2, color: 'bg-slate-50 text-red-600' },
            { id: 'lbl_low_ferritin', type: 'label', text: '‚Üì Ferritin', x: -0.5, y: 5, w: 1, color: 'bg-white border-dashed text-xs' },
            { id: 'lbl_high_ferritin', type: 'label', text: '‚Üë Ferritin', x: 0.5, y: 5, w: 1, color: 'bg-white border-dashed text-xs' },
            { id: 'lbl_norm_ferritin', type: 'label', text: 'Normal Ferritin', x: 1.5, y: 5, w: 1, color: 'bg-white border-dashed text-xs' },
            { id: 'drop_ida', type: 'drop', answer: 'Iron Deficiency Anaemia', x: -0.5, y: 6.5, w: 1, isFinal: true },
            { id: 'drop_acd', type: 'drop', answer: 'Anaemia of Chronic Disease', x: 0.5, y: 6.5, w: 1, isFinal: true },
            { id: 'drop_thal', type: 'drop', answer: 'Thalassemia', x: 1.5, y: 6.5, w: 1, isFinal: true },
            { id: 'micro_high_iron', type: 'label', text: '‚Üë Iron', x: 3.0, y: 3.5, w: 1, color: 'bg-slate-50 text-red-600' },
            { id: 'lbl_sid_ferritin', type: 'label', text: '‚Üì Ferritin', x: 3.0, y: 5, w: 1, color: 'bg-white border-dashed text-xs' },
            { id: 'drop_sidero', type: 'drop', answer: 'Sideroblastic Anaemia', x: 3.0, y: 6.5, w: 1, isFinal: true },

            // --- NORMOCYTIC PATH ---
            { id: 'normo_step1', type: 'label', text: 'Step 1: Reticulocyte Count', x: 5.75, y: 2, w: 5, color: 'bg-white border-slate-300 font-bold' },
            { id: 'normo_low_retic', type: 'label', text: '< 2% (Low Production)', x: 5.0, y: 3.5, w: 2, color: 'bg-slate-50 text-green-700' },
            { id: 'lbl_pancyto', type: 'label', text: 'Pancytopenia Present', x: 4.5, y: 5, w: 1, color: 'bg-white border-dashed text-xs' },
            { id: 'lbl_no_pancyto', type: 'label', text: 'Pancytopenia Absent', x: 5.5, y: 5, w: 1, color: 'bg-white border-dashed text-xs' },
            { id: 'drop_aplastic', type: 'drop', answer: 'Aplastic Anaemia', x: 4.5, y: 6.5, w: 1, isFinal: true },
            { id: 'drop_prca', type: 'drop', answer: 'Pure Red Cell Aplasia', x: 5.5, y: 6.5, w: 1, isFinal: true },
            { id: 'normo_high_retic', type: 'label', text: '> 2% (Hemolytic)', x: 8.5, y: 3.5, w: 3.5, color: 'bg-slate-50 text-green-700' },
            { id: 'lbl_inherited', type: 'label', text: 'Inherited Causes', x: 7.5, y: 5, w: 1.5, color: 'bg-green-50 border-green-200' },
            { id: 'lbl_bite', type: 'label', text: 'Bite/Heinz Cells', x: 7.0, y: 6.5, w: 1, color: 'bg-white border-dashed text-xs' },
            { id: 'lbl_sickle', type: 'label', text: 'Sickle Cells', x: 8.0, y: 6.5, w: 1, color: 'bg-white border-dashed text-xs' },
            { id: 'drop_g6pd', type: 'drop', answer: 'G6PD Deficiency', x: 7.0, y: 8, w: 1, isFinal: true },
            { id: 'drop_sickle', type: 'drop', answer: 'Sickle Cell Anaemia', x: 8.0, y: 8, w: 1, isFinal: true },
            { id: 'lbl_acquired', type: 'label', text: 'Acquired (Direct Coombs)', x: 10.0, y: 5, w: 2, color: 'bg-green-50 border-green-200' },
            { id: 'lbl_coombs_pos', type: 'label', text: 'Positive (+)', x: 9.25, y: 6.5, w: 1.5, color: 'bg-white border-dashed text-xs' },
            { id: 'lbl_IgG', type: 'label', text: 'IgG-mediated', x: 9.25, y: 8, w: 0.5, color: 'bg-white border-dashed text-xs' },
            { id: 'lbl_IgM', type: 'label', text: 'IgM-mediated', x: 10.25, y: 8, w: 0.5, color: 'bg-white border-dashed text-xs' },
            { id: 'drop_warm', type: 'drop', answer: 'Warm AIHA', x: 9.0, y: 9, w: 1, isFinal: true },
            { id: 'drop_cold', type: 'drop', answer: 'Cold AIHA', x: 10.0, y: 9, w: 1, isFinal: true },
            { id: 'lbl_coombs_neg', type: 'label', text: 'Negative (-)', x: 11.25, y: 6.5, w: 1.5, color: 'bg-white border-dashed text-xs' },
            { id: 'lbl_cd55', type: 'label', text: 'Test CD55/59 Deficiency', x: 11.25, y: 8, w: 1.5, color: 'bg-white border-slate-200' },
            { id: 'CD55_59_pos', type: 'label', text: 'CD55/59 Absent', x: 11.25, y: 8.85, w: 0.5, color: 'bg-white border-dashed text-xs' },
            { id: 'drop_pnh', type: 'drop', answer: 'Paroxysmal Nocturnal Hemoglobinuria (PNH)', x: 11.0, y: 9.75, w: 1, isFinal: true },
            { id: 'CD55_59_neg', type: 'label', text: 'CD55/59 Present', x: 12.25, y: 8.85, w: 0.5, color: 'bg-white border-dashed text-xs' },
            { id: 'drop_ttp', type: 'drop', answer: 'Thrombotic Thrombocytopenic Purpura (TTP)', x: 12.0, y: 9.75, w: 1, isFinal: true },

            
            // --- MACROCYTIC PATH ---
            { id: 'macro_step1', type: 'label', text: 'Step 1: Check Smear', x: 14.0, y: 2, w: 3, color: 'bg-white border-slate-300 font-bold' },
            { id: 'macro_mega', type: 'label', text: 'Megaloblastic Features Present?', x: 14.0, y: 3.5, w: 3, color: 'bg-slate-50 text-blue-700' },
            { id: 'macro_copper', type: 'label', text: 'Step 2: Check Copper', x: 14.0, y: 5, w: 3, color: 'bg-white border-slate-300' },
            { id: 'lbl_low_copper', type: 'label', text: '‚Üì Copper', x: 14.25, y: 6.5, w: 1, color: 'bg-white border-dashed text-xs' },
            { id: 'drop_copper', type: 'drop', answer: 'Copper Deficiency', x: 14.25, y: 8, w: 1, isFinal: true },
            { id: 'lbl_norm_copper', type: 'label', text: 'Normal Copper (Check MMA)', x: 15.5, y: 6.5, w: 1.5, color: 'bg-white border-dashed text-xs' },
            { id: 'copper_high_mma', type: 'label', text: '‚Üë MMA', x: 15.25, y: 8, w: 1, color: 'bg-white border-dashed text-xs' },
            { id: 'copper_norm_mma', type: 'label', text: 'Normal MMA', x: 16.25, y: 8, w: 1, color: 'bg-white border-dashed text-xs' },
            { id: 'drop_b12', type: 'drop', answer: 'B12 Deficiency', x: 15.25, y: 9, w: 1, isFinal: true },
            { id: 'drop_folate', type: 'drop', answer: 'Folate Deficiency', x: 16.25, y: 9, w: 1, isFinal: true }, 
                  ];

const FLOWCHART_CONNECTIONS = [
            { from: 'h1', to: 'micro_step1' }, 
            { from: 'h2', to: 'normo_step1' }, 
            { from: 'h3', to: 'macro_step1' },
            
            // Micro
            { from: 'micro_step1', to: 'micro_low_iron' }, { from: 'micro_step1', to: 'micro_high_iron' },
            { from: 'micro_low_iron', to: 'lbl_low_ferritin' }, { from: 'micro_low_iron', to: 'lbl_high_ferritin' }, { from: 'micro_low_iron', to: 'lbl_norm_ferritin' },
            { from: 'micro_high_iron', to: 'lbl_sid_ferritin' },
            { from: 'lbl_low_ferritin', to: 'drop_ida' }, { from: 'lbl_high_ferritin', to: 'drop_acd' }, { from: 'lbl_norm_ferritin', to: 'drop_thal' },
            { from: 'lbl_sid_ferritin', to: 'drop_sidero' },

            // Normo
            { from: 'normo_step1', to: 'normo_low_retic' }, { from: 'normo_step1', to: 'normo_high_retic' },
            { from: 'normo_low_retic', to: 'lbl_pancyto' }, { from: 'normo_low_retic', to: 'lbl_no_pancyto' },
            { from: 'lbl_pancyto', to: 'drop_aplastic' }, { from: 'lbl_no_pancyto', to: 'drop_prca' },
            { from: 'normo_high_retic', to: 'lbl_inherited' }, { from: 'normo_high_retic', to: 'lbl_acquired' },
            { from: 'lbl_inherited', to: 'lbl_bite' }, { from: 'lbl_inherited', to: 'lbl_sickle' },
            { from: 'lbl_bite', to: 'drop_g6pd' }, { from: 'lbl_sickle', to: 'drop_sickle' },
            { from: 'lbl_acquired', to: 'lbl_coombs_pos' }, { from: 'lbl_acquired', to: 'lbl_coombs_neg' },
            { from: 'lbl_coombs_pos', to: 'lbl_IgG' }, { from: 'lbl_coombs_pos', to: 'lbl_IgM' },
            { from: 'lbl_IgG', to: 'drop_warm' },
            { from: 'lbl_IgM', to: 'drop_cold' },
            { from: 'lbl_coombs_neg', to: 'lbl_cd55' },
            { from: 'lbl_cd55', to: 'CD55_59_neg' }, { from: 'lbl_cd55', to: 'CD55_59_pos' },
            { from: 'CD55_59_neg', to: 'drop_ttp' },
            { from: 'CD55_59_pos', to: 'drop_pnh' },

            // Macro
            { from: 'macro_step1', to: 'macro_mega' },
            { from: 'macro_mega', to: 'macro_copper' },
            { from: 'macro_copper', to: 'lbl_low_copper' }, { from: 'macro_copper', to: 'lbl_norm_copper' },
            { from: 'lbl_low_copper', to: 'drop_copper' },
            { from: 'lbl_norm_copper', to: 'copper_high_mma' }, { from: 'lbl_norm_copper', to: 'copper_norm_mma' },
            { from: 'copper_high_mma', to: 'drop_b12' },
            { from: 'copper_norm_mma', to: 'drop_folate' },
        ];


// ===== IMPORTED DATASETS (Copilot + Claude) =====

const CLAUDE_FULL_DATA = [
            { category: 'Anemias', term: 'Iron Deficiency Anemia', etiology: 'Iron deficiency from blood loss, low intake, or malabsorption.', findings: 'Microcytic hypochromic anemia, ‚Üì ferritin/iron, ‚Üë TIBC, pica, koilonychia.', def: 'Microcytic hypochromic anemia, ‚Üì ferritin/iron, ‚Üë TIBC, pica, koilonychia.' },
            { category: 'Anemias', term: 'Sickle Cell Disease', etiology: 'AD beta-globin Glu->Val mutation (HbS).', findings: 'Vaso-occlusive pain crises, sickle + target cells, ‚Üë reticulocytes.', def: 'Vaso-occlusive pain crises, sickle + target cells, ‚Üë reticulocytes.' },
            { category: 'Anemias', term: 'B12 Deficiency', etiology: 'Cobalamin deficiency (pernicious anemia, malabsorption, vegan).', findings: 'Macrocytic anemia, hypersegmented neutrophils, ‚Üë MMA + homocysteine, neuro symptoms.', def: 'Macrocytic anemia, hypersegmented neutrophils, ‚Üë MMA + homocysteine, neuro symptoms.' },
            { category: 'Coagulation', term: 'Hemophilia A', etiology: 'Factor VIII deficiency (X-linked).', findings: 'Hemarthroses, ‚Üë PTT with normal bleeding time; mixing study corrects; ‚Üì factor VIII activity.', def: 'Hemarthroses, ‚Üë PTT with normal bleeding time; mixing study corrects; ‚Üì factor VIII activity.' },
            { category: 'Coagulation', term: 'Von Willebrand Disease', etiology: 'AD vWF quantitative/qualitative defect ‚Üí ‚Üì platelet adhesion and ‚Üì factor VIII.', findings: 'Mucocutaneous bleeding, ‚Üë bleeding time/PFA, sometimes ‚Üë PTT, abnormal ristocetin (corrects with plasma).', def: 'Mucocutaneous bleeding, ‚Üë bleeding time/PFA, sometimes ‚Üë PTT, abnormal ristocetin (corrects with plasma).' },
            { category: 'Coagulation', term: 'Factor V Leiden', etiology: 'Factor V mutation resistant to APC cleavage.', findings: 'Hypercoagulability (DVT/PE), normal PT/PTT.', def: 'Hypercoagulability (DVT/PE), normal PT/PTT.' },
        ];

const CLAUDE_MECHANISM_GAMES = {
            drugs: {
                title: 'Drug Mechanisms',
                subtitle: 'Match drugs to their mechanisms',
                icon: ICONS.Brain,
                color: 'from-purple-500 to-pink-600',
                pairs: [
                    { item: 'Warfarin', match: 'Inhibits Vitamin K epoxide reductase (VKOR)' },
                    { item: 'Heparin', match: 'Potentiates Antithrombin III' },
                    { item: 'Aspirin', match: 'Irreversible COX-1 inhibition' },
                    { item: 'Clopidogrel', match: 'ADP receptor (P2Y12) blocker' },
                    { item: 'Rivaroxaban', match: 'Direct Factor Xa inhibitor' },
                ]
            },
            mutations: {
                title: 'Genetic Mutations',
                subtitle: 'Match mutations to their effects',
                icon: ICONS.Zap,
                color: 'from-orange-500 to-red-600',
                pairs: [
                    { item: 'HbS (Glu‚ÜíVal)', match: 'Sickling under low O‚ÇÇ' },
                    { item: 'Factor V Leiden', match: 'Resistance to Protein C cleavage' },
                    { item: 'JAK2 V617F', match: 'Myeloproliferative disorders (PV, ET)' },
                    { item: 'PIG-A mutation', match: 'Loss of GPI anchors (PNH)' },
                    { item: 'G6PD deficiency', match: 'Oxidative hemolysis (Heinz bodies)' },
                ]
            }
        };

const CLAUDE_QUIZ_QUESTIONS = [
            // Easy
            { difficulty: 'easy', question: 'What is the most common cause of microcytic anemia?', options: ['Iron deficiency', 'B12 deficiency', 'Folate deficiency', 'Hemolysis'], answer: 0, explanation: 'Iron deficiency is the #1 cause of microcytic anemia worldwide.' },
            { difficulty: 'easy', question: 'Which factor is deficient in Hemophilia A?', options: ['Factor VII', 'Factor VIII', 'Factor IX', 'Factor X'], answer: 1, explanation: 'Hemophilia A is Factor VIII deficiency (X-linked).' },
            { difficulty: 'easy', question: 'What does ‚ÜëMCV indicate?', options: ['Microcytosis', 'Macrocytosis', 'Normocytosis', 'Polycythemia'], answer: 1, explanation: 'MCV >100 fL indicates macrocytic RBCs.' },
            
            // Medium
            { difficulty: 'medium', question: 'Which test differentiates B12 from Folate deficiency?', options: ['Homocysteine', 'Methylmalonic acid (MMA)', 'Ferritin', 'TIBC'], answer: 1, explanation: 'MMA is elevated only in B12 deficiency, normal in folate deficiency.' },
            { difficulty: 'medium', question: 'What is the pathognomonic finding in Hereditary Spherocytosis?', options: ['‚ÜëMCHC', 'Target cells', 'Sickle cells', 'Heinz bodies'], answer: 0, explanation: 'Hereditary Spherocytosis shows ‚ÜëMCHC (hyperchromic spherocytes).' },
            { difficulty: 'medium', question: 'Which condition shows "bite cells"?', options: ['Sickle cell', 'G6PD deficiency', 'Thalassemia', 'Iron deficiency'], answer: 1, explanation: 'G6PD deficiency: oxidative damage creates Heinz bodies, macrophages bite them out.' },
            
            // Hard
            { difficulty: 'hard', question: 'In TTP, which enzyme is deficient?', options: ['ADAMTS13', 'Factor VIII', 'Protein C', 'Antithrombin'], answer: 0, explanation: 'TTP is caused by deficiency of ADAMTS13, which cleaves vWF multimers.' },
            { difficulty: 'hard', question: 'What is the mechanism of Heparin-Induced Thrombocytopenia (HIT)?', options: ['Decreased platelet production', 'Antibodies to PF4-Heparin complex', 'Splenic sequestration', 'Immune destruction'], answer: 1, explanation: 'HIT: antibodies against PF4-Heparin complexes cause paradoxical thrombosis.' },
            { difficulty: 'hard', question: 'Which mutation is diagnostic for Polycythemia Vera?', options: ['BCR-ABL', 'JAK2 V617F', 'PML-RARA', 'c-KIT'], answer: 1, explanation: 'JAK2 V617F mutation is found in >95% of Polycythemia Vera cases.' },
        ];

const DISEASE_TABLE_INDEX = [
            {
                name: 'Acute Intermittent Porphyria (AIP)',
                type: 'Non-hemolytic / Heme synthesis disorder',
                etiology: 'Inherited (AD)',
                mechanism: '‚Üì Porphobilinogen deaminase',
                pathophysiology: 'Accumulation of ALA and PBG ‚Üí neurotoxicity',
                labs: ['‚Üë ALA', '‚Üë PBG', 'Iron N'],
                presentation: ['Abdominal pain', 'Neuropathy', 'Psychiatric symptoms', 'Port-wine urine'],
                smear: ['Normal']
            },
            {
                name: 'Porphyria Cutanea Tarda (PCT)',
                type: 'Non-hemolytic / Heme synthesis disorder',
                etiology: 'Mostly acquired; some inherited',
                mechanism: '‚Üì Uroporphyrinogen decarboxylase',
                pathophysiology: 'Porphyrin accumulation ‚Üí photosensitivity',
                labs: ['‚Üë Uroporphyrins', '‚Üë Iron'],
                presentation: ['Photosensitivity', 'Blistering', 'Red-brown urine'],
                smear: ['Normal']
            },
            {
                name: 'Sickle Cell Disease',
                type: 'Hemolytic (intravascular + extravascular)',
                etiology: 'Inherited (AR)',
                mechanism: 'HbS polymerization (Œ≤-globin mutation)',
                pathophysiology: 'Deoxygenation ‚Üí Hb polymerization ‚Üí RBC sickling ‚Üí vaso-occlusion + hemolysis',
                labs: ['‚Üë Retic', '‚Üë LDH', '‚Üì Haptoglobin'],
                presentation: ['Pain crises', 'Acute chest syndrome (ACS)', 'Dactylitis', 'Infections'],
                smear: ['Sickled RBCs', 'Target cells']
            },
            {
                name: 'Autoimmune Hemolytic Anemia (Warm)',
                type: 'Hemolytic (extravascular)',
                etiology: 'Acquired',
                mechanism: 'IgG-mediated RBC destruction',
                pathophysiology: 'Splenic macrophage phagocytosis ‚Üí extravascular hemolysis',
                labs: ['‚Üë LDH', '‚Üì Haptoglobin', '+ Coombs'],
                presentation: ['Fatigue', 'Jaundice', 'Splenomegaly'],
                smear: ['Spherocytes']
            },
            {
                name: 'Autoimmune Hemolytic Anemia (Cold)',
                type: 'Hemolytic (intravascular)',
                etiology: 'Acquired',
                mechanism: 'IgM-mediated complement fixation',
                pathophysiology: 'Complement activation ‚Üí hemolysis, worsens with cold exposure',
                labs: ['‚Üë LDH', '‚Üì Haptoglobin', '+ Coombs (C3)'],
                presentation: ['Acrocyanosis', 'Cold-induced hemolysis'],
                smear: ['RBC agglutination']
            },
            {
                name: 'Paroxysmal Nocturnal Hemoglobinuria (PNH)',
                type: 'Hemolytic (intravascular)',
                etiology: 'Acquired',
                mechanism: 'PIGA mutation ‚Üí ‚Üì CD55/CD59',
                pathophysiology: 'Loss of complement regulators ‚Üí complement-mediated intravascular hemolysis',
                labs: ['Hemoglobinuria', 'Pancytopenia'],
                presentation: ['Dark urine', 'Thrombosis'],
                smear: ['Normal']
            },
            {
                name: 'Hereditary Spherocytosis',
                type: 'Hemolytic (extravascular)',
                etiology: 'Inherited (AD)',
                mechanism: 'Spectrin/ankyrin membrane defect',
                pathophysiology: 'Membrane loss ‚Üí ‚Üì deformability ‚Üí splenic sequestration/destruction',
                labs: ['‚Üë MCHC', '‚Üë Retic'],
                presentation: ['Splenomegaly', 'Jaundice'],
                smear: ['Spherocytes']
            },
            {
                name: 'G6PD Deficiency',
                type: 'Hemolytic (intravascular)',
                etiology: 'Inherited (X-linked)',
                mechanism: '‚Üì NADPH (oxidative stress vulnerability)',
                pathophysiology: 'Oxidant stress ‚Üí Hb denaturation/membrane damage ‚Üí episodic hemolysis',
                labs: ['‚Üë LDH', '‚Üì Haptoglobin'],
                presentation: ['Episodic jaundice', 'Trigger-related hemolysis'],
                smear: ['Bite cells', 'Heinz bodies']
            },
            {
                name: 'Vitamin B12 Deficiency',
                type: 'Macrocytic',
                etiology: 'Acquired',
                mechanism: 'Impaired DNA synthesis',
                pathophysiology: 'Megaloblastic erythropoiesis ‚Üí ineffective RBC production',
                labs: ['‚Üë MCV', '‚Üë Homocysteine'],
                presentation: ['Neurologic deficits', 'Glossitis'],
                smear: ['Hypersegmented neutrophils']
            },
            {
                name: 'Folate Deficiency',
                type: 'Macrocytic',
                etiology: 'Acquired',
                mechanism: 'Impaired DNA synthesis',
                pathophysiology: 'Megaloblastic erythropoiesis ‚Üí ineffective RBC production',
                labs: ['‚Üë MCV', '‚Üì Folate'],
                presentation: ['Fatigue', 'Glossitis'],
                smear: ['Hypersegmented neutrophils']
            },
            {
                name: 'Copper Deficiency',
                type: 'Macrocytic / normocytic',
                etiology: 'Acquired',
                mechanism: 'Impaired iron metabolism',
                pathophysiology: 'Ineffective hematopoiesis (can mimic B12 deficiency clinically)',
                labs: ['‚Üì Copper', 'Anemia', 'Neutropenia'],
                presentation: ['B12-like symptoms'],
                smear: ['Normal']
            },
            {
                name: 'Aplastic Anemia',
                type: 'Normocytic / BM Failure',
                etiology: 'Inherited or acquired',
                mechanism: 'Stem cell failure',
                pathophysiology: 'Marrow failure ‚Üí pancytopenia',
                labs: ['‚Üì RBC', '‚Üì WBC', '‚Üì Platelets'],
                presentation: ['Fatigue', 'Infections', 'Bleeding'],
                smear: ['Hypocellular marrow']
            },
            {
                name: 'Pure Red Cell Aplasia (PRCA)',
                type: 'Normocytic / BM Failure',
                etiology: 'Inherited or acquired',
                mechanism: 'Selective erythroid suppression',
                pathophysiology: 'Absent RBC production with preserved other lineages',
                labs: ['‚Üì Retic', 'WBC N', 'Platelets N'],
                presentation: ['Fatigue'],
                smear: ['Absent erythroid precursors']
            },
            {
                name: 'Iron Deficiency Anemia',
                type: 'Microcytic / hypoproliferative',
                etiology: 'Acquired',
                mechanism: '‚Üì Iron availability',
                pathophysiology: 'Impaired hemoglobin synthesis ‚Üí microcytosis/hypochromia',
                labs: ['‚Üì Ferritin', '‚Üë TIBC'],
                presentation: ['Fatigue', 'Pica', 'Koilonychia'],
                smear: ['Microcytic hypochromic RBCs']
            },
            {
                name: 'Anemia of Chronic Disease',
                type: 'Microcytic / normocytic / hypoproliferative',
                etiology: 'Acquired',
                mechanism: '‚Üë Hepcidin',
                pathophysiology: 'Iron sequestration and reduced availability for erythropoiesis',
                labs: ['‚Üë Ferritin', '‚Üì Iron'],
                presentation: ['Chronic illness symptoms'],
                smear: ['Normal']
            },
            {
                name: 'Thalassemia',
                type: 'Microcytic / normocytic / hypoproliferative',
                etiology: 'Inherited',
                mechanism: 'Globin chain imbalance',
                pathophysiology: 'Ineffective erythropoiesis ¬± hemolysis; severity varies',
                labs: ['Iron N', '‚Üë HbA2/HbF'],
                presentation: ['Bone deformities (severe forms)'],
                smear: ['Target cells']
            },
            {
                name: 'Sideroblastic Anemia',
                type: 'Microcytic / normocytic / hypoproliferative',
                etiology: 'Inherited or acquired',
                mechanism: 'Defective heme synthesis',
                pathophysiology: 'Iron trapped in mitochondria ‚Üí ineffective erythropoiesis',
                labs: ['‚Üë Iron', '‚Üë Ferritin'],
                presentation: ['Fatigue'],
                smear: ['Ring sideroblasts']
            },
            {
                name: 'Anemia of Chronic Kidney Disease (CKD)',
                type: 'Microcytic / normocytic / hypoproliferative',
                etiology: 'Acquired',
                mechanism: '‚Üì EPO production',
                pathophysiology: 'Reduced erythropoiesis due to inadequate erythropoietin',
                labs: ['‚Üì Hb', 'MCV N'],
                presentation: ['Fatigue'],
                smear: ['Normal']
            },
            {
                name: 'Thrombotic Thrombocytopenic Purpura (TTP)',
                type: 'MAHA',
                etiology: 'Acquired',
                mechanism: '‚Üì ADAMTS13',
                pathophysiology: 'Large vWF multimers ‚Üí platelet microthrombi ‚Üí shear RBC injury',
                labs: ['‚Üì Platelets', '‚Üë LDH'],
                presentation: ['Neuro changes', 'Renal injury', 'Fever'],
                smear: ['Schistocytes']
            },
            {
                name: 'Disseminated Intravascular Coagulation (DIC)',
                type: 'MAHA',
                etiology: 'Acquired',
                mechanism: 'Systemic coagulation activation',
                pathophysiology: 'Widespread clotting ‚Üí consumption of platelets/factors ‚Üí bleeding + hemolysis',
                labs: ['‚Üë D-dimer', '‚Üì Fibrinogen'],
                presentation: ['Bleeding', 'Shock'],
                smear: ['Schistocytes']
            },
            {
                name: 'Hemolytic Uremic Syndrome (HUS)',
                type: 'MAHA',
                etiology: 'Acquired',
                mechanism: 'Shiga toxin endothelial injury',
                pathophysiology: 'Endothelial damage ‚Üí platelet activation ‚Üí microthrombi ‚Üí renal injury + hemolysis',
                labs: ['‚Üë LDH', '‚Üì Platelets'],
                presentation: ['AKI', 'Diarrhea'],
                smear: ['Schistocytes']
            }
        ];

const CLAUDE_DISEASE_INDEX = DISEASE_TABLE_INDEX;

const COPILOT_MECHANISM_SORTERS = {
    'Drugs‚ÜíMechanism': [
        { id: 's-dr-1', item: 'Warfarin', target: 'Inhibits VKOR (vitamin K epoxide reductase)' },
        { id: 's-dr-2', item: 'Heparin (UFH)', target: 'Activates antithrombin ‚Üí inhibits thrombin & Xa' },
        { id: 's-dr-3', item: 'Aspirin', target: 'Irreversible COX-1 inhibitor ‚Üí ‚Üì TXA2' }
    ],
    'Mutations‚ÜíEffect': [
        { id: 's-mu-1', item: 'HbS (Glu‚ÜíVal)', target: 'Polymerization under low O2 ‚Üí sickling' },
        { id: 's-mu-2', item: 'Factor V Leiden', target: 'APC resistance ‚Üí hypercoagulability' }
    ],
    'Infections‚ÜíRBC changes': [
        { id: 's-inf-1', item: 'Plasmodium falciparum', target: 'Ring forms and trophozoites in RBCs; can infect RBCs of all ages' },
        { id: 's-inf-2', item: 'Babesia', target: 'Maltese cross tetrads inside RBCs' }
    ]
};

const COPILOT_QUIZ_QUESTIONS = [
    // difficulty: 1 easy, 2 medium, 3 hard
    { id: 'q1', q: 'Which product is used for low fibrinogen?', choices: ['Platelets','Packed RBCs','Cryoprecipitate','FFP'], a: 'Cryoprecipitate', difficulty: 1 },
    { id: 'q2', q: 'What does Warfarin inhibit?', choices: ['VKOR','Thrombin','Antithrombin','Factor VIII'], a: 'VKOR', difficulty: 1 },
    { id: 'q3', q: 'Which infection causes Maltese cross?', choices: ['Babesia','Plasmodium falciparum','Plasmodium vivax','Ehrlichia'], a: 'Babesia', difficulty: 2 },
    { id: 'q4', q: 'An isolated prolonged aPTT corrects with mixing study ‚Äî likely cause?', choices: ['Factor deficiency','Lupus anticoagulant','Hemophilia A inhibitor','DIC'], a: 'Factor deficiency', difficulty: 2 },
    { id: 'q5', q: 'Which drug reverses heparin?', choices: ['Vitamin K','Protamine sulfate','FFP','Tranexamic acid'], a: 'Protamine sulfate', difficulty: 1 },
    { id: 'q6', q: 'Mechanism: Desmopressin works by?', choices: ['Stimulating vWF release','Inhibiting plasmin','Inhibiting VKOR','Blocking P2Y12'], a: 'Stimulating vWF release', difficulty: 2 },
    { id: 'q7', q: 'Which causes schistocytes on smear?', choices: ['MAHA','Sickle cell','Hereditary spherocytosis','G6PD deficiency'], a: 'MAHA', difficulty: 1 },
    { id: 'q8', q: 'High ferritin with microcytic indices suggests?', choices: ['Sideroblastic anemia','Iron deficiency','ACD','Thalassemia'], a: 'Sideroblastic anemia', difficulty: 3 }
];

const COPILOT_DISEASE_INDEX = [];


// ===== DATA NORMALIZATION / MERGE =====

// ===== DATA NORMALIZATION / MERGE =====

// Merge Claude FULL_DATA into baseline deck data (keeps all features; duplicates allowed)
try {
  if (Array.isArray(CLAUDE_FULL_DATA)) FULL_DATA.push(...CLAUDE_FULL_DATA);
} catch (e) {
  console.warn('Claude FULL_DATA import failed:', e);
}

// Build unified Mechanism Sorter registry
const MECHANISM_GAMES = (() => {
  const out = {};

  const ensureGame = (key, base = {}) => {
    if (!out[key]) {
      out[key] = {
        id: key,
        title: base.title || key,
        subtitle: base.subtitle || '',
        icon: base.icon || ICONS.Activity,
        color: base.color || 'from-emerald-600 to-teal-700',
        pairs: []
      };
    }
    return out[key];
  };

  // Claude mechanism games
  try {
    Object.entries(CLAUDE_MECHANISM_GAMES || {}).forEach(([key, g]) => {
      const game = ensureGame(key, g || {});
      (g.pairs || []).forEach((p, i) => {
        game.pairs.push({
          id: `claude-${key}-${i}`,
          item: p.item,
          match: p.match,
          source: 'claude'
        });
      });
    });
  } catch (e) {
    console.warn('Claude mechanism games import failed:', e);
  }

  // Copilot mechanism sorters (keep each as its own puzzle)
  try {
    Object.entries(COPILOT_MECHANISM_SORTERS || {}).forEach(([name, arr]) => {
      const key = slugify(name);
      const game = ensureGame(key, {
        title: name,
        subtitle: 'Mechanism sorting (imported puzzle)',
        icon: ICONS.Activity,
        color: 'from-emerald-600 to-teal-700'
      });
      (arr || []).forEach((p, i) => {
        game.pairs.push({
          id: `copilot-${key}-${p.id || i}`,
          item: p.item,
          match: p.target,
          source: 'copilot'
        });
      });
    });
  } catch (e) {
    console.warn('Copilot mechanism sorters import failed:', e);
  }

  return out;
})();

// Normalize quiz questions into one bank
const QUIZ_BANK = (() => {
  const out = [];

  const diffMap = { easy: 1, medium: 2, hard: 3 };

  // Copilot questions
  try {
    (COPILOT_QUIZ_QUESTIONS || []).forEach(q => {
      const choices = Array.isArray(q.choices) ? q.choices.slice() : [];
      const answerText = q.a;
      let answerIndex = choices.indexOf(answerText);
      if (answerIndex < 0) answerIndex = 0;
      out.push({
        id: `copilot-${q.id || cryptoRandomId()}`,
        difficulty: Number(q.difficulty) || 2,
        question: String(q.q || ''),
        choices,
        answerIndex,
        explanation: q.explanation ? String(q.explanation) : `Correct answer: ${String(answerText)}`,
        source: 'copilot'
      });
    });
  } catch (e) {
    console.warn('Copilot quiz import failed:', e);
  }

  // Claude questions
  try {
    (CLAUDE_QUIZ_QUESTIONS || []).forEach((q, idx) => {
      const difficulty = diffMap[q.difficulty] || 2;
      const choices = Array.isArray(q.options) ? q.options.slice() : [];
      const answerIndex = (typeof q.answer === 'number') ? q.answer : 0;
      out.push({
        id: `claude-q${idx}`,
        difficulty,
        question: String(q.question || ''),
        choices,
        answerIndex,
        explanation: String(q.explanation || `Correct answer: ${choices[answerIndex] || ''}`),
        source: 'claude'
      });
    });
  } catch (e) {
    console.warn('Claude quiz import failed:', e);
  }

  // Shuffle once for randomness
  shuffleArray(out);
  return out;
})();

// Normalize disease index into one list (dedupe by name)
const DISEASE_BANK = (() => {
  const byName = new Map();

  const normalizeName = (name) => String(name || '').toLowerCase().trim();
  const normalizeText = (val) => String(val || '').trim();

  const splitBullets = (val) => {
    if (!val) return [];
    const str = String(val).replace(/\r/g, '').trim();
    if (!str) return [];
    if (str.includes('‚Ä¢')) {
      return str.replace(/\n/g, ' ').split('‚Ä¢').map(s => s.trim()).filter(Boolean);
    }
    return str.split('\n').map(s => s.trim()).filter(Boolean);
  };

  const normalizeList = (val) => {
    if (Array.isArray(val)) return val.map(v => normalizeText(v)).filter(Boolean);
    return splitBullets(val);
  };

  const labsToList = (val) => {
    if (Array.isArray(val) || typeof val === 'string') return normalizeList(val);
    if (val && typeof val === 'object') {
      return Object.entries(val)
        .map(([k, v]) => `${normalizeText(k)}: ${normalizeText(v)}`)
        .filter(item => item !== ': ' && item !== '');
    }
    return [];
  };

  const pickDetailed = (a, b) => {
    const aStr = normalizeText(a);
    const bStr = normalizeText(b);
    if (!aStr) return bStr;
    if (!bStr) return aStr;
    return bStr.length > aStr.length ? bStr : aStr;
  };

  const mergeList = (a, b) => {
    const out = Array.isArray(a) ? a.slice() : [];
    const seen = new Set(out.map(v => normalizeText(v).toLowerCase()));
    (Array.isArray(b) ? b : []).forEach(item => {
      const key = normalizeText(item).toLowerCase();
      if (!key || seen.has(key)) return;
      out.push(item);
      seen.add(key);
    });
    return out;
  };

  const addOrMerge = (entry) => {
    const key = normalizeName(entry.name);
    if (!key) return;
    const existing = byName.get(key);
    if (!existing) {
      byName.set(key, entry);
      return;
    }

    existing.type = pickDetailed(existing.type, entry.type);
    existing.etiology = pickDetailed(existing.etiology, entry.etiology);
    existing.mechanism = pickDetailed(existing.mechanism, entry.mechanism);
    existing.pathophysiology = pickDetailed(existing.pathophysiology, entry.pathophysiology);
    existing.presentation = mergeList(existing.presentation, entry.presentation);
    existing.smear = mergeList(existing.smear, entry.smear);
    existing.labs = mergeList(existing.labs, entry.labs);

    if (entry.source) {
      const sources = new Set(String(existing.source || '').split(',').map(s => s.trim()).filter(Boolean));
      sources.add(entry.source);
      existing.source = Array.from(sources).join(', ');
    }
  };

  const pushNormalized = (d, source) => {
    if (!d || !d.name) return;
    addOrMerge({
      name: String(d.name),
      type: String(d.type || ''),
      etiology: String(d.etiology || ''),
      mechanism: String(d.mechanism || ''),
      pathophysiology: String(d.pathophysiology || ''),
      presentation: normalizeList(d.presentation),
      smear: normalizeList(d.smear),
      labs: labsToList(d.labs),
      source
    });
  };

  try { (COPILOT_DISEASE_INDEX || []).forEach(d => pushNormalized(d, 'copilot')); } catch (e) {}
  try { (CLAUDE_DISEASE_INDEX || []).forEach(d => pushNormalized(d, 'Disease Table')); } catch (e) {}

  return Array.from(byName.values());
})();

const SMEAR_IMAGE_MAP = {
  normal: 'img_rbc_02',
  'sickled rbcs': 'img_rbc_35',
  'sickle cells': 'img_rbc_35',
  'target cells': 'img_rbc_24',
  spherocytes: 'img_rbc_27',
  'rbc agglutination': 'img_rbc_43',
  'bite cells': 'img_rbc_38',
  'heinz bodies': 'img_rbc_38',
  'hypersegmented neutrophils': 'img_rbc_16',
  'hypocellular marrow': 'img_rbc_05',
  'absent erythroid precursors': 'img_rbc_06',
  'microcytic hypochromic rbcs': 'img_rbc_17',
  'ring sideroblasts': 'img_rbc_09',
  schistocytes: 'img_rbc_29'
};

function getImageById(id) {
  return IMAGE_BANK_DATA.find(img => img.id === id) || MORPH_MATCH_DATA.find(img => img.id === id) || null;
}

function getSmearImage(term) {
  const key = normalizeQuery(term);
  const id = SMEAR_IMAGE_MAP[key];
  return id ? getImageById(id) : null;
}



// ===== LOCAL STORAGE KEYS =====
const LS_KEYS = {
  hiddenModules: 'hl_hidden_modules_v1',
  achievements: 'hl_achievements_v1',
  leaderboard: 'hl_leaderboard_combined_v1',
  // Legacy keys (import/migrate)
  leaderboardClaude: 'hemeLeaderboard',
  leaderboardCopilot: 'heme_leaderboard_v1'
};

const THROMBOLITIC_CATEGORY = 'Thrombolitic Disorders';

const DISORDER_MATCH_CATEGORIES = new Set([
  'Heme Synthesis',
  'Anemias: Hypoproliferative',
  'Hemolytic (Non-MAHA)',
  'MAHAs',
  'Bone Marrow Failure',
  'Coagulation & Platelets',
  'Module: Parasites',
  'Anemias',
  'Coagulation',
  THROMBOLITIC_CATEGORY
]);

const DISORDER_MATCH_MODES = [
  { id: 'etiology', label: 'Etiology' },
  { id: 'findings', label: 'Labs / Clinical' }
];

const THROMBOLITIC_MATCH_MODES = [
  { id: 'etiology', label: 'Etiology' },
  { id: 'findings', label: 'Lab/Clinical Findings' }
];

const RBC_MORPHOLOGY_CATEGORY = 'Foundations: RBC Morphology';

const RBC_MATCH_MODES = [
  { id: 'appearance', label: 'Appearance' },
  { id: 'associated', label: 'Associated Conditions' }
];

// ===== DOM REFS =====
const mainContent = document.getElementById('main-content');
const gameStats = document.getElementById('game-stats');
const progressDisplay = document.getElementById('progress-display');
const scoreDisplay = document.getElementById('score-display');
const mistakesDisplay = document.getElementById('mistakes-display');
const closeBtn = document.getElementById('close-btn');

const flowchartControls = document.getElementById('flowchart-controls');
const quizTimerEl = document.getElementById('quiz-timer');
const timerDisplay = document.getElementById('timer-display');

const imageModal = document.getElementById('image-modal');
const modalImg = document.getElementById('modal-img');
const modalTitle = document.getElementById('modal-title');
const modalDesc = document.getElementById('modal-desc');

const achievementModal = document.getElementById('achievement-modal');
const achievementIcon = document.getElementById('achievement-icon');
const achievementTitle = document.getElementById('achievement-title');
const achievementText = document.getElementById('achievement-text');

// ===== APP STATE =====
let gameState = 'menu';

// Shared scoring (per-session / per-module)
let score = 0;
let mistakes = 0;

// Hidden term-definition modules (persisted)
let hiddenModules = new Set(safeParseJSON(localStorage.getItem(LS_KEYS.hiddenModules), []));

// ----- Classic Term/Definition Matching State -----
let selectedCategory = null;
let deck = [];
let leftCol = [];
let rightCol = [];
let selectedLeft = null;
let selectedRight = null;
let matchedIds = [];
let wrongPair = null;
let disorderMatchMode = 'findings';
let rbcMatchMode = 'appearance';

// ----- Image Bank -----
let isQuizMode = false;
let imageSearchQuery = '';
let imageSearchFocus = null;
let imageSearchSelection = null;

// ----- Morphology Matching (Images) -----
let morphPairs = [];
let morphMatched = new Set();
let morphSelectedTerm = null;
let morphSelectedImage = null;
let morphWrongPair = null;
let morphTermOrder = [];
let morphImageOrder = [];

// ----- Flowchart State -----
let fcZoom = 0.45;
let fcPanX = 0;
let fcPanY = 0;
let isDraggingChart = false;
let lastMouseX = 0;
let lastMouseY = 0;
let heldItem = null;
let placedItems = {}; // { nodeId: term }

// ----- Mechanism Sorter State -----
let mechSelectedGame = null; // key in MECHANISM_GAMES
let mechPairs = [];
let mechMatched = new Set();

// ----- Quiz State (Unified) -----
let quizSession = {
  active: false,
  mode: 'fixed', // 'fixed' | 'adaptive'
  timePerQuestion: 60,
  questionCount: 5,
  fixedDifficulty: 2,   // 1..3
  adaptiveDifficulty: 2,// 1..3 (changes)
  score: 0,
  mistakes: 0,
  correct: 0,
  index: 0,
  questions: [],
  timeLeft: 60,
  timerId: null,
  allowAnswer: true
};

// ----- Disease Index State -----
let diState = {
  query: '',
  smear: '',
  type: '',
  detailIdx: null,
  highlight: true
};

// ===== LEADERBOARD (MERGED) =====
function loadLeaderboard() {
  const combined = safeParseJSON(localStorage.getItem(LS_KEYS.leaderboard), []);
  const legacyClaude = safeParseJSON(localStorage.getItem(LS_KEYS.leaderboardClaude), []);
  const legacyCopilot = safeParseJSON(localStorage.getItem(LS_KEYS.leaderboardCopilot), []);

  const normalized = [];

  // Claude legacy: unknown exact schema, but usually {name, score, difficulty, date}
  (legacyClaude || []).forEach(e => {
    if (!e) return;
    normalized.push({
      name: String(e.name || e.player || 'Anonymous'),
      score: Number(e.score) || 0,
      difficulty: String(e.difficulty || ''),
      mode: String(e.mode || ''),
      date: String(e.date || e.timestamp || new Date().toISOString()),
      source: 'claude'
    });
  });

  // Copilot legacy: {name, score, date}
  (legacyCopilot || []).forEach(e => {
    if (!e) return;
    normalized.push({
      name: String(e.name || 'Anonymous'),
      score: Number(e.score) || 0,
      difficulty: String(e.difficulty || ''),
      mode: String(e.mode || ''),
      date: String(e.date || new Date().toISOString()),
      source: 'copilot'
    });
  });

  (combined || []).forEach(e => {
    if (!e) return;
    normalized.push({
      name: String(e.name || 'Anonymous'),
      score: Number(e.score) || 0,
      difficulty: String(e.difficulty || ''),
      mode: String(e.mode || ''),
      date: String(e.date || new Date().toISOString()),
      source: 'combined'
    });
  });

  normalized.sort((a, b) => b.score - a.score);
  return normalized.slice(0, 50);
}

function saveToLeaderboard(name, scoreValue, meta = {}) {
  const entry = {
    name: String(name || 'Anonymous').slice(0, 40),
    score: Number(scoreValue) || 0,
    difficulty: meta.difficulty || '',
    mode: meta.mode || '',
    date: new Date().toISOString()
  };

  const board = loadLeaderboard();
  board.push({ ...entry, source: 'combined' });
  board.sort((a, b) => b.score - a.score);
  localStorage.setItem(LS_KEYS.leaderboard, JSON.stringify(board.slice(0, 50)));

  // Also write simplified legacy formats (for maximum compatibility)
  try {
    const c = safeParseJSON(localStorage.getItem(LS_KEYS.leaderboardCopilot), []);
    c.push({ name: entry.name, score: entry.score, date: entry.date });
    c.sort((a, b) => b.score - a.score);
    localStorage.setItem(LS_KEYS.leaderboardCopilot, JSON.stringify(c.slice(0, 50)));
  } catch {}

  try {
    const cl = safeParseJSON(localStorage.getItem(LS_KEYS.leaderboardClaude), []);
    cl.push({ name: entry.name, score: entry.score, difficulty: entry.difficulty, mode: entry.mode, date: entry.date });
    cl.sort((a, b) => b.score - a.score);
    localStorage.setItem(LS_KEYS.leaderboardClaude, JSON.stringify(cl.slice(0, 50)));
  } catch {}
}

// ===== ACHIEVEMENTS (MODAL) =====
function getAchievements() {
  return safeParseJSON(localStorage.getItem(LS_KEYS.achievements), []);
}

function hasAchievement(id) {
  return getAchievements().includes(id);
}

function markAchievement(id) {
  const current = new Set(getAchievements());
  current.add(id);
  localStorage.setItem(LS_KEYS.achievements, JSON.stringify([...current]));
}

function showAchievement(icon, title, text, achievementId = null) {
  if (achievementId) {
    if (hasAchievement(achievementId)) return;
    markAchievement(achievementId);
  }
  achievementIcon.textContent = icon;
  achievementTitle.textContent = title;
  achievementText.textContent = text;
  achievementModal.classList.remove('hidden');
  achievementModal.classList.add('flex');
}

function closeAchievement() {
  achievementModal.classList.add('hidden');
  achievementModal.classList.remove('flex');
}

// Global close on background click
achievementModal.addEventListener('click', (e) => {
  if (e.target === achievementModal) closeAchievement();
});

// Check milestone achievements across modules (non-destructive)
function checkAchievements() {
  // Score milestone
  if (score >= 1000) {
    showAchievement('üèÜ', 'Score Master!', 'You reached 1000+ points in a session.', 'score_master');
  }
  // Perfect quiz run (5/5, 0 mistakes)
  if (quizSession.active === false && quizSession.questionCount >= 5 && quizSession.correct >= 5 && quizSession.mistakes === 0) {
    showAchievement('üéØ', 'Perfect Quiz!', '5/5 correct with zero mistakes.', 'perfect_quiz');
  }
}

// Copilot badge tiers (kept as an end-of-quiz feature)
function getBadgesForScore(scoreValue) {
  const badges = [];
  if (scoreValue >= 600) badges.push({ label: 'Gold', className: 'bg-yellow-400 text-yellow-900' });
  else if (scoreValue >= 350) badges.push({ label: 'Silver', className: 'bg-slate-300 text-slate-800' });
  else if (scoreValue >= 150) badges.push({ label: 'Bronze', className: 'bg-orange-300 text-orange-900' });
  return badges;
}

// ===== HEADER CONTROLS =====
function updateHeaderControls() {
  // default hidden
  flowchartControls.classList.add('hidden');
  quizTimerEl.classList.add('hidden');
  gameStats.classList.add('hidden');
  closeBtn.classList.add('hidden');

  if (gameState === 'menu') return;

  closeBtn.classList.remove('hidden');

  if (gameState === 'flowchart') {
    flowchartControls.classList.remove('hidden');
    return;
  }

  if (gameState === 'imagebank' || gameState === 'morphmatch' || gameState === 'index' || gameState === 'mechanism' || gameState === 'playing' || gameState === 'game-end' || gameState === 'quiz') {
    gameStats.classList.remove('hidden');
  }

  if (gameState === 'quiz' && quizSession.active) {
    quizTimerEl.classList.remove('hidden');
  }

  updateStats();
}

function updateStats() {
  // Score/mistakes are global shared; keep in header
  scoreDisplay.textContent = String(score);
  mistakesDisplay.textContent = String(mistakes);

  let progressText = '';
  switch (gameState) {
    case 'playing':
      progressText = `${matchedIds.length} / ${deck.length}`;
      break;
    case 'mechanism':
      progressText = mechSelectedGame ? `${mechMatched.size} / ${mechPairs.length}` : 'Select puzzle';
      break;
    case 'morphmatch':
      progressText = `${morphMatched.size} / ${morphPairs.length}`;
      break;
    case 'quiz':
      progressText = quizSession.active ? `${quizSession.index + 1} / ${quizSession.questions.length}` : 'Quiz setup';
      break;
    default:
      progressText = '';
  }
  progressDisplay.textContent = progressText;
}

function setMainOverflow() {
  if (gameState === 'flowchart') {
    mainContent.classList.remove('overflow-y-auto');
    mainContent.classList.add('overflow-hidden');
  } else {
    mainContent.classList.remove('overflow-hidden');
    mainContent.classList.add('overflow-y-auto');
  }
}

function updateUI() {
  setMainOverflow();
  updateHeaderControls();

  switch (gameState) {
    case 'menu':
      renderMenu(); break;
    case 'playing':
      renderBoard(); break;
    case 'flowchart':
      renderFlowchart(); break;
    case 'imagebank':
      renderImageBank(); break;
    case 'morphmatch':
      renderMorphMatch(); break;
    case 'mechanism':
      renderMechanism(); break;
    case 'quiz':
      renderQuiz(); break;
    case 'index':
      renderDiseaseIndex(); break;
    case 'game-end':
      renderGameEnd(); break;
    default:
      gameState = 'menu';
      renderMenu();
  }
}

// ===== NAVIGATION =====
function goToMenu() {
  stopQuizTimer();
  gameState = 'menu';
  // Reset per-module selection states (non-destructive)
  mechSelectedGame = null;
  diState.detailIdx = null;
  morphPairs = [];
  morphMatched = new Set();
  morphSelectedTerm = null;
  morphSelectedImage = null;
  morphWrongPair = null;
  morphTermOrder = [];
  morphImageOrder = [];
  updateUI();
}

function toggleModule(catId) {
  if (hiddenModules.has(catId)) hiddenModules.delete(catId);
  else hiddenModules.add(catId);
  localStorage.setItem(LS_KEYS.hiddenModules, JSON.stringify([...hiddenModules]));
  renderMenu();
}



// ===== MENU =====
function renderLeaderboardPreview(maxRows = 10) {
  const board = loadLeaderboard().slice(0, maxRows);
  if (!board.length) {
    return `<div class="p-4 bg-white rounded-xl border border-slate-200 text-slate-500">No leaderboard entries yet.</div>`;
  }
  return `
    <div class="overflow-hidden bg-white rounded-xl border border-slate-200">
      <div class="px-4 py-3 bg-slate-50 border-b border-slate-200 font-bold text-slate-700 flex items-center gap-2">
        ${ICONS.TrophyBig} Leaderboard
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="text-left text-slate-500 bg-white">
              <th class="px-4 py-2">#</th>
              <th class="px-4 py-2">Name</th>
              <th class="px-4 py-2">Score</th>
              <th class="px-4 py-2 hidden sm:table-cell">Meta</th>
            </tr>
          </thead>
          <tbody>
            ${board.map((e, i) => `
              <tr class="border-t border-slate-100">
                <td class="px-4 py-2 font-semibold text-slate-500">${i + 1}</td>
                <td class="px-4 py-2 font-semibold text-slate-800">${escapeHtml(e.name)}</td>
                <td class="px-4 py-2 font-bold text-blue-600">${e.score}</td>
                <td class="px-4 py-2 text-slate-500 hidden sm:table-cell">${escapeHtml([e.mode, e.difficulty].filter(Boolean).join(' ‚Ä¢ '))}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;
}

function renderMenu() {
  mainContent.className = 'w-full flex-grow relative overflow-y-auto bg-gradient-to-br from-slate-50 to-blue-50 px-4 py-8';

  const hiddenCount = hiddenModules.size;
  const achievements = getAchievements();

  mainContent.innerHTML = `
    <div class="max-w-7xl mx-auto animate-fadeIn">
      <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-6 mb-10">
        <div>
          <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white border border-slate-200 text-slate-600 text-xs font-bold mb-3">
            ${ICONS.Sparkles} Combined Platform
          </div>
          <h2 class="text-4xl font-extrabold text-slate-900 leading-tight">Heme-Lymph Match</h2>
          <p class="text-slate-600 mt-3 max-w-2xl">
            Matching decks, diagnostic flowchart, image bank, morphology matching, mechanism sorters, adaptive quizzes, and a searchable disease index.
          </p>
          <div class="mt-4 flex flex-wrap gap-2 text-xs font-bold text-slate-600">
            <span class="px-3 py-1 rounded-full bg-white border border-slate-200">${FULL_DATA.length} cards</span>
            <span class="px-3 py-1 rounded-full bg-white border border-slate-200">${IMAGE_BANK_DATA.length} images</span>
            <span class="px-3 py-1 rounded-full bg-white border border-slate-200">${MORPH_MATCH_DATA.length} morphology images</span>
            <span class="px-3 py-1 rounded-full bg-white border border-slate-200">${Object.keys(MECHANISM_GAMES).length} mechanism sets</span>
            <span class="px-3 py-1 rounded-full bg-white border border-slate-200">${QUIZ_BANK.length} quiz questions</span>
            <span class="px-3 py-1 rounded-full bg-white border border-slate-200">${DISEASE_BANK.length} index entries</span>
          </div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-3 gap-3 w-full lg:w-auto">
          <button onclick="startFlowchart()" class="p-4 bg-white rounded-2xl border border-slate-200 shadow-sm hover:shadow-md transition-all text-left group">
            <div class="p-3 rounded-xl bg-indigo-100 text-indigo-700 w-fit mb-3 group-hover:scale-110 transition-transform">${ICONS.GitBranch}</div>
            <div class="font-bold text-slate-800">Flowchart</div>
            <div class="text-xs font-semibold text-slate-500 mt-1">Interactive algorithm</div>
          </button>

          <button onclick="startImageBank()" class="p-4 bg-white rounded-2xl border border-slate-200 shadow-sm hover:shadow-md transition-all text-left group">
            <div class="p-3 rounded-xl bg-rose-100 text-rose-700 w-fit mb-3 group-hover:scale-110 transition-transform">${ICONS.Image}</div>
            <div class="font-bold text-slate-800">Image Bank</div>
            <div class="text-xs font-semibold text-slate-500 mt-1">Morphology review</div>
          </button>

          <button onclick="startMorphMatch()" class="p-4 bg-white rounded-2xl border border-slate-200 shadow-sm hover:shadow-md transition-all text-left group">
            <div class="p-3 rounded-xl bg-amber-100 text-amber-700 w-fit mb-3 group-hover:scale-110 transition-transform">${ICONS.Microscope}</div>
            <div class="font-bold text-slate-800">Morphology Matching (Images)</div>
            <div class="text-xs font-semibold text-slate-500 mt-1">Match labels to unlabeled images</div>
          </button>

          <button onclick="startMechanismMenu()" class="p-4 bg-white rounded-2xl border border-slate-200 shadow-sm hover:shadow-md transition-all text-left group">
            <div class="p-3 rounded-xl bg-emerald-100 text-emerald-700 w-fit mb-3 group-hover:scale-110 transition-transform">${ICONS.Activity}</div>
            <div class="font-bold text-slate-800">Mechanisms</div>
            <div class="text-xs font-semibold text-slate-500 mt-1">Sorter puzzles</div>
          </button>

          <button onclick="startQuizCenter()" class="p-4 bg-white rounded-2xl border border-slate-200 shadow-sm hover:shadow-md transition-all text-left group">
            <div class="p-3 rounded-xl bg-yellow-100 text-yellow-700 w-fit mb-3 group-hover:scale-110 transition-transform">${ICONS.Brain}</div>
            <div class="font-bold text-slate-800">Quiz Center</div>
            <div class="text-xs font-semibold text-slate-500 mt-1">Fixed + adaptive</div>
          </button>

          <button onclick="startDiseaseIndex()" class="p-4 bg-white rounded-2xl border border-slate-200 shadow-sm hover:shadow-md transition-all text-left group">
            <div class="p-3 rounded-xl bg-cyan-100 text-cyan-700 w-fit mb-3 group-hover:scale-110 transition-transform">${ICONS.Database}</div>
            <div class="font-bold text-slate-800">Disease Index</div>
            <div class="text-xs font-semibold text-slate-500 mt-1">Search & filters</div>
          </button>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-10">
        <div class="lg:col-span-2">
          <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6">
            <div class="flex items-center justify-between gap-3 mb-4">
              <div>
                <h3 class="text-xl font-extrabold text-slate-900">Classic Matching Decks</h3>
                <p class="text-slate-500 text-sm mt-1">Term ‚Üî definition matching (click-to-match). Hide decks to exclude them from the Master Exam.</p>
              </div>
              ${hiddenCount ? `<div class="text-xs font-bold text-slate-600 bg-slate-100 px-3 py-1 rounded-full">${hiddenCount} hidden</div>` : ''}
            </div>

            ${renderCategoryGroups(false)}

            ${hiddenCount ? `
              <div class="mt-8">
                <div class="flex items-center justify-between mb-3">
                  <h4 class="text-sm font-bold text-slate-500 uppercase tracking-wider">Hidden Decks</h4>
                  <button onclick="hiddenModules = new Set(); localStorage.setItem(LS_KEYS.hiddenModules, JSON.stringify([])); renderMenu();" class="text-xs font-bold text-slate-600 hover:text-slate-900">Show all</button>
                </div>
                ${renderCategoryGroups(true)}
              </div>
            ` : ''}
          </div>
        </div>

        <div class="space-y-6">
          ${renderLeaderboardPreview(10)}

          <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6">
            <div class="flex items-center gap-2 mb-2 font-bold text-slate-800">${ICONS.Sparkles} Progress</div>
            <div class="text-sm text-slate-600">Achievements unlocked: <span class="font-bold">${achievements.length}</span></div>
            <div class="text-xs text-slate-500 mt-2">Achievements persist in your browser storage.</div>
            <div class="mt-4 flex flex-wrap gap-2">
              ${achievements.length ? achievements.slice(0, 10).map(a => `<span class="px-2 py-1 rounded-full text-xs font-bold bg-slate-100 text-slate-700">${escapeHtml(a)}</span>`).join('') : `<span class="text-sm text-slate-500">None yet.</span>`}
            </div>
          </div>
        </div>
      </div>

      <div class="text-xs text-slate-500">
        Tip: Most modules use localStorage for saves (hidden decks, leaderboard, achievements).
      </div>
    </div>
  `;
}

function renderCategoryGroups(renderHidden) {
  // Base deck menu from Gemini, with an extra "Imported Quick Decks" group to preserve added categories
  const GROUPS = [
    { title: "Red Cell Disorders", items: [
      { id: 'Heme Synthesis', label: 'Heme Synthesis (Porphyrias)', icon: 'Activity', color: 'bg-purple-600' },
      { id: 'Anemias: Hypoproliferative', label: 'Hypoproliferative Anemias', icon: 'Droplet', color: 'bg-red-500' },
      { id: 'Hemolytic (Non-MAHA)', label: 'Hemolytic Anemias (Non-MAHA)', icon: 'Droplet', color: 'bg-red-600' },
      { id: 'MAHAs', label: 'Microangiopathic Hemolytic Anemias', icon: 'ShieldAlert', color: 'bg-orange-600' },
      { id: 'Bone Marrow Failure', label: 'Bone Marrow Failure', icon: 'Activity', color: 'bg-slate-600' },
    ]},
    { title: "Hemostasis & Thrombosis", items: [
      { id: 'Coagulation & Platelets', label: 'Coagulation & Platelet Disorders', icon: 'ShieldAlert', color: 'bg-blue-600' },
      { id: 'Thrombolitic Disorders', label: 'Thrombolitic Disorders', icon: 'ShieldAlert', color: 'bg-teal-600' },
      { id: 'Hemostasis Essentials', label: 'Hemostasis Essentials (Matching)', icon: 'Activity', color: 'bg-indigo-600' },
      { id: 'Foundations: Labs', label: 'Lab Diagnostics', icon: 'FlaskConical', color: 'bg-cyan-600' },
    ]},
    { title: "Others", items: [
      { id: 'Pharmacology', label: 'Pharmacology', icon: 'Pill', color: 'bg-emerald-600' },
      { id: 'Module: Parasites', label: 'Parasites & Malaria', icon: 'Bug', color: 'bg-lime-600' },
      { id: 'Foundations: RBC Morphology', label: 'RBC Morphology', icon: 'Droplet', color: 'bg-rose-500' }
    ]},
    { title: "Imported Quick Decks", items: [
      { id: 'Anemias', label: 'Quick Deck: Anemias', icon: 'Droplet', color: 'bg-rose-600' },
      { id: 'Coagulation', label: 'Quick Deck: Coagulation', icon: 'ShieldAlert', color: 'bg-sky-600' }
    ]},
    { title: "Comprehensive", items: [
      { id: 'All', label: 'Master Exam (All Visible Content)', icon: 'TrophyBig', color: 'bg-slate-800' }
    ]}
  ];

  let html = '';
  GROUPS.forEach(group => {
    const items = group.items.filter(cat => {
      const isHidden = hiddenModules.has(cat.id);
      return renderHidden ? isHidden : !isHidden;
    });

    if (!items.length) return;

    html += `
      <div class="mb-6">
        <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-3 px-2">${escapeHtml(group.title)}</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-4">
          ${items.map(cat => {
            const isMaster = cat.id === 'All';
            const isHidden = hiddenModules.has(cat.id);

            let count = 0;
            if (isMaster) count = FULL_DATA.filter(i => !hiddenModules.has(i.category)).length;
            else count = FULL_DATA.filter(i => i.category === cat.id).length;

            const icon = ICONS[cat.icon] || ICONS.Activity;

            const clickHandler = isHidden ? '' : `onclick="startGame('${escapeJs(cat.id)}')"`;
            const cursorClass = isHidden ? 'cursor-not-allowed' : 'cursor-pointer hover:shadow-md hover:border-blue-300';
            const opacityClass = isHidden ? 'opacity-60 bg-slate-50' : 'bg-white';

            return `
              <div class="relative group">
                <button ${clickHandler}
                        class="w-full flex items-start gap-3 p-4 rounded-xl border border-slate-200 shadow-sm transition-all text-left ${cursorClass} ${opacityClass}">
                  <div class="p-3 rounded-lg ${cat.color} text-white w-fit group-hover:scale-110 transition-transform shadow-sm shrink-0">${icon}</div>
                  <div class="min-w-0">
                    <h3 class="font-bold text-slate-800 leading-tight">${escapeHtml(cat.label)}</h3>
                    <div class="text-xs font-semibold text-slate-400 mt-1 uppercase tracking-wide">${count} Cards</div>
                  </div>
                </button>

                ${!isMaster ? `
                  <button onclick="event.stopPropagation(); toggleModule('${escapeJs(cat.id)}')"
                          class="absolute top-2 right-2 p-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-slate-400 hover:text-slate-700 transition-colors z-10"
                          title="${isHidden ? 'Show Module' : 'Hide Module'}">
                    ${isHidden ? ICONS.EyeOff : ICONS.Eye}
                  </button>
                ` : ''}
              </div>
            `;
          }).join('')}
        </div>
      </div>
    `;
  });

  return html || `<div class="p-4 bg-slate-50 rounded-xl border border-slate-200 text-slate-500">No decks to show.</div>`;
}

function isDisorderMatchCategory(catId) {
  return DISORDER_MATCH_CATEGORIES.has(catId);
}

function isRbcMorphologyCategory(catId) {
  return catId === RBC_MORPHOLOGY_CATEGORY;
}

function splitRbcDefinition(def) {
  const parts = String(def || '').split(/<br\s*\/?>\s*<br\s*\/?>/i);
  const appearance = (parts[0] || '').trim();
  const associated = parts.slice(1).join('<br><br>').trim();
  return { appearance, associated };
}

function getMatchText(item) {
  if (isRbcMorphologyCategory(selectedCategory)) {
    const { appearance, associated } = splitRbcDefinition(item.def || '');
    if (rbcMatchMode === 'associated') {
      if (item.term === 'Normal Morphology') {
        return 'Normal appearance; no associated conditions';
      }
      return associated || '';
    }
    return appearance || item.def || '';
  }
  if (isDisorderMatchCategory(selectedCategory) && (item.etiology || item.findings)) {
    return disorderMatchMode === 'etiology'
      ? (item.etiology || item.def || '')
      : (item.findings || item.def || '');
  }
  return item.def || '';
}

function setDisorderMatchMode(mode) {
  if (mode === disorderMatchMode) return;
  disorderMatchMode = mode;
  if (selectedCategory) startGame(selectedCategory);
}

function setRbcMatchMode(mode) {
  if (mode === rbcMatchMode) return;
  rbcMatchMode = mode;
  if (selectedCategory) startGame(selectedCategory);
}


function startGame(catId) {
            stopQuizTimer();
            // Check if user is trying to start a hidden module directly (e.g. from the list)
            // But UI disables hidden ones anyway. Just a safety check.
            if (hiddenModules.has(catId)) return;

            selectedCategory = catId;
            let filtered = catId === 'All' ? [...FULL_DATA] : FULL_DATA.filter(item => item.category === catId);
            
            // If Master Exam, remove hidden modules
            if (catId === 'All') {
                filtered = filtered.filter(item => !hiddenModules.has(item.category));
            }

            if (filtered.length === 0) {
                alert("No cards available in this selection!");
                return;
            }

            filtered.sort(() => 0.5 - Math.random());
            deck = filtered.map((item, idx) => ({ ...item, id: `item-${idx}` }));
            
            score = 0;
            mistakes = 0;
            matchedIds = [];
            leftCol = [...deck].sort((a, b) => String(a.term || '').localeCompare(String(b.term || ''), undefined, { sensitivity: 'base' }));
            rightCol = [...deck].sort(() => 0.5 - Math.random());
            selectedLeft = null;
            selectedRight = null;
            wrongPair = null;
            
            gameState = 'playing';
            updateUI();
        }

function handleLeftClick(id, term, def) {
            if (matchedIds.includes(id) || wrongPair) return;
            selectedLeft = (selectedLeft === id) ? null : id;
            checkMatch();
            renderBoard();
        }

function handleRightClick(id, term, def) {
            if (matchedIds.includes(id) || wrongPair) return;
            selectedRight = (selectedRight === id) ? null : id;
            checkMatch();
            renderBoard();
        }

function checkMatch() {
            if (!selectedLeft || !selectedRight) return;
            const leftId = selectedLeft;
            const rightId = selectedRight;

            if (leftId === rightId) {
                matchedIds.push(leftId);
                score += 100;
                checkAchievements();
                selectedLeft = null;
                selectedRight = null;
                updateStats();
                if (matchedIds.length === deck.length) setTimeout(() => { gameState = 'game-end'; updateUI(); }, 800);
            } else {
                wrongPair = { left: leftId, right: rightId };
                mistakes++;
                updateStats();
                renderBoard();
                setTimeout(() => {
                    selectedLeft = null;
                    selectedRight = null;
                    wrongPair = null;
                    renderBoard();
                }, 1000);
            }
        }

function renderBoard() {
             mainContent.classList.remove('bg-slate-200'); 
             mainContent.classList.add('px-4', 'max-w-6xl', 'mx-auto'); 
            
            const isDisorderDeck = isDisorderMatchCategory(selectedCategory);
            const isThromboliticDeck = selectedCategory === THROMBOLITIC_CATEGORY;
            const isRbcDeck = isRbcMorphologyCategory(selectedCategory);
            const disorderModes = isThromboliticDeck ? THROMBOLITIC_MATCH_MODES : DISORDER_MATCH_MODES;
            const leftHeader = isDisorderDeck
              ? 'Disorders'
              : (isRbcDeck ? 'Morphology Term' : 'Term / Intervention');
            const rightHeader = isDisorderDeck
              ? (disorderMatchMode === 'etiology' ? 'Etiology' : (isThromboliticDeck ? 'Lab/Clinical Findings' : 'Labs / Clinical'))
              : (isRbcDeck ? (rbcMatchMode === 'appearance' ? 'Appearance' : 'Associated Conditions') : 'Indication / Pattern');
            const matchModeControls = isDisorderDeck ? `
                <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
                    <div class="text-xs font-bold text-slate-500 uppercase tracking-wider">Match to</div>
                    <div class="flex flex-wrap gap-2">
                        ${disorderModes.map(mode => `
                            <button onclick="setDisorderMatchMode('${mode.id}')"
                                class="px-3 py-1.5 rounded-full text-xs font-bold border transition-colors ${disorderMatchMode === mode.id ? 'bg-slate-900 text-white border-slate-900' : 'bg-white text-slate-600 border-slate-200 hover:border-slate-400'}">
                                ${mode.label}
                            </button>
                        `).join('')}
                    </div>
                </div>
            ` : (isRbcDeck ? `
                <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
                    <div class="text-xs font-bold text-slate-500 uppercase tracking-wider">Match to</div>
                    <div class="flex flex-wrap gap-2">
                        ${RBC_MATCH_MODES.map(mode => `
                            <button onclick="setRbcMatchMode('${mode.id}')"
                                class="px-3 py-1.5 rounded-full text-xs font-bold border transition-colors ${rbcMatchMode === mode.id ? 'bg-slate-900 text-white border-slate-900' : 'bg-white text-slate-600 border-slate-200 hover:border-slate-400'}">
                                ${mode.label}
                            </button>
                        `).join('')}
                    </div>
                </div>
            ` : '');
             
            let html = `
                <div class="animate-fadeIn pb-12">
                    ${matchModeControls}
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-12 relative">
                        
                        <!-- LEFT COL -->
                        <div class="flex flex-col gap-3">
                            <h3 class="text-slate-400 font-bold uppercase text-xs tracking-wider mb-2 text-center md:text-left sticky top-0 bg-slate-50 py-2 z-10">${leftHeader}</h3>
            `;

            leftCol.forEach(item => {
                const isMatched = matchedIds.includes(item.id);
                const isSelected = selectedLeft === item.id;
                const isError = wrongPair?.left === item.id;
                
                let btnClass = "card-btn w-full text-left p-4 rounded-xl border-2 transition-all relative flex items-center justify-between min-h-[4rem] ";
                let textClass = "font-bold text-sm md:text-base ";

                if (isMatched) {
                    btnClass += "bg-slate-50 border-slate-100 text-slate-300 opacity-50 cursor-default";
                    textClass += "line-through";
                } else if (isError) {
                    btnClass += "bg-red-50 border-red-500 animate-shake z-10";
                    textClass += "text-slate-800";
                } else if (isSelected) {
                    btnClass += "bg-blue-50 border-blue-500 shadow-md z-10";
                    textClass += "text-slate-800";
                } else {
                    btnClass += "bg-white border-slate-200 hover:border-blue-300 hover:shadow-sm";
                    textClass += "text-slate-800";
                }

                html += `
                    <button onclick="handleLeftClick('${item.id}', '${item.term}', '${item.def}')" ${isMatched ? 'disabled' : ''} class="${btnClass}">
                        <span class="${textClass}">${item.term}</span>
                    </button>
                `;
            });

            html += `</div>`; // End Left Col

            html += `<div class="hidden md:block absolute left-1/2 top-10 bottom-4 w-px bg-slate-200 -translate-x-1/2"></div>`;

            // RIGHT COL
            html += `<div class="flex flex-col gap-3">
                        <h3 class="text-slate-400 font-bold uppercase text-xs tracking-wider mb-2 text-center md:text-left sticky top-0 bg-slate-50 py-2 z-10">${rightHeader}</h3>`;

            rightCol.forEach(item => {
                const isMatched = matchedIds.includes(item.id);
                const isSelected = selectedRight === item.id;
                const isError = wrongPair?.right === item.id;

                let btnClass = "card-btn w-full text-left p-4 rounded-xl border-2 transition-all min-h-[4rem] flex items-center ";
                let textClass = "text-sm leading-snug ";

                if (isMatched) {
                    btnClass += "bg-slate-50 border-slate-100 text-slate-300 opacity-50 cursor-default";
                    textClass += "line-through";
                } else if (isError) {
                    btnClass += "bg-red-50 border-red-500 animate-shake z-10";
                    textClass += "text-slate-600 font-medium";
                } else if (isSelected) {
                    btnClass += "bg-blue-50 border-blue-500 shadow-md z-10";
                    textClass += "text-slate-600 font-medium";
                } else {
                    btnClass += "bg-white border-slate-200 hover:border-blue-300 hover:shadow-sm";
                    textClass += "text-slate-600 font-medium";
                }

                html += `
                    <button onclick="handleRightClick('${item.id}', '${item.term}', '${item.def}')" ${isMatched ? 'disabled' : ''} class="${btnClass}">
                        <span class="${textClass}">${getMatchText(item)}</span>
                    </button>
                `;
            });

            html += `</div></div></div>`;
            mainContent.innerHTML = html;
        }

function renderGameEnd() {
            mainContent.classList.remove('bg-slate-200'); 
            mainContent.classList.add('px-4', 'max-w-6xl', 'mx-auto'); 
            
            mainContent.innerHTML = `
                <div class="flex flex-col items-center justify-center min-h-[60vh] animate-popIn">
                    <div class="bg-yellow-100 text-yellow-600 p-6 rounded-full mb-6">
                        ${ICONS.TrophyBig}
                    </div>
                    <h2 class="text-4xl font-extrabold text-slate-800 mb-4">Module Complete!</h2>
                    
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 w-full max-w-sm mb-8">
                        <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-4">
                            <span class="text-slate-500 font-medium">Final Score</span>
                            <span class="text-2xl font-bold text-blue-600">${score}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-slate-500 font-medium">Mistakes</span>
                            <span class="text-2xl font-bold ${mistakes === 0 ? 'text-green-500' : 'text-red-500'}">
                                ${mistakes}
                            </span>
                        </div>
                    </div>

                    <div class="flex gap-4">
                        <button onclick="goToMenu()" class="px-6 py-3 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded-xl font-bold transition-colors">
                            Back to Menu
                        </button>
                        <button onclick="startGame('${escapeJs(selectedCategory)}')" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold transition-colors flex items-center gap-2">
                            ${ICONS.RotateCcw} Replay
                        </button>
                    </div>
                </div>
            `;
        }

function startFlowchart() {
            stopQuizTimer();
            gameState = 'flowchart';
            fcZoom = 0.45; 
            fcPanX = 0;
            fcPanY = 0;
            placedItems = {};
            heldItem = null;
            score = 0;
            mistakes = 0;
            updateUI();
        }

function pickupItem(answer) {
            if (heldItem === answer) {
                heldItem = null;
            } else {
                heldItem = answer;
            }
            renderFlowchart();
        }

function placeItem(zoneId, correctAnswer) {
            if (!heldItem) return;

            if (heldItem === correctAnswer) {
                placedItems[zoneId] = heldItem;
                heldItem = null;
                score += 50;
                const totalDrops = FLOWCHART_NODES.filter(n => n.type === 'drop').length;
                if (Object.keys(placedItems).length === totalDrops) {
                    setTimeout(() => alert("Flowchart Complete! Great job."), 500);
                }
            } else {
                alert("Incorrect placement. Try again.");
            }
            renderFlowchart();
        }

function adjustZoom(delta) {
            fcZoom = Math.max(0.4, Math.min(2.0, fcZoom + delta));
            renderFlowchart();
        }

function resetZoom() {
            fcZoom = 0.45;
            fcPanX = 0;
            fcPanY = 0;
            renderFlowchart();
        }

function handleChartMouseDown(e) {
            if (e.target.closest('.interactive-el')) return; 
            isDraggingChart = true;
            lastMouseX = e.clientX;
            lastMouseY = e.clientY;
            const container = document.getElementById('fc-container');
            container.style.cursor = 'grabbing';
        }

function handleChartMouseMove(e) {
            if (!isDraggingChart) return;
            e.preventDefault();
            const dx = e.clientX - lastMouseX;
            const dy = e.clientY - lastMouseY;
            fcPanX += dx;
            fcPanY += dy;
            lastMouseX = e.clientX;
            lastMouseY = e.clientY;
            
            const content = document.getElementById('fc-content');
            content.style.transform = `translate(${fcPanX}px, ${fcPanY}px) scale(${fcZoom})`;
        }

function handleChartMouseUp() {
            isDraggingChart = false;
            const container = document.getElementById('fc-container');
            if (container) container.style.cursor = 'grab';
        }

function renderFlowchart() {
            mainContent.classList.remove('px-4', 'max-w-6xl');
            mainContent.classList.add('bg-slate-200'); 
            mainContent.innerHTML = '';

            const bankItems = FLOWCHART_NODES
                .filter(n => n.type === 'drop')
                .map(n => n.answer)
                .filter((v, i, a) => a.indexOf(v) === i)
                .sort();

            const sidebarHTML = `
                <div class="absolute left-4 top-4 bottom-4 w-64 bg-white/90 backdrop-blur rounded-2xl shadow-xl z-20 flex flex-col overflow-hidden border border-slate-200">
                    <div class="p-4 bg-slate-50 border-b border-slate-200">
                        <h3 class="font-bold text-slate-800">Term Bank</h3>
                        <p class="text-xs text-slate-500">Tap to pickup, Tap blank to place</p>
                    </div>
                    <div class="p-2 overflow-y-auto flex-grow space-y-2">
                        ${bankItems.map(term => {
                            const totalNeeded = FLOWCHART_NODES.filter(n => n.answer === term).length;
                            const currentPlaced = Object.values(placedItems).filter(v => v === term).length;
                            const isDone = currentPlaced >= totalNeeded;
                            const isHeld = heldItem === term;

                            return `
                                <button 
                                    onclick="pickupItem('${term}')"
                                    class="w-full text-left p-3 text-sm font-semibold rounded-lg transition-all
                                    ${isDone ? 'bg-slate-100 text-slate-400 line-through' : 
                                      isHeld ? 'bg-blue-600 text-white shadow-lg scale-105 ring-2 ring-blue-300' : 
                                      'bg-white border border-slate-200 hover:bg-blue-50 hover:border-blue-300 text-slate-700 shadow-sm'}
                                    "
                                    ${isDone ? 'disabled' : ''}
                                >
                                    ${term}
                                </button>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;

            let chartHTML = '';
            
            // Draw Connectors first (behind nodes)
            let connectorsHTML = '';
            FLOWCHART_CONNECTIONS.forEach(conn => {
                const source = FLOWCHART_NODES.find(n => n.id === conn.from);
                const dest = FLOWCHART_NODES.find(n => n.id === conn.to);
                
                if (source && dest) {
                    // Coordinates scaled by 200 (X) and 120 (Y) approx
                    const sx = source.x * 220 + ((source.w * 220) - 20) / 2;
                    const sy = source.y * 140 + 80; // Bottom of source
                    const dx = dest.x * 220 + ((dest.w * 220) - 20) / 2;
                    const dy = dest.y * 140;      // Top of dest
                    
                    connectorsHTML += `
                        <line x1="${sx}" y1="${sy}" x2="${dx}" y2="${dy}" stroke="#94a3b8" stroke-width="2" marker-end="url(#arrow)" />
                    `;
                }
            });

            // Draw Nodes
            FLOWCHART_NODES.forEach(node => {
                const left = node.x * 220;
                const top = node.y * 140;
                const width = (node.w * 220) - 20; 
                
                let content = '';
                if (node.type === 'label') {
                    content = `
                        <div class="absolute flex items-center justify-center p-2 text-center rounded-xl shadow-sm border-2 font-bold text-slate-700 leading-tight
                                    ${node.color || 'bg-white border-slate-200'}"
                             style="left: ${left}px; top: ${top}px; width: ${width}px; height: 80px;">
                            ${node.text}
                        </div>
                    `;
                } else if (node.type === 'drop') {
                    const isFilled = placedItems[node.id];
                    const isActive = heldItem && !isFilled;
                    content = `
                        <div onclick="placeItem('${node.id}', '${node.answer}')"
                             class="interactive-el absolute flex items-center justify-center p-2 text-center rounded-xl border-2 font-bold text-sm transition-all drop-zone
                                    ${isFilled 
                                        ? (node.isFinal ? 'bg-green-100 border-green-500 text-green-800' : 'bg-blue-100 border-blue-500 text-blue-800')
                                        : 'bg-white border-dashed border-slate-300 text-slate-400 hover:border-blue-400 cursor-pointer'}
                                    ${isActive ? 'animate-pulse bg-blue-50' : ''}"
                             style="left: ${left}px; top: ${top}px; width: ${width}px; height: 80px;">
                            ${isFilled ? isFilled : (isActive ? 'Place Here' : '?')}
                        </div>
                    `;
                }
                chartHTML += content;
            });

            const svgLines = `
                <svg class="absolute top-0 left-0 w-full h-full pointer-events-none" style="z-index: 0;">
                    <defs>
                        <marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                            <path d="M0,0 L0,6 L9,3 z" fill="#94a3b8" />
                        </marker>
                    </defs>
                    ${connectorsHTML}
                </svg>
            `;

            mainContent.innerHTML = `
                ${sidebarHTML}
                <div id="fc-container" class="w-full h-full overflow-hidden relative flowchart-container"
                     onmousedown="handleChartMouseDown(event)"
                     onmousemove="handleChartMouseMove(event)"
                     onmouseup="handleChartMouseUp()"
                     onmouseleave="handleChartMouseUp()">
                     
                    <div id="fc-content" style="transform: translate(${fcPanX}px, ${fcPanY}px) scale(${fcZoom}); width: 4200px; height: 2000px; position: relative;">
                        ${svgLines}
                        ${chartHTML}
                    </div>
                </div>
            `;
        }


// ===== IMAGE MODAL =====
function openImageModal(src, title, desc, meta) {
  modalImg.src = src;
  modalTitle.textContent = title || '';
  modalDesc.innerHTML = buildImageModalDescription(meta, desc);
  imageModal.classList.remove('hidden');
  imageModal.classList.add('flex');
}
function closeImageModal() {
  imageModal.classList.add('hidden');
  imageModal.classList.remove('flex');
  modalImg.src = '';
  modalDesc.innerHTML = '';
}
imageModal.addEventListener('click', (e) => {
  if (e.target === imageModal) closeImageModal();
});

// ===== IMAGE BANK =====
function startImageBank() {
  stopQuizTimer();
  gameState = 'imagebank';
  score = 0;
  mistakes = 0;
  imageSearchQuery = '';
  imageSearchFocus = null;
  imageSearchSelection = null;
  updateUI();
}

function toggleQuizMode() {
  isQuizMode = !isQuizMode;
  renderImageBank();
}

function setImageSearch(val) {
  const input = document.getElementById('image-search');
  if (input) {
    imageSearchSelection = {
      start: input.selectionStart,
      end: input.selectionEnd
    };
  }
  imageSearchQuery = String(val || '');
  imageSearchFocus = 'search';
  renderImageBank();
}

function restoreImageSearchFocus() {
  if (imageSearchFocus !== 'search') return;
  const input = document.getElementById('image-search');
  if (!input) return;
  input.focus();
  if (imageSearchSelection && typeof input.setSelectionRange === 'function') {
    input.setSelectionRange(
      Number.isInteger(imageSearchSelection.start) ? imageSearchSelection.start : input.value.length,
      Number.isInteger(imageSearchSelection.end) ? imageSearchSelection.end : input.value.length
    );
  }
}

function openImageByIndex(idx) {
  const i = Number(idx);
  const img = IMAGE_BANK_DATA[i];
  if (!img) return;
  openImageModal(img.src, img.title, img.desc, img);
}

function renderImageBank() {
  mainContent.className = 'w-full flex-grow relative overflow-y-auto bg-gradient-to-br from-slate-50 to-rose-50 px-4 py-8';

  const q = normalizeQuery(imageSearchQuery);
  const filtered = IMAGE_BANK_DATA.map((img, idx) => ({ img, idx }))
    .filter(({ img }) => {
      if (!q) return true;
      const conditions = Array.isArray(img.conditions) ? img.conditions.join(' ') : (img.conditions || '');
      const hay = `${img.title || ''} ${img.desc || ''} ${img.appearance || ''} ${conditions} ${img.mechanism || ''}`.toLowerCase();
      return hay.includes(q);
    });

  mainContent.innerHTML = `
    <div class="max-w-7xl mx-auto animate-fadeIn">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
        <div>
          <h2 class="text-3xl font-extrabold text-slate-900">Image Bank</h2>
          <div class="text-sm text-slate-600 mt-1">${filtered.length} / ${IMAGE_BANK_DATA.length} images</div>
        </div>

        <div class="flex flex-col sm:flex-row gap-3 sm:items-center">
          <div class="relative">
            <input id="image-search" value="${escapeHtml(imageSearchQuery)}" oninput="setImageSearch(this.value)" placeholder="Search title/description‚Ä¶" class="w-full sm:w-80 px-4 py-2 rounded-xl border border-slate-200 bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-rose-300" />
            <div class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400">${ICONS.Search}</div>
          </div>

          <div class="flex items-center gap-2 bg-white border border-slate-200 rounded-xl px-4 py-2 shadow-sm">
            <span class="text-sm font-bold text-slate-700">Quiz Mode</span>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" class="sr-only toggle-checkbox" ${isQuizMode ? 'checked' : ''} onchange="toggleQuizMode()">
              <div class="toggle-bg w-11 h-6 bg-slate-200 rounded-full"></div>
              <div class="toggle-dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition-transform"></div>
            </label>
          </div>

          <button onclick="goToMenu()" class="px-4 py-2 rounded-xl border border-slate-200 bg-white shadow-sm font-bold text-slate-700 hover:bg-slate-50">Back</button>
        </div>
      </div>

      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
        ${filtered.map(({ img, idx }) => `
          <button onclick="openImageByIndex(${idx})" class="group bg-white rounded-2xl overflow-hidden border border-slate-200 shadow-sm hover:shadow-md transition-all text-left">
            <div class="aspect-square bg-slate-100 overflow-hidden">
              <img src="${escapeHtml(img.src)}" alt="${escapeHtml(img.title)}" class="w-full h-full object-cover group-hover:scale-105 transition-transform"/>
            </div>
            <div class="p-3">
              <div class="font-bold text-slate-800 text-sm leading-tight ${isQuizMode ? 'blur-sm select-none' : ''}">${escapeHtml(img.title)}</div>
              <div class="text-xs text-slate-500 mt-1 ${isQuizMode ? 'blur-sm select-none' : ''}">${escapeHtml(img.desc)}</div>
            </div>
          </button>
        `).join('')}
      </div>
    </div>
  `;

  restoreImageSearchFocus();
}

// ===== MORPHOLOGY MATCHING (IMAGES) =====
function startMorphMatch() {
  stopQuizTimer();
  gameState = 'morphmatch';
  score = 0;
  mistakes = 0;
  morphPairs = MORPH_MATCH_DATA.map(item => ({ ...item }));
  morphMatched = new Set();
  morphSelectedTerm = null;
  morphSelectedImage = null;
  morphWrongPair = null;
  morphTermOrder = [...morphPairs].sort((a, b) => String(a.label || '').localeCompare(String(b.label || ''), undefined, { sensitivity: 'base' }));
  morphImageOrder = shuffleArray([...morphPairs]);
  updateUI();
}

function morphHandleTermClick(id) {
  if (morphMatched.has(id) || morphWrongPair) return;
  morphSelectedTerm = (morphSelectedTerm === id) ? null : id;
  if (!morphCheckMatch()) renderMorphMatch();
}

function morphHandleImageClick(id) {
  if (morphMatched.has(id) || morphWrongPair) return;
  morphSelectedImage = (morphSelectedImage === id) ? null : id;
  if (!morphCheckMatch()) renderMorphMatch();
}

function morphCheckMatch() {
  if (!morphSelectedTerm || !morphSelectedImage) return false;
  const termId = morphSelectedTerm;
  const imageId = morphSelectedImage;

  if (termId === imageId) {
    morphMatched.add(termId);
    score += 100;
    checkAchievements();
    morphSelectedTerm = null;
    morphSelectedImage = null;
    updateStats();
    renderMorphMatch();
    return true;
  }

  morphWrongPair = { term: termId, image: imageId };
  mistakes += 1;
  updateStats();
  renderMorphMatch();
  setTimeout(() => {
    morphSelectedTerm = null;
    morphSelectedImage = null;
    morphWrongPair = null;
    renderMorphMatch();
  }, 1000);
  return true;
}

function renderMorphMatch() {
  mainContent.className = 'w-full flex-grow relative overflow-y-auto bg-gradient-to-br from-slate-50 to-amber-50 px-4 py-8';

  if (!morphPairs.length) {
    mainContent.innerHTML = `
      <div class="max-w-3xl mx-auto animate-fadeIn">
        <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-8 text-center">
          <h2 class="text-3xl font-extrabold text-slate-900 mb-2">Morphology Matching (Images)</h2>
          <div class="text-slate-600 mb-6">No morphology images found.</div>
          <button onclick="goToMenu()" class="px-5 py-3 rounded-xl border border-slate-200 bg-white font-bold text-slate-700 hover:bg-slate-50">Back</button>
        </div>
      </div>
    `;
    updateStats();
    return;
  }

  const terms = morphTermOrder.length ? morphTermOrder : morphPairs;
  const images = morphImageOrder.length ? morphImageOrder : morphPairs;

  if (morphMatched.size === morphPairs.length) {
    showAchievement('‚úÖ', 'Morphology Matched!', 'All images matched correctly.', 'morph_match_complete');
    mainContent.innerHTML = `
      <div class="max-w-3xl mx-auto animate-popIn">
        <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-8 text-center">
          <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-emerald-100 text-emerald-700 mb-4">
            ${ICONS.CheckCircle}
          </div>
          <h2 class="text-3xl font-extrabold text-slate-900 mb-2">Completed</h2>
          <div class="text-slate-600 mb-6">Morphology Matching (Images)</div>

          <div class="grid grid-cols-2 gap-3 max-w-sm mx-auto mb-6">
            <div class="p-4 rounded-xl bg-slate-50 border border-slate-200">
              <div class="text-xs font-bold text-slate-500 uppercase">Score</div>
              <div class="text-2xl font-extrabold text-blue-600">${score}</div>
            </div>
            <div class="p-4 rounded-xl bg-slate-50 border border-slate-200">
              <div class="text-xs font-bold text-slate-500 uppercase">Mistakes</div>
              <div class="text-2xl font-extrabold ${mistakes === 0 ? 'text-emerald-600' : 'text-rose-600'}">${mistakes}</div>
            </div>
          </div>

          <div class="flex flex-col sm:flex-row gap-3 justify-center">
            <button onclick="startMorphMatch()" class="px-5 py-3 rounded-xl bg-slate-900 text-white font-bold hover:bg-slate-800">Replay</button>
            <button onclick="goToMenu()" class="px-5 py-3 rounded-xl border border-slate-200 bg-white font-bold text-slate-700 hover:bg-slate-50">Back to menu</button>
          </div>
        </div>
      </div>
    `;
    updateStats();
    return;
  }

  mainContent.innerHTML = `
    <div class="max-w-7xl mx-auto animate-fadeIn">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
        <div>
          <h2 class="text-3xl font-extrabold text-slate-900">Morphology Matching (Images)</h2>
          <div class="text-sm text-slate-600 mt-1">Click a morphology term, then click the matching image. Use the magnifier to zoom.</div>
        </div>
        <div class="flex gap-3">
          <button onclick="startMorphMatch()" class="px-4 py-2 rounded-xl bg-slate-900 text-white font-bold hover:bg-slate-800">Restart</button>
          <button onclick="goToMenu()" class="px-4 py-2 rounded-xl border border-slate-200 bg-white shadow-sm font-bold text-slate-700 hover:bg-slate-50">Back</button>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-5 lg:col-span-1">
          <h3 class="font-extrabold text-slate-900 mb-4">Morphology Terms</h3>
          <div class="space-y-3">
            ${terms.map(term => {
              const isMatched = morphMatched.has(term.id);
              const isSelected = morphSelectedTerm === term.id;
              const isError = morphWrongPair?.term === term.id;
              const fadeStyle = isMatched ? ' style="opacity:0.05;"' : '';

              let btnClass = "w-full text-left p-3 rounded-xl border-2 transition-all min-h-[3.25rem]";
              let textClass = "font-bold text-sm sm:text-base";

              if (isMatched) {
                btnClass += " bg-slate-50 border-slate-100 text-slate-300 cursor-default";
                textClass += " line-through";
              } else if (isError) {
                btnClass += " bg-red-50 border-red-500 animate-shake";
                textClass += " text-slate-800";
              } else if (isSelected) {
                btnClass += " bg-blue-50 border-blue-500 shadow-md";
                textClass += " text-slate-800";
              } else {
                btnClass += " bg-white border-slate-200 hover:border-blue-300 hover:shadow-sm";
                textClass += " text-slate-800";
              }

              return `
                <button onclick="morphHandleTermClick('${escapeJs(term.id)}')" ${isMatched ? 'disabled' : ''} class="${btnClass}"${fadeStyle}>
                  <span class="${textClass}">${escapeHtml(term.label)}</span>
                </button>
              `;
            }).join('')}
          </div>
        </div>

        <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-5 lg:col-span-2">
          <h3 class="font-extrabold text-slate-900 mb-4">Images</h3>
          <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-4">
            ${images.map(img => {
              const placed = morphMatched.has(img.id) ? img.label : null;
              const isMatched = morphMatched.has(img.id);
              const isSelected = morphSelectedImage === img.id;
              const isError = morphWrongPair?.image === img.id;
              const fadeStyle = isMatched ? ' style="opacity:0.05;"' : '';

              let cardClass = "w-full text-left rounded-2xl border-2 transition-all overflow-hidden";
              if (isMatched) {
                cardClass += " bg-slate-50 border-slate-100 cursor-default";
              } else if (isError) {
                cardClass += " bg-red-50 border-red-500 animate-shake";
              } else if (isSelected) {
                cardClass += " bg-blue-50 border-blue-500 shadow-md";
              } else {
                cardClass += " bg-white border-slate-200 hover:border-blue-300 hover:shadow-sm";
              }

              return `
                <div class="relative"${fadeStyle}>
                  <button onclick="morphHandleImageClick('${escapeJs(img.id)}')" ${isMatched ? 'disabled' : ''} class="${cardClass}">
                    <div class="aspect-square bg-slate-100 overflow-hidden">
                      <img src="${escapeHtml(img.src)}" alt="Morphology image" class="w-full h-full object-cover" />
                    </div>
                    <div class="p-3 min-h-[52px]">
                      ${placed ? `<div class="placed-item">${escapeHtml(placed)}</div>` : `
                        <div class="text-xs font-bold ${isSelected ? 'text-blue-600' : 'text-slate-400'}">
                          ${isSelected ? 'Selected' : 'Click to match'}
                        </div>
                      `}
                    </div>
                  </button>
                  <button type="button" onclick="event.stopPropagation(); openImageModal('${escapeJs(img.src)}', 'Morphology Image', 'Zoomed view for closer inspection.');" class="absolute bottom-2 right-2 z-10 w-9 h-9 rounded-full bg-white/90 border border-slate-200 shadow-sm flex items-center justify-center text-slate-700 hover:bg-white" title="Magnify image" aria-label="Magnify image">
                    ${ICONS.Search}
                  </button>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      </div>
    </div>
  `;

  updateStats();
}


// ===== MECHANISM SORTERS =====
function startMechanismMenu() {
  stopQuizTimer();
  gameState = 'mechanism';
  score = 0;
  mistakes = 0;
  mechSelectedGame = null;
  mechPairs = [];
  mechMatched = new Set();
  updateUI();
}

function startMechanismGame(gameKey) {
  stopQuizTimer();
  const g = MECHANISM_GAMES[gameKey];
  if (!g) return;
  gameState = 'mechanism';
  score = 0;
  mistakes = 0;
  mechSelectedGame = gameKey;
  mechPairs = (g.pairs || []).map(p => ({ ...p }));
  mechMatched = new Set();
  shuffleArray(mechPairs);
  updateUI();
}

function mechHandleDragStart(ev) {
  const el = ev.currentTarget;
  const id = el.dataset.pairId;
  if (!id) return;
  ev.dataTransfer.setData('text/plain', id);
  ev.dataTransfer.effectAllowed = 'move';
  el.classList.add('dragging');
}

function mechHandleDragEnd(ev) {
  ev.currentTarget.classList.remove('dragging');
}

function mechHandleDragOver(ev) {
  ev.preventDefault();
  ev.currentTarget.classList.add('drag-over');
  ev.dataTransfer.dropEffect = 'move';
}

function mechHandleDragLeave(ev) {
  ev.currentTarget.classList.remove('drag-over');
}

function mechHandleDrop(ev) {
  ev.preventDefault();
  const zone = ev.currentTarget;
  zone.classList.remove('drag-over');

  const expectedId = zone.dataset.pairId;
  const draggedId = ev.dataTransfer.getData('text/plain');

  if (!expectedId || !draggedId) return;
  if (mechMatched.has(expectedId)) return;

  if (draggedId === expectedId) {
    mechMatched.add(expectedId);
    score += 120; // slightly higher for mechanisms
    checkAchievements();
    updateStats();
    renderMechanism();
  } else {
    mistakes += 1;
    updateStats();
    zone.classList.add('animate-shake');
    setTimeout(() => zone.classList.remove('animate-shake'), 450);
  }
}

function renderMechanism() {
  mainContent.className = 'w-full flex-grow relative overflow-y-auto bg-gradient-to-br from-slate-50 to-emerald-50 px-4 py-8';

  if (!mechSelectedGame) {
    const cards = Object.values(MECHANISM_GAMES);
    mainContent.innerHTML = `
      <div class="max-w-6xl mx-auto animate-fadeIn">
        <div class="flex items-center justify-between gap-4 mb-6">
          <div>
            <h2 class="text-3xl font-extrabold text-slate-900">Mechanism Sorters</h2>
            <div class="text-sm text-slate-600 mt-1">Drag each item onto the correct mechanism/target.</div>
          </div>
          <button onclick="goToMenu()" class="px-4 py-2 rounded-xl border border-slate-200 bg-white shadow-sm font-bold text-slate-700 hover:bg-slate-50">Back</button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
          ${cards.map(g => `
            <button onclick="startMechanismGame('${escapeJs(g.id)}')" class="p-5 bg-white rounded-2xl border border-slate-200 shadow-sm hover:shadow-md transition-all text-left group">
              <div class="p-3 rounded-xl bg-gradient-to-br ${g.color} text-white w-fit mb-3 group-hover:scale-110 transition-transform">${g.icon}</div>
              <div class="font-extrabold text-slate-900">${escapeHtml(g.title)}</div>
              <div class="text-sm text-slate-600 mt-1">${escapeHtml(g.subtitle || '')}</div>
              <div class="text-xs font-bold text-slate-500 mt-3">${(g.pairs || []).length} pairs</div>
            </button>
          `).join('')}
        </div>
      </div>
    `;
    updateStats();
    return;
  }

  const g = MECHANISM_GAMES[mechSelectedGame];
  const items = mechPairs.filter(p => !mechMatched.has(p.id)).map(p => ({ id: p.id, text: p.item }));
  const zones = mechPairs.map(p => ({ id: p.id, text: p.match }));

  shuffleArray(items);
  shuffleArray(zones);

  if (mechMatched.size === mechPairs.length && mechPairs.length > 0) {
    showAchievement('üß†', 'Mechanism Master!', `${g.title} completed.`, `mech_${mechSelectedGame}_complete`);

    mainContent.innerHTML = `
      <div class="max-w-3xl mx-auto animate-popIn">
        <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-8 text-center">
          <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-emerald-100 text-emerald-700 mb-4">
            ${ICONS.Brain}
          </div>
          <h2 class="text-3xl font-extrabold text-slate-900 mb-2">Completed</h2>
          <div class="text-slate-600 mb-6">${escapeHtml(g.title)}</div>

          <div class="grid grid-cols-2 gap-3 max-w-sm mx-auto mb-6">
            <div class="p-4 rounded-xl bg-slate-50 border border-slate-200">
              <div class="text-xs font-bold text-slate-500 uppercase">Score</div>
              <div class="text-2xl font-extrabold text-blue-600">${score}</div>
            </div>
            <div class="p-4 rounded-xl bg-slate-50 border border-slate-200">
              <div class="text-xs font-bold text-slate-500 uppercase">Mistakes</div>
              <div class="text-2xl font-extrabold ${mistakes === 0 ? 'text-emerald-600' : 'text-rose-600'}">${mistakes}</div>
            </div>
          </div>

          <div class="flex flex-col sm:flex-row gap-3 justify-center">
            <button onclick="startMechanismGame('${escapeJs(mechSelectedGame)}')" class="px-5 py-3 rounded-xl bg-slate-900 text-white font-bold hover:bg-slate-800">Replay</button>
            <button onclick="startMechanismMenu()" class="px-5 py-3 rounded-xl border border-slate-200 bg-white font-bold text-slate-700 hover:bg-slate-50">Choose another</button>
          </div>
        </div>
      </div>
    `;
    updateStats();
    return;
  }

  mainContent.innerHTML = `
    <div class="max-w-7xl mx-auto animate-fadeIn">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
        <div>
          <h2 class="text-3xl font-extrabold text-slate-900">${escapeHtml(g.title)}</h2>
          <div class="text-sm text-slate-600 mt-1">${escapeHtml(g.subtitle || '')}</div>
        </div>
        <div class="flex gap-3">
          <button onclick="startMechanismGame('${escapeJs(mechSelectedGame)}')" class="px-4 py-2 rounded-xl bg-slate-900 text-white font-bold hover:bg-slate-800">Restart</button>
          <button onclick="startMechanismMenu()" class="px-4 py-2 rounded-xl border border-slate-200 bg-white shadow-sm font-bold text-slate-700 hover:bg-slate-50">Back</button>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-5">
          <h3 class="font-extrabold text-slate-900 mb-4">Items</h3>
          <div class="space-y-3">
            ${items.length ? items.map(it => `
              <div class="draggable-item" draggable="true" data-pair-id="${escapeHtml(it.id)}"
                   ondragstart="mechHandleDragStart(event)" ondragend="mechHandleDragEnd(event)">
                ${escapeHtml(it.text)}
              </div>
            `).join('') : `<div class="text-slate-500 text-sm">All items placed.</div>`}
          </div>
        </div>

        <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-5">
          <h3 class="font-extrabold text-slate-900 mb-4">Targets</h3>
          <div class="space-y-3">
            ${zones.map(z => {
              const placed = mechMatched.has(z.id) ? mechPairs.find(p => p.id === z.id)?.item : null;
              return `
                <div class="drop-zone" data-pair-id="${escapeHtml(z.id)}"
                     ondragover="mechHandleDragOver(event)" ondragleave="mechHandleDragLeave(event)" ondrop="mechHandleDrop(event)">
                  <div class="text-sm font-bold text-slate-700 mb-2">${escapeHtml(z.text)}</div>
                  <div class="min-h-[42px]">
                    ${placed ? `<div class="placed-item">${escapeHtml(placed)}</div>` : `<div class="text-xs text-slate-400">Drop item here</div>`}
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      </div>
    </div>
  `;

  updateStats();
}



// ===== QUIZ CENTER =====
function startQuizCenter() {
  stopQuizTimer();
  gameState = 'quiz';
  // Reset to setup mode but preserve last chosen settings
  quizSession.active = false;
  quizSession.score = 0;
  quizSession.mistakes = 0;
  quizSession.correct = 0;
  quizSession.index = 0;
  quizSession.questions = [];
  quizSession.timeLeft = quizSession.timePerQuestion;
  quizSession.allowAnswer = true;
  score = 0;
  mistakes = 0;
  updateUI();
}

function setQuizSetting(key, value) {
  if (key === 'mode') quizSession.mode = value;
  if (key === 'timePerQuestion') quizSession.timePerQuestion = clamp(Number(value) || 60, 10, 300);
  if (key === 'questionCount') quizSession.questionCount = clamp(Number(value) || 5, 1, 50);
  if (key === 'fixedDifficulty') quizSession.fixedDifficulty = clamp(Number(value) || 2, 1, 3);
  if (key === 'adaptiveDifficulty') quizSession.adaptiveDifficulty = clamp(Number(value) || 2, 1, 3);
  renderQuiz();
}

function startQuiz() {
  stopQuizTimer();

  quizSession.active = true;
  quizSession.score = 0;
  quizSession.mistakes = 0;
  quizSession.correct = 0;
  quizSession.index = 0;
  quizSession.questions = [];
  quizSession.timeLeft = quizSession.timePerQuestion;
  quizSession.allowAnswer = true;
  quizSession.usedIds = new Set();
  quizSession.streak = 0;

  // Build initial question list based on mode
  if (quizSession.mode === 'fixed') {
    const d = quizSession.fixedDifficulty;
    let pool = QUIZ_BANK.filter(q => q.difficulty === d);
    if (pool.length < quizSession.questionCount) {
      pool = QUIZ_BANK.filter(q => Math.abs(q.difficulty - d) <= 1);
    }
    quizSession.questions = pickRandom(pool, Math.min(quizSession.questionCount, pool.length));
  } else {
    // adaptive: add the first question; subsequent questions appended after each answer
    const q = pickAdaptiveQuestion(quizSession.adaptiveDifficulty, quizSession.usedIds);
    if (q) {
      quizSession.questions = [q];
      quizSession.usedIds.add(q.id);
    } else {
      quizSession.questions = pickRandom(QUIZ_BANK, Math.min(quizSession.questionCount, QUIZ_BANK.length));
    }
  }

  score = 0;
  mistakes = 0;
  updateUI();
  startQuizTimer();
}

function endQuizEarly() {
  if (!quizSession.active) return;
  const ok = confirm('End the quiz early?');
  if (!ok) return;
  endQuiz();
}

function pickAdaptiveQuestion(difficulty, usedIds) {
  const d = clamp(Number(difficulty) || 2, 1, 3);
  const pool = QUIZ_BANK.filter(q => Math.abs(q.difficulty - d) <= 1 && !(usedIds && usedIds.has(q.id)));
  if (!pool.length) return null;
  return pool[Math.floor(Math.random() * pool.length)];
}

function startQuizTimer() {
  stopQuizTimer();
  quizSession.timeLeft = quizSession.timePerQuestion;
  updateQuizTimerUI();

  quizSession.timerId = setInterval(() => {
    quizSession.timeLeft -= 1;
    updateQuizTimerUI();
    if (quizSession.timeLeft <= 0) {
      // time out = incorrect
      stopQuizTimer();
      handleQuizAnswer(-1, true);
    }
  }, 1000);
}

function stopQuizTimer() {
  if (quizSession && quizSession.timerId) {
    clearInterval(quizSession.timerId);
    quizSession.timerId = null;
  }
  if (quizTimerEl) quizTimerEl.classList.remove('timer-warning');
}

function updateQuizTimerUI() {
  if (!timerDisplay) return;
  const t = Math.max(0, quizSession.timeLeft || 0);
  timerDisplay.textContent = String(t);

  if (quizTimerEl) {
    if (t <= 10 && quizSession.active) quizTimerEl.classList.add('timer-warning');
    else quizTimerEl.classList.remove('timer-warning');
  }
}

function renderQuiz() {
  mainContent.className = 'w-full flex-grow relative overflow-y-auto bg-gradient-to-br from-slate-50 to-yellow-50 px-4 py-8';

  if (!quizSession.active) {
    const boardHtml = renderLeaderboardPreview(10);
    mainContent.innerHTML = `
      <div class="max-w-6xl mx-auto animate-fadeIn">
        <div class="flex items-center justify-between gap-4 mb-6">
          <div>
            <h2 class="text-3xl font-extrabold text-slate-900">Quiz Center</h2>
            <div class="text-sm text-slate-600 mt-1">Fixed difficulty quizzes (with explanations) and adaptive quizzes (difficulty adjusts).</div>
          </div>
          <button onclick="goToMenu()" class="px-4 py-2 rounded-xl border border-slate-200 bg-white shadow-sm font-bold text-slate-700 hover:bg-slate-50">Back</button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6">
            <h3 class="text-xl font-extrabold text-slate-900 mb-4">Settings</h3>

            <div class="space-y-4">
              <div>
                <div class="text-sm font-bold text-slate-700 mb-2">Mode</div>
                <div class="grid grid-cols-2 gap-3">
                  <button onclick="setQuizSetting('mode','fixed')" class="px-4 py-3 rounded-xl font-bold border ${quizSession.mode === 'fixed' ? 'bg-slate-900 text-white border-slate-900' : 'bg-white text-slate-700 border-slate-200 hover:bg-slate-50'}">
                    Fixed (Explain)
                  </button>
                  <button onclick="setQuizSetting('mode','adaptive')" class="px-4 py-3 rounded-xl font-bold border ${quizSession.mode === 'adaptive' ? 'bg-slate-900 text-white border-slate-900' : 'bg-white text-slate-700 border-slate-200 hover:bg-slate-50'}">
                    Adaptive
                  </button>
                </div>
              </div>

              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <div class="text-sm font-bold text-slate-700 mb-2">Difficulty</div>
                  <select onchange="setQuizSetting('${quizSession.mode === 'fixed' ? 'fixedDifficulty' : 'adaptiveDifficulty'}', this.value)" class="w-full px-4 py-2 rounded-xl border border-slate-200 bg-white shadow-sm font-bold text-slate-700">
                    <option value="1" ${(quizSession.mode === 'fixed' ? quizSession.fixedDifficulty : quizSession.adaptiveDifficulty) === 1 ? 'selected' : ''}>Easy</option>
                    <option value="2" ${(quizSession.mode === 'fixed' ? quizSession.fixedDifficulty : quizSession.adaptiveDifficulty) === 2 ? 'selected' : ''}>Medium</option>
                    <option value="3" ${(quizSession.mode === 'fixed' ? quizSession.fixedDifficulty : quizSession.adaptiveDifficulty) === 3 ? 'selected' : ''}>Hard</option>
                  </select>
                </div>

                <div>
                  <div class="text-sm font-bold text-slate-700 mb-2">Time / question</div>
                  <select onchange="setQuizSetting('timePerQuestion', this.value)" class="w-full px-4 py-2 rounded-xl border border-slate-200 bg-white shadow-sm font-bold text-slate-700">
                    <option value="30" ${quizSession.timePerQuestion === 30 ? 'selected' : ''}>30s</option>
                    <option value="45" ${quizSession.timePerQuestion === 45 ? 'selected' : ''}>45s</option>
                    <option value="60" ${quizSession.timePerQuestion === 60 ? 'selected' : ''}>60s</option>
                    <option value="90" ${quizSession.timePerQuestion === 90 ? 'selected' : ''}>90s</option>
                  </select>
                </div>
              </div>

              <div>
                <div class="text-sm font-bold text-slate-700 mb-2">Question count</div>
                <select onchange="setQuizSetting('questionCount', this.value)" class="w-full px-4 py-2 rounded-xl border border-slate-200 bg-white shadow-sm font-bold text-slate-700">
                  <option value="5" ${quizSession.questionCount === 5 ? 'selected' : ''}>5</option>
                  <option value="10" ${quizSession.questionCount === 10 ? 'selected' : ''}>10</option>
                  <option value="15" ${quizSession.questionCount === 15 ? 'selected' : ''}>15</option>
                </select>
              </div>

              <button onclick="startQuiz()" class="w-full mt-2 px-4 py-3 rounded-xl bg-slate-900 text-white font-extrabold hover:bg-slate-800">
                Start Quiz
              </button>

              <div class="text-xs text-slate-500">
                Notes: Adaptive mode selects questions near your current difficulty. Fixed mode shows explanations after each question.
              </div>
            </div>
          </div>

          <div class="space-y-6">
            ${boardHtml}
            <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6">
              <div class="flex items-center gap-2 font-extrabold text-slate-900 mb-2">${ICONS.Sparkles} Badge tiers</div>
              <div class="text-sm text-slate-600">Bronze ‚â• 150, Silver ‚â• 350, Gold ‚â• 600 (quiz score).</div>
            </div>
          </div>
        </div>
      </div>
    `;

    score = 0;
    mistakes = 0;
    updateStats();
    updateQuizTimerUI();
    return;
  }

  // Ensure adaptive mode has enough questions loaded for current index
  if (quizSession.mode === 'adaptive' && quizSession.questions.length < quizSession.questionCount) {
    while (quizSession.questions.length <= quizSession.index && quizSession.questions.length < quizSession.questionCount) {
      const next = pickAdaptiveQuestion(quizSession.adaptiveDifficulty, quizSession.usedIds);
      if (!next) break;
      quizSession.questions.push(next);
      quizSession.usedIds.add(next.id);
    }
  }

  const current = quizSession.questions[quizSession.index];
  if (!current) {
    endQuiz();
    return;
  }

  const diffLabel = current.difficulty === 1 ? 'Easy' : current.difficulty === 2 ? 'Medium' : 'Hard';
  const diffColor = current.difficulty === 1 ? 'text-emerald-700' : current.difficulty === 2 ? 'text-amber-700' : 'text-rose-700';

  mainContent.innerHTML = `
    <div class="max-w-3xl mx-auto animate-fadeIn">
      <div class="flex items-center justify-between gap-3 mb-4">
        <div class="flex items-center gap-2 text-sm font-bold ${diffColor}">
          ${ICONS.Zap} ${diffLabel} ‚Ä¢ ${quizSession.mode === 'adaptive' ? 'Adaptive' : 'Fixed'}
        </div>
        <div class="flex gap-2">
          <button onclick="endQuizEarly()" class="px-4 py-2 rounded-xl border border-slate-200 bg-white shadow-sm font-bold text-slate-700 hover:bg-slate-50">End</button>
          <button onclick="goToMenu()" class="px-4 py-2 rounded-xl border border-slate-200 bg-white shadow-sm font-bold text-slate-700 hover:bg-slate-50">Menu</button>
        </div>
      </div>

      <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6">
        <div class="text-sm font-bold text-slate-500 mb-2">Question ${quizSession.index + 1} of ${quizSession.questionCount}</div>
        <h3 class="text-xl font-extrabold text-slate-900 mb-6">${escapeHtml(current.question)}</h3>

        <div class="space-y-3">
          ${current.choices.map((c, i) => `
            <button onclick="handleQuizAnswer(${i})" class="w-full text-left p-4 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 font-semibold text-slate-800 transition-all">
              ${escapeHtml(c)}
            </button>
          `).join('')}
        </div>
      </div>
    </div>
  `;

  // Update shared header stats
  score = quizSession.score;
  mistakes = quizSession.mistakes;
  updateStats();
}

function handleQuizAnswer(choiceIndex, timedOut = false) {
  if (!quizSession.active) return;
  if (!quizSession.allowAnswer && !timedOut) return;

  quizSession.allowAnswer = false;
  stopQuizTimer();

  const current = quizSession.questions[quizSession.index];
  if (!current) return;

  const correctIndex = current.answerIndex;
  const isCorrect = (choiceIndex === correctIndex) && !timedOut;

  // scoring
  if (isCorrect) {
    quizSession.correct += 1;
    quizSession.streak = (quizSession.streak || 0) + 1;

    if (quizSession.mode === 'adaptive') {
      quizSession.score += 100 * current.difficulty;
      if (quizSession.streak >= 2) quizSession.adaptiveDifficulty = clamp(quizSession.adaptiveDifficulty + 1, 1, 3);
    } else {
      const pts = current.difficulty === 1 ? 50 : current.difficulty === 2 ? 100 : 150;
      quizSession.score += pts;
    }
  } else {
    quizSession.mistakes += 1;
    quizSession.streak = 0;

    if (quizSession.mode === 'adaptive') {
      quizSession.adaptiveDifficulty = clamp(quizSession.adaptiveDifficulty - 1, 1, 3);
    }
  }

  score = quizSession.score;
  mistakes = quizSession.mistakes;
  updateStats();

  showQuizFeedback(isCorrect, choiceIndex, correctIndex, current, timedOut);
}

function showQuizFeedback(isCorrect, choiceIndex, correctIndex, question, timedOut) {
  const resultIcon = isCorrect ? '‚úÖ' : '‚ùå';
  const title = isCorrect ? 'Correct!' : (timedOut ? 'Time expired' : 'Incorrect');
  const correctText = question.choices[correctIndex] || '';

  const overlay = document.createElement('div');
  overlay.className = 'fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50';
  overlay.innerHTML = `
    <div class="bg-white rounded-2xl max-w-lg w-full p-6 shadow-2xl animate-popIn">
      <div class="flex items-center gap-3 mb-3">
        <div class="text-2xl">${resultIcon}</div>
        <div>
          <div class="text-xl font-extrabold text-slate-900">${title}</div>
          <div class="text-sm text-slate-600">Correct answer: <span class="font-bold">${escapeHtml(correctText)}</span></div>
        </div>
      </div>
      <div class="bg-slate-50 border border-slate-200 rounded-xl p-4 text-sm text-slate-700">
        ${escapeHtml(question.explanation || '')}
      </div>
      <div class="mt-4 flex items-center justify-between">
        <div class="text-xs font-bold text-slate-500">Continuing‚Ä¶</div>
        <button class="px-4 py-2 rounded-xl bg-slate-900 text-white font-bold hover:bg-slate-800">Next</button>
      </div>
    </div>
  `;

  const nextBtn = overlay.querySelector('button');
  nextBtn.addEventListener('click', () => {
    overlay.remove();
    advanceQuiz();
  });

  document.body.appendChild(overlay);

  // auto advance after short delay
  setTimeout(() => {
    if (document.body.contains(overlay)) {
      overlay.remove();
      advanceQuiz();
    }
  }, 2200);
}

function advanceQuiz() {
  if (!quizSession.active) return;

  quizSession.index += 1;

  if (quizSession.index >= quizSession.questionCount) {
    endQuiz();
    return;
  }

  // In fixed mode, we already selected N questions. In adaptive, ensure the next question exists.
  if (quizSession.mode === 'adaptive') {
    if (quizSession.questions.length <= quizSession.index) {
      const next = pickAdaptiveQuestion(quizSession.adaptiveDifficulty, quizSession.usedIds);
      if (next) {
        quizSession.questions.push(next);
        quizSession.usedIds.add(next.id);
      } else {
        // fallback to random unused
        const fallback = QUIZ_BANK.find(q => !quizSession.usedIds.has(q.id));
        if (fallback) {
          quizSession.questions.push(fallback);
          quizSession.usedIds.add(fallback.id);
        }
      }
    }
  }

  quizSession.allowAnswer = true;
  quizSession.timeLeft = quizSession.timePerQuestion;

  renderQuiz();
  startQuizTimer();
}

function endQuiz() {
  stopQuizTimer();
  quizSession.active = false;

  // Sync shared score/mistakes
  score = quizSession.score;
  mistakes = quizSession.mistakes;

  const badges = getBadgesForScore(quizSession.score);
  const badgeHtml = badges.length ? badges.map(b => `<span class="badge-animation inline-flex items-center px-3 py-1 rounded-full text-xs font-extrabold ${b.className}">${b.label}</span>`).join(' ') : `<span class="text-sm text-slate-500">No badge earned.</span>`;

  // Save prompt (legacy behavior preserved)
  const name = prompt('Enter a name for the leaderboard (optional):', '');
  if (name && name.trim()) {
    const diffLabel = (quizSession.mode === 'fixed')
      ? (quizSession.fixedDifficulty === 1 ? 'Easy' : quizSession.fixedDifficulty === 2 ? 'Medium' : 'Hard')
      : (quizSession.adaptiveDifficulty === 1 ? 'Easy' : quizSession.adaptiveDifficulty === 2 ? 'Medium' : 'Hard');

    saveToLeaderboard(name.trim(), quizSession.score, { difficulty: diffLabel, mode: quizSession.mode });
  }

  checkAchievements();

  // Render results
  mainContent.innerHTML = `
    <div class="max-w-3xl mx-auto animate-popIn">
      <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-8 text-center">
        <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-yellow-100 text-yellow-700 mb-4">
          ${ICONS.TrophyBig}
        </div>
        <h2 class="text-3xl font-extrabold text-slate-900 mb-2">Quiz Complete</h2>
        <div class="text-slate-600 mb-6">${quizSession.correct} correct ‚Ä¢ ${quizSession.mistakes} mistakes</div>

        <div class="grid grid-cols-2 gap-3 max-w-sm mx-auto mb-6">
          <div class="p-4 rounded-xl bg-slate-50 border border-slate-200">
            <div class="text-xs font-bold text-slate-500 uppercase">Score</div>
            <div class="text-2xl font-extrabold text-blue-600">${quizSession.score}</div>
          </div>
          <div class="p-4 rounded-xl bg-slate-50 border border-slate-200">
            <div class="text-xs font-bold text-slate-500 uppercase">Badge</div>
            <div class="mt-2">${badgeHtml}</div>
          </div>
        </div>

        <div class="flex flex-col sm:flex-row gap-3 justify-center">
          <button onclick="startQuizCenter()" class="px-5 py-3 rounded-xl bg-slate-900 text-white font-bold hover:bg-slate-800">New Quiz</button>
          <button onclick="goToMenu()" class="px-5 py-3 rounded-xl border border-slate-200 bg-white font-bold text-slate-700 hover:bg-slate-50">Menu</button>
        </div>
      </div>
    </div>
  `;

  updateHeaderControls();
}



// ===== DISEASE INDEX =====
function startDiseaseIndex() {
  stopQuizTimer();
  gameState = 'index';
  score = 0;
  mistakes = 0;
  diState = { query: '', smear: '', type: '', detailIdx: null, highlight: true, focus: null, searchSelection: null };
  updateUI();
}

function setDIQuery(val) {
  const input = document.getElementById('di-search');
  if (input) {
    diState.searchSelection = {
      start: input.selectionStart,
      end: input.selectionEnd
    };
  }
  diState.query = String(val || '');
  diState.detailIdx = null;
  diState.focus = 'search';
  renderDiseaseIndex();
}

function setDISmear(val) {
  diState.smear = String(val || '');
  diState.detailIdx = null;
  diState.focus = null;
  renderDiseaseIndex();
}

function setDIType(val) {
  diState.type = String(val || '');
  diState.detailIdx = null;
  diState.focus = null;
  renderDiseaseIndex();
}

function toggleDIHighlight() {
  diState.highlight = !diState.highlight;
  diState.focus = null;
  renderDiseaseIndex();
}

function openDiseaseDetail(idx) {
  diState.detailIdx = Number(idx);
  diState.focus = null;
  renderDiseaseIndex();
}

function backToDiseaseResults() {
  diState.detailIdx = null;
  diState.focus = null;
  renderDiseaseIndex();
}

function restoreSearchFocus() {
  if (diState.focus !== 'search') return;
  const input = document.getElementById('di-search');
  if (!input) return;
  input.focus();
  const sel = diState.searchSelection;
  if (sel && typeof input.setSelectionRange === 'function') {
    input.setSelectionRange(
      Number.isInteger(sel.start) ? sel.start : input.value.length,
      Number.isInteger(sel.end) ? sel.end : input.value.length
    );
  }
}

function getDiseaseFilters() {
  const smearSet = new Set();
  const typeSet = new Set();
  DISEASE_BANK.forEach(d => {
    (d.smear || []).forEach(s => smearSet.add(s));
    if (d.type) typeSet.add(d.type);
  });
  return {
    smears: [...smearSet].sort(),
    types: [...typeSet].sort()
  };
}

function diseaseMatches(d, query) {
  const q = normalizeQuery(query);
  if (!q) return true;
  const blob = `${d.name} ${d.type} ${d.etiology} ${d.mechanism} ${d.pathophysiology} ${(d.smear||[]).join(' ')} ${(d.presentation||[]).join(' ')} ${(d.labs||[]).join(' ')}`.toLowerCase();
  return blob.includes(q);
}

function renderDiseaseIndex() {
  mainContent.className = 'w-full flex-grow relative overflow-y-auto bg-gradient-to-br from-slate-50 to-cyan-50 px-4 py-8';

  const { smears, types } = getDiseaseFilters();
  const q = normalizeQuery(diState.query);

  const filtered = DISEASE_BANK
    .map((d, idx) => ({ d, idx }))
    .filter(({ d }) => diseaseMatches(d, q))
    .filter(({ d }) => !diState.smear || (d.smear || []).includes(diState.smear))
    .filter(({ d }) => !diState.type || d.type === diState.type);

  // Detail view
  if (diState.detailIdx !== null && DISEASE_BANK[diState.detailIdx]) {
    const d = DISEASE_BANK[diState.detailIdx];

    const nameHtml = diState.highlight ? highlightText(d.name, q) : escapeHtml(d.name);

    const listHtml = (items) => (items && items.length)
      ? `<ul class="list-disc pl-5 space-y-1">${items.map(s => `<li>${diState.highlight ? highlightText(s, q) : escapeHtml(s)}</li>`).join('')}</ul>`
      : `<div class="text-slate-500">‚Äî</div>`;

    const etiologyHtml = d.etiology
      ? (diState.highlight ? highlightText(d.etiology, q) : escapeHtml(d.etiology))
      : '‚Äî';
    const mechanismHtml = d.mechanism
      ? (diState.highlight ? highlightText(d.mechanism, q) : escapeHtml(d.mechanism))
      : '‚Äî';
    const pathHtml = d.pathophysiology
      ? (diState.highlight ? highlightText(d.pathophysiology, q) : escapeHtml(d.pathophysiology))
      : '‚Äî';
    const labsHtml = listHtml(d.labs || []);
    const presentationHtml = listHtml(d.presentation || []);
    const smearHtml = listHtml(d.smear || []);
    const smearImages = (d.smear || [])
      .map(term => ({ term, img: getSmearImage(term) }))
      .filter(entry => entry.img);
    const smearImageHtml = smearImages.length ? `
      <div class="mt-4 grid grid-cols-2 sm:grid-cols-3 gap-3">
        ${smearImages.map(({ term, img }) => `
          <button onclick="openImageModal('${escapeJs(img.src)}', '${escapeJs(img.title || term)}', '${escapeJs(term)}')" class="group bg-white rounded-xl border border-slate-200 overflow-hidden shadow-sm hover:shadow-md text-left">
            <div class="aspect-square bg-slate-100 overflow-hidden">
              <img src="${escapeHtml(img.src)}" alt="${escapeHtml(term)}" class="w-full h-full object-cover group-hover:scale-105 transition-transform" />
            </div>
            <div class="px-3 py-2 text-xs font-bold text-slate-700">${escapeHtml(term)}</div>
          </button>
        `).join('')}
      </div>
    ` : '';

    mainContent.innerHTML = `
      <div class="max-w-4xl mx-auto animate-fadeIn">
        <div class="flex items-center justify-between gap-4 mb-6">
          <button onclick="backToDiseaseResults()" class="px-4 py-2 rounded-xl border border-slate-200 bg-white shadow-sm font-bold text-slate-700 hover:bg-slate-50">‚Üê Back</button>
          <button onclick="goToMenu()" class="px-4 py-2 rounded-xl border border-slate-200 bg-white shadow-sm font-bold text-slate-700 hover:bg-slate-50">Menu</button>
        </div>

        <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-8">
          <div class="flex flex-wrap items-center gap-2 mb-3">
            <div class="text-3xl font-extrabold text-slate-900">${nameHtml}</div>
            ${d.type ? `<div class="px-3 py-1 rounded-full bg-slate-100 text-slate-700 text-xs font-bold">${escapeHtml(d.type)}</div>` : ''}
            <div class="px-3 py-1 rounded-full bg-slate-100 text-slate-500 text-xs font-bold">${escapeHtml(d.source)}</div>
          </div>

          <div class="mt-5 grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div>
              <div class="text-sm font-extrabold text-slate-800 mb-2">Etiology</div>
              <div class="p-4 rounded-xl bg-slate-50 border border-slate-200 text-slate-700">
                ${etiologyHtml}
              </div>
            </div>

            <div>
              <div class="text-sm font-extrabold text-slate-800 mb-2">Mechanism</div>
              <div class="p-4 rounded-xl bg-slate-50 border border-slate-200 text-slate-700">
                ${mechanismHtml}
              </div>
            </div>

            <div>
              <div class="text-sm font-extrabold text-slate-800 mb-2">Pathophysiology</div>
              <div class="p-4 rounded-xl bg-slate-50 border border-slate-200 text-slate-700">
                ${pathHtml}
              </div>
            </div>

            <div>
              <div class="text-sm font-extrabold text-slate-800 mb-2">Clinical presentation</div>
              <div class="p-4 rounded-xl bg-slate-50 border border-slate-200 text-slate-700">
                ${presentationHtml}
              </div>
            </div>

            <div>
              <div class="text-sm font-extrabold text-slate-800 mb-2">Labs</div>
              <div class="p-4 rounded-xl bg-slate-50 border border-slate-200 text-slate-700">
                ${labsHtml}
              </div>
            </div>

            <div>
              <div class="text-sm font-extrabold text-slate-800 mb-2">Peripheral smear / cellular evidence</div>
              <div class="p-4 rounded-xl bg-slate-50 border border-slate-200 text-slate-700">
                ${smearHtml}
                ${smearImageHtml}
              </div>
            </div>
          </div>
        </div>
      </div>
    `;

    updateStats();
    return;
  }

  // Results view
  mainContent.innerHTML = `
    <div class="max-w-7xl mx-auto animate-fadeIn">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
        <div>
          <h2 class="text-3xl font-extrabold text-slate-900">Disease Index</h2>
          <div class="text-sm text-slate-600 mt-1">${filtered.length} / ${DISEASE_BANK.length} results</div>
        </div>
        <div class="flex gap-3">
          <button onclick="goToMenu()" class="px-4 py-2 rounded-xl border border-slate-200 bg-white shadow-sm font-bold text-slate-700 hover:bg-slate-50">Back</button>
        </div>
      </div>

      <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="relative">
            <input id="di-search" value="${escapeHtml(diState.query)}" oninput="setDIQuery(this.value)" placeholder="Search‚Ä¶" class="w-full px-4 py-2 rounded-xl border border-slate-200 bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-cyan-200" />
            <div class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400">${ICONS.Search}</div>
          </div>

          <select onchange="setDISmear(this.value)" class="w-full px-4 py-2 rounded-xl border border-slate-200 bg-white shadow-sm font-bold text-slate-700">
            <option value="">Any smear finding</option>
            ${smears.map(s => `<option value="${escapeHtml(s)}" ${diState.smear === s ? 'selected' : ''}>${escapeHtml(s)}</option>`).join('')}
          </select>

          <select onchange="setDIType(this.value)" class="w-full px-4 py-2 rounded-xl border border-slate-200 bg-white shadow-sm font-bold text-slate-700">
            <option value="">Any type</option>
            ${types.map(t => `<option value="${escapeHtml(t)}" ${diState.type === t ? 'selected' : ''}>${escapeHtml(t)}</option>`).join('')}
          </select>
        </div>

        <div class="mt-4 flex items-center gap-3">
          <label class="inline-flex items-center gap-2 text-sm font-bold text-slate-700 cursor-pointer">
            <input type="checkbox" class="w-4 h-4" ${diState.highlight ? 'checked' : ''} onchange="toggleDIHighlight()">
            Highlight matches
          </label>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
        ${filtered.map(({ d, idx }) => {
          const title = diState.highlight ? highlightText(d.name, q) : escapeHtml(d.name);
          const summary = d.mechanism || d.etiology || d.pathophysiology || '‚Äî';
          const summaryHtml = diState.highlight ? highlightText(summary, q) : escapeHtml(summary);
          const type = d.type ? escapeHtml(d.type) : '';
          return `
            <button onclick="openDiseaseDetail(${idx})" class="p-5 bg-white rounded-2xl border border-slate-200 shadow-sm hover:shadow-md transition-all text-left">
              <div class="flex items-start justify-between gap-3">
                <div class="min-w-0">
                  <div class="text-lg font-extrabold text-slate-900">${title}</div>
                  <div class="text-xs font-bold text-slate-500 mt-1">${type} ${type ? '‚Ä¢' : ''} ${escapeHtml(d.source)}</div>
                </div>
                <div class="text-slate-300">${ICONS.ArrowRight}</div>
              </div>
              <div class="text-sm text-slate-700 mt-3">${summaryHtml}</div>
            </button>
          `;
        }).join('')}
      </div>
    </div>
  `;

  restoreSearchFocus();
  updateStats();
}



// ===== INIT =====
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    if (!imageModal.classList.contains('hidden')) closeImageModal();
    if (!achievementModal.classList.contains('hidden')) closeAchievement();
  }
});

function init() {
  // Ensure defaults
  if (!mainContent) {
    console.error('Main content container not found.');
    return;
  }
  updateUI();
}

document.addEventListener('DOMContentLoaded', init);

  </script>
</body>
</html>
